73c54c9fabaf288ae11ae17aea93db4e
"use strict";
/**
 * Kiro Bridge Communication System
 *
 * Provides bidirectional communication between Bedrock Support Manager and Kiro
 * with hybrid routing awareness, message queuing, and comprehensive error handling.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.kiroBridge = exports.KiroBridge = void 0;
// Simple UUID replacement for testing (no external dependencies)
function uuidv4() {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0;
        const v = c == "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
    });
}
/**
 * Kiro Bridge Communication System
 */
class KiroBridge {
    messageQueue = new Map();
    pendingMessages = new Map();
    messageHandlers = new Map();
    stats;
    config;
    isActive = false;
    processingInterval;
    constructor(config) {
        this.config = {
            maxQueueSize: 1000,
            maxRetries: 3,
            retryDelayMs: 1000,
            timeoutMs: 30000,
            priorityLevels: {
                emergency: 1,
                critical: 2,
                high: 3,
                medium: 4,
                low: 5,
            },
            ...config,
        };
        this.stats = {
            messagesSent: 0,
            messagesReceived: 0,
            messagesDelivered: 0,
            messagesFailed: 0,
            averageLatency: 0,
            queueSize: 0,
            errorRate: 0,
            lastActivity: new Date(),
        };
        this.initializeDefaultHandlers();
    }
    async initialize() {
        this.isActive = true;
        this.processingInterval = setInterval(() => {
            this.processMessageQueue();
        }, 100);
        console.log("[KiroBridge] Communication system initialized");
    }
    async shutdown() {
        this.isActive = false;
        if (this.processingInterval) {
            clearInterval(this.processingInterval);
        }
        await this.processMessageQueue();
        console.log("[KiroBridge] Communication system shutdown");
    }
    async sendDiagnosticRequest(diagnosticType, data, options) {
        const message = {
            id: uuidv4(),
            correlationId: uuidv4(),
            type: "diagnostic_request",
            priority: options?.priority || "medium",
            timestamp: new Date(),
            source: "bedrock",
            destination: "kiro",
            routingPath: options?.routingPath || "hybrid",
            payload: { diagnosticType, data },
            metadata: {
                retryCount: 0,
                maxRetries: this.config.maxRetries,
                timeout: this.config.timeoutMs,
                expiresAt: new Date(Date.now() + this.config.timeoutMs),
            },
        };
        await this.queueMessage(message);
        return message.correlationId;
    }
    async sendExecutionData(executionId, operation, status, data) {
        const message = {
            id: uuidv4(),
            correlationId: uuidv4(),
            type: "execution_data",
            priority: "medium",
            timestamp: new Date(),
            source: "bedrock",
            destination: "kiro",
            routingPath: "hybrid",
            payload: { executionId, operation, status, ...data },
            metadata: {
                retryCount: 0,
                maxRetries: this.config.maxRetries,
                timeout: this.config.timeoutMs,
                expiresAt: new Date(Date.now() + this.config.timeoutMs),
            },
        };
        await this.queueMessage(message);
        return message.correlationId;
    }
    registerMessageHandler(messageType, handler) {
        this.messageHandlers.set(messageType, handler);
    }
    async receiveMessage(message) {
        try {
            this.stats.messagesReceived++;
            this.stats.lastActivity = new Date();
            const handler = this.messageHandlers.get(message.type);
            if (handler) {
                await handler(message);
                this.stats.messagesDelivered++;
            }
        }
        catch (error) {
            console.error(`[KiroBridge] Error processing message:`, error);
            this.stats.messagesFailed++;
        }
    }
    getStats() {
        this.stats.queueSize = this.messageQueue.size;
        this.stats.errorRate =
            this.stats.messagesFailed / Math.max(this.stats.messagesSent, 1);
        return { ...this.stats };
    }
    initializeDefaultHandlers() {
        this.registerMessageHandler("diagnostic_response", async (message) => {
            console.log(`[KiroBridge] Received diagnostic response: ${message.correlationId}`);
        });
        this.registerMessageHandler("execution_feedback", async (message) => {
            console.log(`[KiroBridge] Received execution feedback: ${message.correlationId}`);
        });
    }
    async queueMessage(message) {
        if (this.messageQueue.size >= this.config.maxQueueSize) {
            throw new Error("Message queue is full");
        }
        this.messageQueue.set(message.id, message);
        this.stats.messagesSent++;
        this.stats.lastActivity = new Date();
    }
    async processMessageQueue() {
        if (!this.isActive || this.messageQueue.size === 0) {
            return;
        }
        const messages = Array.from(this.messageQueue.values()).sort((a, b) => this.config.priorityLevels[a.priority] -
            this.config.priorityLevels[b.priority]);
        for (const message of messages.slice(0, 10)) {
            try {
                await this.transmitMessage(message);
                this.messageQueue.delete(message.id);
            }
            catch (error) {
                console.error(`[KiroBridge] Failed to transmit message:`, error);
            }
        }
    }
    async transmitMessage(message) {
        console.log(`[KiroBridge] Transmitting message: ${message.id} via ${message.routingPath}`);
        await new Promise((resolve) => setTimeout(resolve, Math.random() * 100));
    }
}
exports.KiroBridge = KiroBridge;
// Default instance export
exports.kiroBridge = new KiroBridge();
// The class is already exported above, no need to re-export
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hdGJha2gtdmlzaWJpbGl0eS1ib29zdC4yMDI1MDkyMC9zcmMvbGliL2FpLW9yY2hlc3RyYXRvci9raXJvLWJyaWRnZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7O0dBS0c7OztBQUVILGlFQUFpRTtBQUNqRSxTQUFTLE1BQU07SUFDYixPQUFPLHNDQUFzQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDO1FBQ3hFLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNuQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUN6QyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBa0VEOztHQUVHO0FBQ0gsTUFBYSxVQUFVO0lBQ2IsWUFBWSxHQUFtQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3pELGVBQWUsR0FBbUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUM1RCxlQUFlLEdBR25CLElBQUksR0FBRyxFQUFFLENBQUM7SUFDTixLQUFLLENBQXFCO0lBQzFCLE1BQU0sQ0FBcUI7SUFDM0IsUUFBUSxHQUFZLEtBQUssQ0FBQztJQUMxQixrQkFBa0IsQ0FBa0I7SUFFNUMsWUFBWSxNQUFvQztRQUM5QyxJQUFJLENBQUMsTUFBTSxHQUFHO1lBQ1osWUFBWSxFQUFFLElBQUk7WUFDbEIsVUFBVSxFQUFFLENBQUM7WUFDYixZQUFZLEVBQUUsSUFBSTtZQUNsQixTQUFTLEVBQUUsS0FBSztZQUNoQixjQUFjLEVBQUU7Z0JBQ2QsU0FBUyxFQUFFLENBQUM7Z0JBQ1osUUFBUSxFQUFFLENBQUM7Z0JBQ1gsSUFBSSxFQUFFLENBQUM7Z0JBQ1AsTUFBTSxFQUFFLENB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QUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNFLENBQUM7Q0FDRjtBQTFNRCxnQ0EwTUM7QUFFRCwwQkFBMEI7QUFDYixRQUFBLFVBQVUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0FBRTNDLDREQUE0RCIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWF0YmFraC12aXNpYmlsaXR5LWJvb3N0LjIwMjUwOTIwL3NyYy9saWIvYWktb3JjaGVzdHJhdG9yL2tpcm8tYnJpZGdlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogS2lybyBCcmlkZ2UgQ29tbXVuaWNhdGlvbiBTeXN0ZW1cbiAqXG4gKiBQcm92aWRlcyBiaWRpcmVjdGlvbmFsIGNvbW11bmljYXRpb24gYmV0d2VlbiBCZWRyb2NrIFN1cHBvcnQgTWFuYWdlciBhbmQgS2lyb1xuICogd2l0aCBoeWJyaWQgcm91dGluZyBhd2FyZW5lc3MsIG1lc3NhZ2UgcXVldWluZywgYW5kIGNvbXByZWhlbnNpdmUgZXJyb3IgaGFuZGxpbmcuXG4gKi9cblxuLy8gU2ltcGxlIFVVSUQgcmVwbGFjZW1lbnQgZm9yIHRlc3RpbmcgKG5vIGV4dGVybmFsIGRlcGVuZGVuY2llcylcbmZ1bmN0aW9uIHV1aWR2NCgpOiBzdHJpbmcge1xuICByZXR1cm4gXCJ4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHhcIi5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uIChjKSB7XG4gICAgY29uc3QgciA9IChNYXRoLnJhbmRvbSgpICogMTYpIHwgMDtcbiAgICBjb25zdCB2ID0gYyA9PSBcInhcIiA/IHIgOiAociAmIDB4MykgfCAweDg7XG4gICAgcmV0dXJuIHYudG9TdHJpbmcoMTYpO1xuICB9KTtcbn1cblxuZXhwb3J0IHR5cGUgS2lyb0JyaWRnZU1lc3NhZ2VUeXBlID1cbiAgfCBcImRpYWdub3N0aWNfcmVxdWVzdFwiXG4gIHwgXCJkaWFnbm9zdGljX3Jlc3BvbnNlXCJcbiAgfCBcImV4ZWN1dGlvbl9kYXRhXCJcbiAgfCBcImV4ZWN1dGlvbl9mZWVkYmFja1wiXG4gIHwgXCJoZWFsdGhfY2hlY2tcIlxuICB8IFwiaGVhbHRoX3Jlc3BvbnNlXCJcbiAgfCBcInN1cHBvcnRfcmVxdWVzdFwiXG4gIHwgXCJzdXBwb3J0X3Jlc3BvbnNlXCJcbiAgfCBcInJvdXRpbmdfaW5mb1wiXG4gIHwgXCJlcnJvcl9yZXBvcnRcIjtcblxuZXhwb3J0IHR5cGUgTWVzc2FnZVByaW9yaXR5ID1cbiAgfCBcImVtZXJnZW5jeVwiXG4gIHwgXCJjcml0aWNhbFwiXG4gIHwgXCJoaWdoXCJcbiAgfCBcIm1lZGl1bVwiXG4gIHwgXCJsb3dcIjtcbmV4cG9ydCB0eXBlIFJvdXRpbmdQYXRoID0gXCJkaXJlY3RfYmVkcm9ja1wiIHwgXCJtY3BcIiB8IFwiZmFsbGJhY2tcIiB8IFwiaHlicmlkXCI7XG5leHBvcnQgdHlwZSBNZXNzYWdlU3RhdHVzID1cbiAgfCBcInBlbmRpbmdcIlxuICB8IFwic2VudFwiXG4gIHwgXCJkZWxpdmVyZWRcIlxuICB8IFwiYWNrbm93bGVkZ2VkXCJcbiAgfCBcImZhaWxlZFwiXG4gIHwgXCJ0aW1lb3V0XCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgS2lyb0JyaWRnZU1lc3NhZ2Uge1xuICBpZDogc3RyaW5nO1xuICBjb3JyZWxhdGlvbklkOiBzdHJpbmc7XG4gIHR5cGU6IEtpcm9CcmlkZ2VNZXNzYWdlVHlwZTtcbiAgcHJpb3JpdHk6IE1lc3NhZ2VQcmlvcml0eTtcbiAgdGltZXN0YW1wOiBEYXRlO1xuICBzb3VyY2U6IFwiYmVkcm9ja1wiIHwgXCJraXJvXCI7XG4gIGRlc3RpbmF0aW9uOiBcImJlZHJvY2tcIiB8IFwia2lyb1wiO1xuICByb3V0aW5nUGF0aDogUm91dGluZ1BhdGg7XG4gIHBheWxvYWQ6IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIG1ldGFkYXRhOiB7XG4gICAgcmV0cnlDb3VudDogbnVtYmVyO1xuICAgIG1heFJldHJpZXM6IG51bWJlcjtcbiAgICB0aW1lb3V0OiBudW1iZXI7XG4gICAgZXhwaXJlc0F0OiBEYXRlO1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1lc3NhZ2VRdWV1ZUNvbmZpZyB7XG4gIG1heFF1ZXVlU2l6ZTogbnVtYmVyO1xuICBtYXhSZXRyaWVzOiBudW1iZXI7XG4gIHJldHJ5RGVsYXlNczogbnVtYmVyO1xuICB0aW1lb3V0TXM6IG51bWJlcjtcbiAgcHJpb3JpdHlMZXZlbHM6IFJlY29yZDxNZXNzYWdlUHJpb3JpdHksIG51bWJlcj47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tbXVuaWNhdGlvblN0YXRzIHtcbiAgbWVzc2FnZXNTZW50OiBudW1iZXI7XG4gIG1lc3NhZ2VzUmVjZWl2ZWQ6IG51bWJlcjtcbiAgbWVzc2FnZXNEZWxpdmVyZWQ6IG51bWJlcjtcbiAgbWVzc2FnZXNGYWlsZWQ6IG51bWJlcjtcbiAgYXZlcmFnZUxhdGVuY3k6IG51bWJlcjtcbiAgcXVldWVTaXplOiBudW1iZXI7XG4gIGVycm9yUmF0ZTogbnVtYmVyO1xuICBsYXN0QWN0aXZpdHk6IERhdGU7XG59XG5cbi8qKlxuICogS2lybyBCcmlkZ2UgQ29tbXVuaWNhdGlvbiBTeXN0ZW1cbiAqL1xuZXhwb3J0IGNsYXNzIEtpcm9CcmlkZ2Uge1xuICBwcml2YXRlIG1lc3NhZ2VRdWV1ZTogTWFwPHN0cmluZywgS2lyb0JyaWRnZU1lc3NhZ2U+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHBlbmRpbmdNZXNzYWdlczogTWFwPHN0cmluZywgS2lyb0JyaWRnZU1lc3NhZ2U+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIG1lc3NhZ2VIYW5kbGVyczogTWFwPFxuICAgIEtpcm9CcmlkZ2VNZXNzYWdlVHlwZSxcbiAgICAobWVzc2FnZTogS2lyb0JyaWRnZU1lc3NhZ2UpID0+IFByb21pc2U8dm9pZD5cbiAgPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSBzdGF0czogQ29tbXVuaWNhdGlvblN0YXRzO1xuICBwcml2YXRlIGNvbmZpZzogTWVzc2FnZVF1ZXVlQ29uZmlnO1xuICBwcml2YXRlIGlzQWN0aXZlOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgcHJvY2Vzc2luZ0ludGVydmFsPzogTm9kZUpTLlRpbWVvdXQ7XG5cbiAgY29uc3RydWN0b3IoY29uZmlnPzogUGFydGlhbDxNZXNzYWdlUXVldWVDb25maWc+KSB7XG4gICAgdGhpcy5jb25maWcgPSB7XG4gICAgICBtYXhRdWV1ZVNpemU6IDEwMDAsXG4gICAgICBtYXhSZXRyaWVzOiAzLFxuICAgICAgcmV0cnlEZWxheU1zOiAxMDAwLFxuICAgICAgdGltZW91dE1zOiAzMDAwMCxcbiAgICAgIHByaW9yaXR5TGV2ZWxzOiB7XG4gICAgICAgIGVtZXJnZW5jeTogMSxcbiAgICAgICAgY3JpdGljYWw6IDIsXG4gICAgICAgIGhpZ2g6IDMsXG4gICAgICAgIG1lZGl1bTogNCxcbiAgICAgICAgbG93OiA1LFxuICAgICAgfSxcbiAgICAgIC4uLmNvbmZpZyxcbiAgICB9O1xuXG4gICAgdGhpcy5zdGF0cyA9IHtcbiAgICAgIG1lc3NhZ2VzU2VudDogMCxcbiAgICAgIG1lc3NhZ2VzUmVjZWl2ZWQ6IDAsXG4gICAgICBtZXNzYWdlc0RlbGl2ZXJlZDogMCxcbiAgICAgIG1lc3NhZ2VzRmFpbGVkOiAwLFxuICAgICAgYXZlcmFnZUxhdGVuY3k6IDAsXG4gICAgICBxdWV1ZVNpemU6IDAsXG4gICAgICBlcnJvclJhdGU6IDAsXG4gICAgICBsYXN0QWN0aXZpdHk6IG5ldyBEYXRlKCksXG4gICAgfTtcblxuICAgIHRoaXMuaW5pdGlhbGl6ZURlZmF1bHRIYW5kbGVycygpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGluaXRpYWxpemUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5pc0FjdGl2ZSA9IHRydWU7XG4gICAgdGhpcy5wcm9jZXNzaW5nSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICB0aGlzLnByb2Nlc3NNZXNzYWdlUXVldWUoKTtcbiAgICB9LCAxMDApO1xuICAgIGNvbnNvbGUubG9nKFwiW0tpcm9CcmlkZ2VdIENvbW11bmljYXRpb24gc3lzdGVtIGluaXRpYWxpemVkXCIpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuaXNBY3RpdmUgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5wcm9jZXNzaW5nSW50ZXJ2YWwpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5wcm9jZXNzaW5nSW50ZXJ2YWwpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLnByb2Nlc3NNZXNzYWdlUXVldWUoKTtcbiAgICBjb25zb2xlLmxvZyhcIltLaXJvQnJpZGdlXSBDb21tdW5pY2F0aW9uIHN5c3RlbSBzaHV0ZG93blwiKTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZW5kRGlhZ25vc3RpY1JlcXVlc3QoXG4gICAgZGlhZ25vc3RpY1R5cGU6XG4gICAgICB8IFwic3lzdGVtX2hlYWx0aFwiXG4gICAgICB8IFwicGVyZm9ybWFuY2VcIlxuICAgICAgfCBcImVycm9yX2FuYWx5c2lzXCJcbiAgICAgIHwgXCJnYXBfZGV0ZWN0aW9uXCIsXG4gICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBvcHRpb25zPzoge1xuICAgICAgcHJpb3JpdHk/OiBNZXNzYWdlUHJpb3JpdHk7XG4gICAgICByb3V0aW5nUGF0aD86IFJvdXRpbmdQYXRoO1xuICAgIH1cbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBtZXNzYWdlOiBLaXJvQnJpZGdlTWVzc2FnZSA9IHtcbiAgICAgIGlkOiB1dWlkdjQoKSxcbiAgICAgIGNvcnJlbGF0aW9uSWQ6IHV1aWR2NCgpLFxuICAgICAgdHlwZTogXCJkaWFnbm9zdGljX3JlcXVlc3RcIixcbiAgICAgIHByaW9yaXR5OiBvcHRpb25zPy5wcmlvcml0eSB8fCBcIm1lZGl1bVwiLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgc291cmNlOiBcImJlZHJvY2tcIixcbiAgICAgIGRlc3RpbmF0aW9uOiBcImtpcm9cIixcbiAgICAgIHJvdXRpbmdQYXRoOiBvcHRpb25zPy5yb3V0aW5nUGF0aCB8fCBcImh5YnJpZFwiLFxuICAgICAgcGF5bG9hZDogeyBkaWFnbm9zdGljVHlwZSwgZGF0YSB9LFxuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgcmV0cnlDb3VudDogMCxcbiAgICAgICAgbWF4UmV0cmllczogdGhpcy5jb25maWcubWF4UmV0cmllcyxcbiAgICAgICAgdGltZW91dDogdGhpcy5jb25maWcudGltZW91dE1zLFxuICAgICAgICBleHBpcmVzQXQ6IG5ldyBEYXRlKERhdGUubm93KCkgKyB0aGlzLmNvbmZpZy50aW1lb3V0TXMpLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5xdWV1ZU1lc3NhZ2UobWVzc2FnZSk7XG4gICAgcmV0dXJuIG1lc3NhZ2UuY29ycmVsYXRpb25JZDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZW5kRXhlY3V0aW9uRGF0YShcbiAgICBleGVjdXRpb25JZDogc3RyaW5nLFxuICAgIG9wZXJhdGlvbjogc3RyaW5nLFxuICAgIHN0YXR1czogXCJzdGFydGVkXCIgfCBcInJ1bm5pbmdcIiB8IFwiY29tcGxldGVkXCIgfCBcImZhaWxlZFwiLFxuICAgIGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT5cbiAgKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBtZXNzYWdlOiBLaXJvQnJpZGdlTWVzc2FnZSA9IHtcbiAgICAgIGlkOiB1dWlkdjQoKSxcbiAgICAgIGNvcnJlbGF0aW9uSWQ6IHV1aWR2NCgpLFxuICAgICAgdHlwZTogXCJleGVjdXRpb25fZGF0YVwiLFxuICAgICAgcHJpb3JpdHk6IFwibWVkaXVtXCIsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICBzb3VyY2U6IFwiYmVkcm9ja1wiLFxuICAgICAgZGVzdGluYXRpb246IFwia2lyb1wiLFxuICAgICAgcm91dGluZ1BhdGg6IFwiaHlicmlkXCIsXG4gICAgICBwYXlsb2FkOiB7IGV4ZWN1dGlvbklkLCBvcGVyYXRpb24sIHN0YXR1cywgLi4uZGF0YSB9LFxuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgcmV0cnlDb3VudDogMCxcbiAgICAgICAgbWF4UmV0cmllczogdGhpcy5jb25maWcubWF4UmV0cmllcyxcbiAgICAgICAgdGltZW91dDogdGhpcy5jb25maWcudGltZW91dE1zLFxuICAgICAgICBleHBpcmVzQXQ6IG5ldyBEYXRlKERhdGUubm93KCkgKyB0aGlzLmNvbmZpZy50aW1lb3V0TXMpLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5xdWV1ZU1lc3NhZ2UobWVzc2FnZSk7XG4gICAgcmV0dXJuIG1lc3NhZ2UuY29ycmVsYXRpb25JZDtcbiAgfVxuXG4gIHB1YmxpYyByZWdpc3Rlck1lc3NhZ2VIYW5kbGVyKFxuICAgIG1lc3NhZ2VUeXBlOiBLaXJvQnJpZGdlTWVzc2FnZVR5cGUsXG4gICAgaGFuZGxlcjogKG1lc3NhZ2U6IEtpcm9CcmlkZ2VNZXNzYWdlKSA9PiBQcm9taXNlPHZvaWQ+XG4gICk6IHZvaWQge1xuICAgIHRoaXMubWVzc2FnZUhhbmRsZXJzLnNldChtZXNzYWdlVHlwZSwgaGFuZGxlcik7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVjZWl2ZU1lc3NhZ2UobWVzc2FnZTogS2lyb0JyaWRnZU1lc3NhZ2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5zdGF0cy5tZXNzYWdlc1JlY2VpdmVkKys7XG4gICAgICB0aGlzLnN0YXRzLmxhc3RBY3Rpdml0eSA9IG5ldyBEYXRlKCk7XG5cbiAgICAgIGNvbnN0IGhhbmRsZXIgPSB0aGlzLm1lc3NhZ2VIYW5kbGVycy5nZXQobWVzc2FnZS50eXBlKTtcbiAgICAgIGlmIChoYW5kbGVyKSB7XG4gICAgICAgIGF3YWl0IGhhbmRsZXIobWVzc2FnZSk7XG4gICAgICAgIHRoaXMuc3RhdHMubWVzc2FnZXNEZWxpdmVyZWQrKztcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihgW0tpcm9CcmlkZ2VdIEVycm9yIHByb2Nlc3NpbmcgbWVzc2FnZTpgLCBlcnJvcik7XG4gICAgICB0aGlzLnN0YXRzLm1lc3NhZ2VzRmFpbGVkKys7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldFN0YXRzKCk6IENvbW11bmljYXRpb25TdGF0cyB7XG4gICAgdGhpcy5zdGF0cy5xdWV1ZVNpemUgPSB0aGlzLm1lc3NhZ2VRdWV1ZS5zaXplO1xuICAgIHRoaXMuc3RhdHMuZXJyb3JSYXRlID1cbiAgICAgIHRoaXMuc3RhdHMubWVzc2FnZXNGYWlsZWQgLyBNYXRoLm1heCh0aGlzLnN0YXRzLm1lc3NhZ2VzU2VudCwgMSk7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5zdGF0cyB9O1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplRGVmYXVsdEhhbmRsZXJzKCk6IHZvaWQge1xuICAgIHRoaXMucmVnaXN0ZXJNZXNzYWdlSGFuZGxlcihcImRpYWdub3N0aWNfcmVzcG9uc2VcIiwgYXN5bmMgKG1lc3NhZ2UpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBgW0tpcm9CcmlkZ2VdIFJlY2VpdmVkIGRpYWdub3N0aWMgcmVzcG9uc2U6ICR7bWVzc2FnZS5jb3JyZWxhdGlvbklkfWBcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJlZ2lzdGVyTWVzc2FnZUhhbmRsZXIoXCJleGVjdXRpb25fZmVlZGJhY2tcIiwgYXN5bmMgKG1lc3NhZ2UpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKFxuICAgICAgICBgW0tpcm9CcmlkZ2VdIFJlY2VpdmVkIGV4ZWN1dGlvbiBmZWVkYmFjazogJHttZXNzYWdlLmNvcnJlbGF0aW9uSWR9YFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcXVldWVNZXNzYWdlKG1lc3NhZ2U6IEtpcm9CcmlkZ2VNZXNzYWdlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMubWVzc2FnZVF1ZXVlLnNpemUgPj0gdGhpcy5jb25maWcubWF4UXVldWVTaXplKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNZXNzYWdlIHF1ZXVlIGlzIGZ1bGxcIik7XG4gICAgfVxuXG4gICAgdGhpcy5tZXNzYWdlUXVldWUuc2V0KG1lc3NhZ2UuaWQsIG1lc3NhZ2UpO1xuICAgIHRoaXMuc3RhdHMubWVzc2FnZXNTZW50Kys7XG4gICAgdGhpcy5zdGF0cy5sYXN0QWN0aXZpdHkgPSBuZXcgRGF0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwcm9jZXNzTWVzc2FnZVF1ZXVlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSB8fCB0aGlzLm1lc3NhZ2VRdWV1ZS5zaXplID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbWVzc2FnZXMgPSBBcnJheS5mcm9tKHRoaXMubWVzc2FnZVF1ZXVlLnZhbHVlcygpKS5zb3J0KFxuICAgICAgKGEsIGIpID0+XG4gICAgICAgIHRoaXMuY29uZmlnLnByaW9yaXR5TGV2ZWxzW2EucHJpb3JpdHldIC1cbiAgICAgICAgdGhpcy5jb25maWcucHJpb3JpdHlMZXZlbHNbYi5wcmlvcml0eV1cbiAgICApO1xuXG4gICAgZm9yIChjb25zdCBtZXNzYWdlIG9mIG1lc3NhZ2VzLnNsaWNlKDAsIDEwKSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy50cmFuc21pdE1lc3NhZ2UobWVzc2FnZSk7XG4gICAgICAgIHRoaXMubWVzc2FnZVF1ZXVlLmRlbGV0ZShtZXNzYWdlLmlkKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYFtLaXJvQnJpZGdlXSBGYWlsZWQgdG8gdHJhbnNtaXQgbWVzc2FnZTpgLCBlcnJvcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB0cmFuc21pdE1lc3NhZ2UobWVzc2FnZTogS2lyb0JyaWRnZU1lc3NhZ2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIGBbS2lyb0JyaWRnZV0gVHJhbnNtaXR0aW5nIG1lc3NhZ2U6ICR7bWVzc2FnZS5pZH0gdmlhICR7bWVzc2FnZS5yb3V0aW5nUGF0aH1gXG4gICAgKTtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBNYXRoLnJhbmRvbSgpICogMTAwKSk7XG4gIH1cbn1cblxuLy8gRGVmYXVsdCBpbnN0YW5jZSBleHBvcnRcbmV4cG9ydCBjb25zdCBraXJvQnJpZGdlID0gbmV3IEtpcm9CcmlkZ2UoKTtcblxuLy8gVGhlIGNsYXNzIGlzIGFscmVhZHkgZXhwb3J0ZWQgYWJvdmUsIG5vIG5lZWQgdG8gcmUtZXhwb3J0XG4iXSwidmVyc2lvbiI6M30=