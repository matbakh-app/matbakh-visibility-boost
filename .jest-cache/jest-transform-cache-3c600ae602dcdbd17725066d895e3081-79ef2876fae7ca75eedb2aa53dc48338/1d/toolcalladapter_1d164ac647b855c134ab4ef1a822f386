0c3965446d02c4be1268871db87c84ea
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BaseAdapter = void 0;
class BaseAdapter {
    // Convert ToolSpec to unified OpenAI-like schema
    toUnifiedSchema(tools) {
        if (!tools?.length)
            return undefined;
        return tools.map((tool) => ({
            type: "function",
            function: {
                name: tool.name,
                description: tool.description || `Execute ${tool.name} function`,
                parameters: {
                    type: "object",
                    properties: tool.parameters || {},
                    required: this.extractRequiredFields(tool.parameters),
                    additionalProperties: false,
                },
            },
        }));
    }
    // Convert unified schema back to provider format (default implementation)
    fromUnifiedSchema(tools) {
        if (!tools?.length)
            return undefined;
        const toolSpecs = tools.map((tool) => ({
            name: tool.function.name,
            description: tool.function.description,
            parameters: tool.function.parameters.properties,
        }));
        return this.mapTools(toolSpecs);
    }
    // Parse tool calls with enhanced error handling
    parseToolCalls(resp) {
        try {
            const toolCalls = this.extractToolCallsFromResponse(resp);
            return toolCalls.map((call, index) => ({
                id: call.id || `call_${index}`,
                type: "function",
                function: {
                    name: call.name,
                    arguments: this.normalizeArguments(call.arguments),
                },
                provider: this.getProviderName(),
                confidence: call.confidence || 1.0,
            }));
        }
        catch (error) {
            console.warn(`Failed to parse tool calls: ${error}`);
            return [];
        }
    }
    // Validate tool specification
    validateToolSpec(tool) {
        try {
            if ("function" in tool) {
                // UnifiedToolSpec validation
                const func = tool.function;
                return !!(func.name &&
                    func.parameters &&
                    func.parameters.type === "object" &&
                    func.parameters.properties);
            }
            else {
                // ToolSpec validation
                return !!(tool.name && typeof tool.name === "string");
            }
        }
        catch {
            return false;
        }
    }
    // Check if provider supports specific tool features (default: basic support)
    supportsToolFeature(feature) {
        const config = this.getProviderConfig();
        switch (feature) {
            case "parallel_calls":
                return config.supportsTools;
            case "streaming":
                return config.supportsStreaming && config.supportsTools;
            case "json_schema":
                return config.supportsJsonMode || false;
            case "complex_types":
                return config.supportsTools;
            default:
                return false;
        }
    }
    // Simple token estimation (override for provider-specific tokenizers)
    estimateTokens(text) {
        // Rough estimation: ~4 characters per token for most models
        const tokens = Math.ceil(text.length / 4);
        return { input: tokens, output: 0 };
    }
    // Common error handling with enhanced context
    handleError(error, provider, context) {
        const message = error?.message || "Unknown error";
        const contextStr = context ? ` (${context})` : "";
        throw new Error(`${provider} adapter error${contextStr}: ${message}`);
    }
    // Common response validation
    validateResponse(resp, provider) {
        if (!resp) {
            throw new Error(`${provider} returned empty response`);
        }
    }
    // Helper methods for subclasses
    extractRequiredFields(parameters) {
        if (!parameters)
            return [];
        return Object.entries(parameters)
            .filter(([_, schema]) => schema?.required === true || schema?.nullable === false)
            .map(([key]) => key);
    }
    normalizeArguments(args) {
        if (typeof args === "string") {
            try {
                return JSON.parse(args);
            }
            catch {
                return args;
            }
        }
        return args || {};
    }
}
exports.BaseAdapter = BaseAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hdGJha2gtdmlzaWJpbGl0eS1ib29zdC4yMDI1MDkyMC9zcmMvbGliL2FpLW9yY2hlc3RyYXRvci9hZGFwdGVycy90b29sLWNhbGwtYWRhcHRlci50cyIsIm1hcHBpbmdzIjoiOzs7QUE2RUEsTUFBc0IsV0FBVztJQW9CL0IsaURBQWlEO0lBQ2pELGVBQWUsQ0FBQyxLQUFrQjtRQUNoQyxJQUFJLENBQUMsS0FBSyxFQUFFLE1BQU07WUFBRSxPQUFPLFNBQVMsQ0FBQztRQUVyQyxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDMUIsSUFBSSxFQUFFLFVBQW1CO1lBQ3pCLFFBQVEsRUFBRTtnQkFDUixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ2YsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLElBQUksV0FBVyxJQUFJLENBQUMsSUFBSSxXQUFXO2dCQUNoRSxVQUFVLEVBQUU7b0JBQ1YsSUFBSSxFQUFFLFFBQWlCO29CQUN2QixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFO29CQUNqQyxRQUFRLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7b0JBQ3JELG9CQUFvQixFQUFFLEtBQUs7aUJBQzVCO2FBQ0Y7U0FDRixDQUFDLENBQUMsQ0FBQztJQUNOLENBQUM7SUFFRCwwRUFBMEU7SUFDMUUsaUJBQWlCLENBQUMsS0FBeUI7UUFDekMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNO1lBQUUsT0FBTyxTQUFTLENBQUM7UUFFckMsTUFBTSxTQUFTLEdBQWUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNqRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJO1lBQ3hCLFdBQVcsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVc7WUFDdEMsVUFBVSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFB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RSxDQUFDO0lBQ3BCLENBQUM7Q0FXRjtBQXBLRCxrQ0FvS0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hdGJha2gtdmlzaWJpbGl0eS1ib29zdC4yMDI1MDkyMC9zcmMvbGliL2FpLW9yY2hlc3RyYXRvci9hZGFwdGVycy90b29sLWNhbGwtYWRhcHRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcm92aWRlclJlc3BvbnNlLCBSb3V0ZURlY2lzaW9uLCBUb29sU3BlYyB9IGZyb20gXCIuLi90eXBlc1wiO1xuXG4vLyBPcGVuQUktbGlrZSB1bmlmaWVkIHRvb2wgc2NoZW1hIGZvciBjcm9zcy1wcm92aWRlciBjb21wYXRpYmlsaXR5XG5leHBvcnQgaW50ZXJmYWNlIFVuaWZpZWRUb29sU3BlYyB7XG4gIHR5cGU6IFwiZnVuY3Rpb25cIjtcbiAgZnVuY3Rpb246IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgcGFyYW1ldGVyczoge1xuICAgICAgdHlwZTogXCJvYmplY3RcIjtcbiAgICAgIHByb3BlcnRpZXM6IFJlY29yZDxzdHJpbmcsIGFueT47XG4gICAgICByZXF1aXJlZD86IHN0cmluZ1tdO1xuICAgICAgYWRkaXRpb25hbFByb3BlcnRpZXM/OiBib29sZWFuO1xuICAgIH07XG4gIH07XG59XG5cbi8vIEVuaGFuY2VkIHRvb2wgY2FsbCByZXN1bHQgd2l0aCBwcm92aWRlciBjb250ZXh0XG5leHBvcnQgaW50ZXJmYWNlIFVuaWZpZWRUb29sQ2FsbCB7XG4gIGlkPzogc3RyaW5nO1xuICB0eXBlOiBcImZ1bmN0aW9uXCI7XG4gIGZ1bmN0aW9uOiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGFyZ3VtZW50czogc3RyaW5nIHwgUmVjb3JkPHN0cmluZywgYW55PjtcbiAgfTtcbiAgcHJvdmlkZXI/OiBzdHJpbmc7XG4gIGNvbmZpZGVuY2U/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9vbENhbGxBZGFwdGVyIHtcbiAgLy8gTm9ybWFsaXplIHRvb2wgZGVmaW5pdGlvbnMgdG8gcHJvdmlkZXItbmF0aXZlIGZvcm1hdFxuICBtYXBUb29scyh0b29scz86IFRvb2xTcGVjW10pOiBhbnkgfCB1bmRlZmluZWQ7XG5cbiAgLy8gQ29udmVydCB0byB1bmlmaWVkIE9wZW5BSS1saWtlIHNjaGVtYVxuICB0b1VuaWZpZWRTY2hlbWEodG9vbHM/OiBUb29sU3BlY1tdKTogVW5pZmllZFRvb2xTcGVjW10gfCB1bmRlZmluZWQ7XG5cbiAgLy8gQ29udmVydCBmcm9tIHVuaWZpZWQgc2NoZW1hIHRvIHByb3ZpZGVyIGZvcm1hdFxuICBmcm9tVW5pZmllZFNjaGVtYSh0b29scz86IFVuaWZpZWRUb29sU3BlY1tdKTogYW55IHwgdW5kZWZpbmVkO1xuXG4gIC8vIEJ1aWxkIHByb3ZpZGVyIHJlcXVlc3QgcGF5bG9hZCBmcm9tIG5ldXRyYWwgZGVjaXNpb25cbiAgYnVpbGRSZXF1ZXN0KGlucHV0OiB7XG4gICAgcHJvbXB0OiBzdHJpbmc7XG4gICAgZGVjaXNpb246IFJvdXRlRGVjaXNpb247XG4gICAgc3RyZWFtaW5nPzogYm9vbGVhbjtcbiAgICBtYXhUb2tlbnM/OiBudW1iZXI7XG4gICAgdG9vbHM/OiBUb29sU3BlY1tdIHwgVW5pZmllZFRvb2xTcGVjW107XG4gIH0pOiBhbnk7XG5cbiAgLy8gUGFyc2UgcHJvdmlkZXIgcmVzcG9uc2UgLT4gbmV1dHJhbCBzaGFwZVxuICBwYXJzZVJlc3BvbnNlKHJlc3A6IGFueSk6IFByb3ZpZGVyUmVzcG9uc2U7XG5cbiAgLy8gUGFyc2UgdG9vbCBjYWxscyB3aXRoIGVuaGFuY2VkIGVycm9yIGhhbmRsaW5nXG4gIHBhcnNlVG9vbENhbGxzKHJlc3A6IGFueSk6IFVuaWZpZWRUb29sQ2FsbFtdO1xuXG4gIC8vIEVzdGltYXRlIHRva2VuIGNvdW50IGZvciBjb3N0IGNhbGN1bGF0aW9uXG4gIGVzdGltYXRlVG9rZW5zKHRleHQ6IHN0cmluZyk6IHsgaW5wdXQ6IG51bWJlcjsgb3V0cHV0OiBudW1iZXIgfTtcblxuICAvLyBHZXQgcHJvdmlkZXItc3BlY2lmaWMgY29uZmlndXJhdGlvblxuICBnZXRQcm92aWRlckNvbmZpZygpOiB7XG4gICAgbWF4Q29udGV4dFRva2VuczogbnVtYmVyO1xuICAgIHN1cHBvcnRzU3RyZWFtaW5nOiBib29sZWFuO1xuICAgIHN1cHBvcnRzVG9vbHM6IGJvb2xlYW47XG4gICAgc3VwcG9ydHNKc29uTW9kZT86IGJvb2xlYW47XG4gICAgc3VwcG9ydHNWaXNpb24/OiBib29sZWFuO1xuICAgIHJhdGVMaW1pdFJwbTogbnVtYmVyO1xuICAgIGZhbGxiYWNrUHJvdmlkZXI/OiBzdHJpbmc7XG4gIH07XG5cbiAgLy8gVmFsaWRhdGUgdG9vbCBzcGVjaWZpY2F0aW9uXG4gIHZhbGlkYXRlVG9vbFNwZWModG9vbDogVG9vbFNwZWMgfCBVbmlmaWVkVG9vbFNwZWMpOiBib29sZWFuO1xuXG4gIC8vIENoZWNrIGlmIHByb3ZpZGVyIHN1cHBvcnRzIHNwZWNpZmljIHRvb2wgZmVhdHVyZXNcbiAgc3VwcG9ydHNUb29sRmVhdHVyZShcbiAgICBmZWF0dXJlOiBcInBhcmFsbGVsX2NhbGxzXCIgfCBcInN0cmVhbWluZ1wiIHwgXCJqc29uX3NjaGVtYVwiIHwgXCJjb21wbGV4X3R5cGVzXCJcbiAgKTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEJhc2VBZGFwdGVyIGltcGxlbWVudHMgVG9vbENhbGxBZGFwdGVyIHtcbiAgYWJzdHJhY3QgbWFwVG9vbHModG9vbHM/OiBUb29sU3BlY1tdKTogYW55IHwgdW5kZWZpbmVkO1xuICBhYnN0cmFjdCBidWlsZFJlcXVlc3QoaW5wdXQ6IHtcbiAgICBwcm9tcHQ6IHN0cmluZztcbiAgICBkZWNpc2lvbjogUm91dGVEZWNpc2lvbjtcbiAgICBzdHJlYW1pbmc/OiBib29sZWFuO1xuICAgIG1heFRva2Vucz86IG51bWJlcjtcbiAgICB0b29scz86IFRvb2xTcGVjW10gfCBVbmlmaWVkVG9vbFNwZWNbXTtcbiAgfSk6IGFueTtcbiAgYWJzdHJhY3QgcGFyc2VSZXNwb25zZShyZXNwOiBhbnkpOiBQcm92aWRlclJlc3BvbnNlO1xuICBhYnN0cmFjdCBnZXRQcm92aWRlckNvbmZpZygpOiB7XG4gICAgbWF4Q29udGV4dFRva2VuczogbnVtYmVyO1xuICAgIHN1cHBvcnRzU3RyZWFtaW5nOiBib29sZWFuO1xuICAgIHN1cHBvcnRzVG9vbHM6IGJvb2xlYW47XG4gICAgc3VwcG9ydHNKc29uTW9kZT86IGJvb2xlYW47XG4gICAgc3VwcG9ydHNWaXNpb24/OiBib29sZWFuO1xuICAgIHJhdGVMaW1pdFJwbTogbnVtYmVyO1xuICAgIGZhbGxiYWNrUHJvdmlkZXI/OiBzdHJpbmc7XG4gIH07XG5cbiAgLy8gQ29udmVydCBUb29sU3BlYyB0byB1bmlmaWVkIE9wZW5BSS1saWtlIHNjaGVtYVxuICB0b1VuaWZpZWRTY2hlbWEodG9vbHM/OiBUb29sU3BlY1tdKTogVW5pZmllZFRvb2xTcGVjW10gfCB1bmRlZmluZWQge1xuICAgIGlmICghdG9vbHM/Lmxlbmd0aCkgcmV0dXJuIHVuZGVmaW5lZDtcblxuICAgIHJldHVybiB0b29scy5tYXAoKHRvb2wpID0+ICh7XG4gICAgICB0eXBlOiBcImZ1bmN0aW9uXCIgYXMgY29uc3QsXG4gICAgICBmdW5jdGlvbjoge1xuICAgICAgICBuYW1lOiB0b29sLm5hbWUsXG4gICAgICAgIGRlc2NyaXB0aW9uOiB0b29sLmRlc2NyaXB0aW9uIHx8IGBFeGVjdXRlICR7dG9vbC5uYW1lfSBmdW5jdGlvbmAsXG4gICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICB0eXBlOiBcIm9iamVjdFwiIGFzIGNvbnN0LFxuICAgICAgICAgIHByb3BlcnRpZXM6IHRvb2wucGFyYW1ldGVycyB8fCB7fSxcbiAgICAgICAgICByZXF1aXJlZDogdGhpcy5leHRyYWN0UmVxdWlyZWRGaWVsZHModG9vbC5wYXJhbWV0ZXJzKSxcbiAgICAgICAgICBhZGRpdGlvbmFsUHJvcGVydGllczogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIH0pKTtcbiAgfVxuXG4gIC8vIENvbnZlcnQgdW5pZmllZCBzY2hlbWEgYmFjayB0byBwcm92aWRlciBmb3JtYXQgKGRlZmF1bHQgaW1wbGVtZW50YXRpb24pXG4gIGZyb21VbmlmaWVkU2NoZW1hKHRvb2xzPzogVW5pZmllZFRvb2xTcGVjW10pOiBhbnkgfCB1bmRlZmluZWQge1xuICAgIGlmICghdG9vbHM/Lmxlbmd0aCkgcmV0dXJuIHVuZGVmaW5lZDtcblxuICAgIGNvbnN0IHRvb2xTcGVjczogVG9vbFNwZWNbXSA9IHRvb2xzLm1hcCgodG9vbCkgPT4gKHtcbiAgICAgIG5hbWU6IHRvb2wuZnVuY3Rpb24ubmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uOiB0b29sLmZ1bmN0aW9uLmRlc2NyaXB0aW9uLFxuICAgICAgcGFyYW1ldGVyczogdG9vbC5mdW5jdGlvbi5wYXJhbWV0ZXJzLnByb3BlcnRpZXMsXG4gICAgfSkpO1xuXG4gICAgcmV0dXJuIHRoaXMubWFwVG9vbHModG9vbFNwZWNzKTtcbiAgfVxuXG4gIC8vIFBhcnNlIHRvb2wgY2FsbHMgd2l0aCBlbmhhbmNlZCBlcnJvciBoYW5kbGluZ1xuICBwYXJzZVRvb2xDYWxscyhyZXNwOiBhbnkpOiBVbmlmaWVkVG9vbENhbGxbXSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRvb2xDYWxscyA9IHRoaXMuZXh0cmFjdFRvb2xDYWxsc0Zyb21SZXNwb25zZShyZXNwKTtcbiAgICAgIHJldHVybiB0b29sQ2FsbHMubWFwKChjYWxsLCBpbmRleCkgPT4gKHtcbiAgICAgICAgaWQ6IGNhbGwuaWQgfHwgYGNhbGxfJHtpbmRleH1gLFxuICAgICAgICB0eXBlOiBcImZ1bmN0aW9uXCIgYXMgY29uc3QsXG4gICAgICAgIGZ1bmN0aW9uOiB7XG4gICAgICAgICAgbmFtZTogY2FsbC5uYW1lLFxuICAgICAgICAgIGFyZ3VtZW50czogdGhpcy5ub3JtYWxpemVBcmd1bWVudHMoY2FsbC5hcmd1bWVudHMpLFxuICAgICAgICB9LFxuICAgICAgICBwcm92aWRlcjogdGhpcy5nZXRQcm92aWRlck5hbWUoKSxcbiAgICAgICAgY29uZmlkZW5jZTogY2FsbC5jb25maWRlbmNlIHx8IDEuMCxcbiAgICAgIH0pKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKGBGYWlsZWQgdG8gcGFyc2UgdG9vbCBjYWxsczogJHtlcnJvcn1gKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH1cblxuICAvLyBWYWxpZGF0ZSB0b29sIHNwZWNpZmljYXRpb25cbiAgdmFsaWRhdGVUb29sU3BlYyh0b29sOiBUb29sU3BlYyB8IFVuaWZpZWRUb29sU3BlYyk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICBpZiAoXCJmdW5jdGlvblwiIGluIHRvb2wpIHtcbiAgICAgICAgLy8gVW5pZmllZFRvb2xTcGVjIHZhbGlkYXRpb25cbiAgICAgICAgY29uc3QgZnVuYyA9IHRvb2wuZnVuY3Rpb247XG4gICAgICAgIHJldHVybiAhIShcbiAgICAgICAgICBmdW5jLm5hbWUgJiZcbiAgICAgICAgICBmdW5jLnBhcmFtZXRlcnMgJiZcbiAgICAgICAgICBmdW5jLnBhcmFtZXRlcnMudHlwZSA9PT0gXCJvYmplY3RcIiAmJlxuICAgICAgICAgIGZ1bmMucGFyYW1ldGVycy5wcm9wZXJ0aWVzXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBUb29sU3BlYyB2YWxpZGF0aW9uXG4gICAgICAgIHJldHVybiAhISh0b29sLm5hbWUgJiYgdHlwZW9mIHRvb2wubmFtZSA9PT0gXCJzdHJpbmdcIik7XG4gICAgICB9XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLy8gQ2hlY2sgaWYgcHJvdmlkZXIgc3VwcG9ydHMgc3BlY2lmaWMgdG9vbCBmZWF0dXJlcyAoZGVmYXVsdDogYmFzaWMgc3VwcG9ydClcbiAgc3VwcG9ydHNUb29sRmVhdHVyZShcbiAgICBmZWF0dXJlOiBcInBhcmFsbGVsX2NhbGxzXCIgfCBcInN0cmVhbWluZ1wiIHwgXCJqc29uX3NjaGVtYVwiIHwgXCJjb21wbGV4X3R5cGVzXCJcbiAgKTogYm9vbGVhbiB7XG4gICAgY29uc3QgY29uZmlnID0gdGhpcy5nZXRQcm92aWRlckNvbmZpZygpO1xuICAgIHN3aXRjaCAoZmVhdHVyZSkge1xuICAgICAgY2FzZSBcInBhcmFsbGVsX2NhbGxzXCI6XG4gICAgICAgIHJldHVybiBjb25maWcuc3VwcG9ydHNUb29scztcbiAgICAgIGNhc2UgXCJzdHJlYW1pbmdcIjpcbiAgICAgICAgcmV0dXJuIGNvbmZpZy5zdXBwb3J0c1N0cmVhbWluZyAmJiBjb25maWcuc3VwcG9ydHNUb29scztcbiAgICAgIGNhc2UgXCJqc29uX3NjaGVtYVwiOlxuICAgICAgICByZXR1cm4gY29uZmlnLnN1cHBvcnRzSnNvbk1vZGUgfHwgZmFsc2U7XG4gICAgICBjYXNlIFwiY29tcGxleF90eXBlc1wiOlxuICAgICAgICByZXR1cm4gY29uZmlnLnN1cHBvcnRzVG9vbHM7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLy8gU2ltcGxlIHRva2VuIGVzdGltYXRpb24gKG92ZXJyaWRlIGZvciBwcm92aWRlci1zcGVjaWZpYyB0b2tlbml6ZXJzKVxuICBlc3RpbWF0ZVRva2Vucyh0ZXh0OiBzdHJpbmcpOiB7IGlucHV0OiBudW1iZXI7IG91dHB1dDogbnVtYmVyIH0ge1xuICAgIC8vIFJvdWdoIGVzdGltYXRpb246IH40IGNoYXJhY3RlcnMgcGVyIHRva2VuIGZvciBtb3N0IG1vZGVsc1xuICAgIGNvbnN0IHRva2VucyA9IE1hdGguY2VpbCh0ZXh0Lmxlbmd0aCAvIDQpO1xuICAgIHJldHVybiB7IGlucHV0OiB0b2tlbnMsIG91dHB1dDogMCB9O1xuICB9XG5cbiAgLy8gQ29tbW9uIGVycm9yIGhhbmRsaW5nIHdpdGggZW5oYW5jZWQgY29udGV4dFxuICBwcm90ZWN0ZWQgaGFuZGxlRXJyb3IoZXJyb3I6IGFueSwgcHJvdmlkZXI6IHN0cmluZywgY29udGV4dD86IHN0cmluZyk6IG5ldmVyIHtcbiAgICBjb25zdCBtZXNzYWdlID0gZXJyb3I/Lm1lc3NhZ2UgfHwgXCJVbmtub3duIGVycm9yXCI7XG4gICAgY29uc3QgY29udGV4dFN0ciA9IGNvbnRleHQgPyBgICgke2NvbnRleHR9KWAgOiBcIlwiO1xuICAgIHRocm93IG5ldyBFcnJvcihgJHtwcm92aWRlcn0gYWRhcHRlciBlcnJvciR7Y29udGV4dFN0cn06ICR7bWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIENvbW1vbiByZXNwb25zZSB2YWxpZGF0aW9uXG4gIHByb3RlY3RlZCB2YWxpZGF0ZVJlc3BvbnNlKHJlc3A6IGFueSwgcHJvdmlkZXI6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICghcmVzcCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3Byb3ZpZGVyfSByZXR1cm5lZCBlbXB0eSByZXNwb25zZWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIEhlbHBlciBtZXRob2RzIGZvciBzdWJjbGFzc2VzXG4gIHByb3RlY3RlZCBleHRyYWN0UmVxdWlyZWRGaWVsZHMocGFyYW1ldGVycz86IFJlY29yZDxzdHJpbmcsIGFueT4pOiBzdHJpbmdbXSB7XG4gICAgaWYgKCFwYXJhbWV0ZXJzKSByZXR1cm4gW107XG5cbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMocGFyYW1ldGVycylcbiAgICAgIC5maWx0ZXIoXG4gICAgICAgIChbXywgc2NoZW1hXSkgPT4gc2NoZW1hPy5yZXF1aXJlZCA9PT0gdHJ1ZSB8fCBzY2hlbWE/Lm51bGxhYmxlID09PSBmYWxzZVxuICAgICAgKVxuICAgICAgLm1hcCgoW2tleV0pID0+IGtleSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgbm9ybWFsaXplQXJndW1lbnRzKGFyZ3M6IGFueSk6IHN0cmluZyB8IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIGlmICh0eXBlb2YgYXJncyA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoYXJncyk7XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIGFyZ3M7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBhcmdzIHx8IHt9O1xuICB9XG5cbiAgLy8gQWJzdHJhY3QgbWV0aG9kcyBmb3Igc3ViY2xhc3NlcyB0byBpbXBsZW1lbnRcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGV4dHJhY3RUb29sQ2FsbHNGcm9tUmVzcG9uc2UocmVzcDogYW55KTogQXJyYXk8e1xuICAgIGlkPzogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBhcmd1bWVudHM6IGFueTtcbiAgICBjb25maWRlbmNlPzogbnVtYmVyO1xuICB9PjtcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0UHJvdmlkZXJOYW1lKCk6IHN0cmluZztcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==