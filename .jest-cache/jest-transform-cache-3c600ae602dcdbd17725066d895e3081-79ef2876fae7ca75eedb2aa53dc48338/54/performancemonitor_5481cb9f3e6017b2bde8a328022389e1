7b975071b748f1237f05b21e7efb200d
"use strict";
/**
 * Performance Monitor
 *
 * Tracks performance metrics, SLO compliance, and automated rollback triggers
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.PerformanceMonitor = void 0;
exports.createPerformanceMonitor = createPerformanceMonitor;
class PerformanceMonitor {
    requests = new Map();
    alerts = [];
    slos = [
        { name: "P95 Latency", threshold: 1500, currentValue: 0, violated: false },
        { name: "Error Rate", threshold: 0.01, currentValue: 0, violated: false },
        { name: "Availability", threshold: 0.99, currentValue: 1, violated: false },
    ];
    recordRequestStart(request) {
        const requestId = `req-${Date.now()}-${Math.random()
            .toString(36)
            .substr(2, 9)}`;
        return requestId;
    }
    recordRequestComplete(requestId, request, response, startTime) {
        const endTime = Date.now();
        const latency = endTime - startTime;
        const record = {
            requestId,
            request,
            response,
            startTime,
            endTime,
            latency,
        };
        this.requests.set(requestId, record);
        this.updateSLOs();
        this.checkAlerts();
    }
    getGlobalMetrics() {
        if (this.requests.size === 0)
            return null;
        const records = Array.from(this.requests.values());
        const successCount = records.filter((r) => r.response.success).length;
        const errorCount = records.filter((r) => !r.response.success).length;
        const latencies = records.map((r) => r.latency).sort((a, b) => a - b);
        const costs = records.map((r) => r.response.costEuro || 0);
        return {
            requestCount: records.length,
            successCount,
            errorCount,
            errorRate: errorCount / records.length,
            averageLatency: latencies.reduce((a, b) => a + b, 0) / latencies.length,
            p95Latency: this.calculatePercentile(latencies, 0.95),
            p99Latency: this.calculatePercentile(latencies, 0.99),
            totalCost: costs.reduce((a, b) => a + b, 0),
            costPerRequest: costs.reduce((a, b) => a + b, 0) / records.length,
        };
    }
    getProviderMetrics(provider) {
        const records = Array.from(this.requests.values()).filter((r) => r.response.provider === provider);
        if (records.length === 0)
            return [];
        const successCount = records.filter((r) => r.response.success).length;
        const errorCount = records.filter((r) => !r.response.success).length;
        const latencies = records.map((r) => r.latency).sort((a, b) => a - b);
        const costs = records.map((r) => r.response.costEuro || 0);
        return [
            {
                provider,
                requestCount: records.length,
                successCount,
                errorCount,
                errorRate: errorCount / records.length,
                averageLatency: latencies.reduce((a, b) => a + b, 0) / latencies.length,
                p95Latency: this.calculatePercentile(latencies, 0.95),
                p99Latency: this.calculatePercentile(latencies, 0.99),
                totalCost: costs.reduce((a, b) => a + b, 0),
                costPerRequest: costs.reduce((a, b) => a + b, 0) / records.length,
                availability: successCount / records.length,
                circuitBreakerOpen: errorCount / records.length > 0.5,
            },
        ];
    }
    getActiveAlerts() {
        return this.alerts;
    }
    resolveAlert(alertId) {
        const index = this.alerts.findIndex((a) => a.id === alertId);
        if (index !== -1) {
            this.alerts.splice(index, 1);
            return true;
        }
        return false;
    }
    isPerformanceHealthy() {
        const criticalAlerts = this.alerts.filter((a) => a.severity === "critical");
        return criticalAlerts.length === 0;
    }
    getPerformanceSummary() {
        const globalMetrics = this.getGlobalMetrics();
        const providers = new Set(Array.from(this.requests.values()).map((r) => r.response.provider));
        const criticalAlerts = this.alerts.filter((a) => a.severity === "critical");
        const violatedSLOs = this.slos.filter((s) => s.violated).length;
        const sloCompliance = 1 - violatedSLOs / this.slos.length;
        return {
            healthy: this.isPerformanceHealthy(),
            globalMetrics,
            providerCount: providers.size,
            activeAlerts: this.alerts.length,
            criticalAlerts: criticalAlerts.length,
            sloCompliance,
        };
    }
    reset() {
        this.requests.clear();
        this.alerts = [];
        this.slos.forEach((slo) => {
            slo.currentValue = 0;
            slo.violated = false;
        });
    }
    calculatePercentile(sortedValues, percentile) {
        if (sortedValues.length === 0)
            return 0;
        const index = Math.ceil(sortedValues.length * percentile) - 1;
        return sortedValues[Math.max(0, index)];
    }
    updateSLOs() {
        const metrics = this.getGlobalMetrics();
        if (!metrics)
            return;
        // Update P95 Latency SLO
        const p95Slo = this.slos.find((s) => s.name === "P95 Latency");
        if (p95Slo) {
            p95Slo.currentValue = metrics.p95Latency;
            p95Slo.violated = metrics.p95Latency > p95Slo.threshold;
        }
        // Update Error Rate SLO
        const errorSlo = this.slos.find((s) => s.name === "Error Rate");
        if (errorSlo) {
            errorSlo.currentValue = metrics.errorRate;
            errorSlo.violated = metrics.errorRate > errorSlo.threshold;
        }
        // Update Availability SLO
        const availabilitySlo = this.slos.find((s) => s.name === "Availability");
        if (availabilitySlo) {
            const availability = metrics.successCount / metrics.requestCount;
            availabilitySlo.currentValue = availability;
            availabilitySlo.violated = availability < availabilitySlo.threshold;
        }
    }
    checkAlerts() {
        this.slos.forEach((slo) => {
            if (slo.violated) {
                const existingAlert = this.alerts.find((a) => a.slo.name === slo.name);
                if (!existingAlert) {
                    const severity = this.determineSeverity(slo);
                    this.alerts.push({
                        id: `alert-${Date.now()}-${Math.random()
                            .toString(36)
                            .substr(2, 9)}`,
                        slo: { ...slo },
                        currentValue: slo.currentValue,
                        threshold: slo.threshold,
                        severity,
                        timestamp: new Date(),
                    });
                }
            }
        });
    }
    determineSeverity(slo) {
        const ratio = slo.currentValue / slo.threshold;
        if (slo.name === "P95 Latency") {
            return ratio > 2 ? "critical" : "warning";
        }
        if (slo.name === "Error Rate") {
            return ratio > 10 ? "critical" : "warning";
        }
        if (slo.name === "Availability") {
            return slo.currentValue < 0.95 ? "critical" : "warning";
        }
        return "warning";
    }
}
exports.PerformanceMonitor = PerformanceMonitor;
function createPerformanceMonitor() {
    return new PerformanceMonitor();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hdGJha2gtdmlzaWJpbGl0eS1ib29zdC4yMDI1MDkyMC9zcmMvbGliL2FpLW9yY2hlc3RyYXRvci9wZXJmb3JtYW5jZS1tb25pdG9yLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7QUE2UUgsNERBRUM7QUF2TkQsTUFBYSxrQkFBa0I7SUFDckIsUUFBUSxHQUErQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2pELE1BQU0sR0FBWSxFQUFFLENBQUM7SUFDckIsSUFBSSxHQUFVO1FBQ3BCLEVBQUUsSUFBSSxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRTtRQUMxRSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUU7UUFDekUsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFO0tBQzVFLENBQUM7SUFFRixrQkFBa0IsQ0FBQyxPQUFrQjtRQUNuQyxNQUFNLFNBQVMsR0FBRyxPQUFPLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO2FBQ2pELFFBQVEsQ0FBQyxFQUFFLENBQUM7YUFDWixNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDbEIsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVELHFCQUFxQixDQUNuQixTQUFpQixFQUNqQixPQUFrQixFQUNsQixRQUFvQixFQUNwQixTQUFpQjtRQUVqQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDM0IsTUFBTSxPQUFPLEdBQUcsT0FBTyxHQUFHLFNBQVMsQ0FBQztRQUVwQyxNQUFNLE1BQU0sR0FBa0I7WUFDNUIsU0FBUztZQUNULE9BQU87WUFDUCxRQUFRO1lBQ1IsU0FBUztZQUNULE9BQU87WUFDUCxPQUFPO1NBQ1IsQ0FBQztRQUVGLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxnQkFBZ0I7UUFDZCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLENBQUM7WUFBRSxPQUFPLElBQUksQ0FBQztRQUUxQyxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUNuRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUN0RSxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ3JFLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEUsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFM0QsT0FBTztZQUNMLFlBQVksRUFBRSxPQUFPLENBQUMsTUFBTTtZQUM1QixZQUFZO1lBQ1osVUFBVTtZQUNWLFNBQVMsRUFBRSxVQUFVLEdBQUcsT0FBTyxDQUFDLE1BQU07WUFDdEMsY0FBYyxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNO1lBQ3ZFLFVBQVUsRUFBRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQztZQUNyRCxVQUFVLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUM7WUFDckQsU0FBUyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMzQyxjQUFjLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU07U0FDbEUsQ0FBQztJQUNKLENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxRQUFnQjtRQUNqQyxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQ3ZELENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsS0FBSyxRQUFRLENBQ3hDLENBQUM7UUFFRixJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQztZQUFFLE9BQU8sRUFBRSxDQUFDO1FBRXBDLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ3RFLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDckUsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN0RSxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUUzRCxPQUFPO1lBQ0w7Z0JBQ0UsUUFBUTtnQkFDUixZQUFZLEVBQUUsT0FBTyxDQUFDLE1BQU07Z0JBQzVCLFlBQVk7Z0JBQ1osVUFBVTtnQkFDVixTQUFTLEVBQUUsVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNO2dCQUN0QyxjQUFjLEVBQUUsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU07Z0JBQ3ZFLFVBQVUsRUFBRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQztnQkFDckQsVUFBVSxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDO2dCQUNyRCxTQUFTLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUMzQyxjQUFjLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU07Z0JBQ2pFLFlBQVksRUFBRSxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU07Z0JBQzNDLGtCQUFrQixFQUFFLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxHQUFHLEdBQUc7YUFDdEQ7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELGVBQWU7UUFDYixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDckIsQ0FBQztJQUVELFlBQVksQ0FBQyxPQUFlO1FBQzFCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLE9BQU8sQ0FBQyxDQUFDO1FBQzdELElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDakIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzdCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELG9CQUFvQjtRQUNsQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsS0FBSyxVQUFVLENBQUMsQ0FBQztRQUM1RSxPQUFPLGNBQWMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCxxQkFBcUI7UUFDbkIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDOUMsTUFBTSxTQUFTLEdBQUcsSUFBSSxHQUFHLENBQ3ZCLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FDbkUsQ0FBQztRQUNGLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxLQUFLLFVBQVUsQ0FBQyxDQUFDO1FBQzVFLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2hFLE1BQU0sYUFBYSxHQUFHLENBQUMsR0FBRyxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7UUFFMUQsT0FBTztZQUNMLE9BQU8sRUFBRSxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDcEMsYUFBYTtZQUNiLGFBQWEsRUFBRSxTQUFTLENBQUMsSUFBSTtZQUM3QixZQUFZLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNO1lBQ2hDLGNBQWMsRUFBRSxjQUFjLENBQUMsTUFBTTtZQUNyQyxhQUFhO1NBQ2QsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLO1FBQ0gsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ3hCLEdBQUcsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1lBQ3JCLEdBQUcsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLG1CQUFtQixDQUN6QixZQUFzQixFQUN0QixVQUFrQjtRQUVsQixJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQztZQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDOUQsT0FBTyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRU8sVUFBVTtRQUNoQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QyxJQUFJLENBQUMsT0FBTztZQUFFLE9BQU87UUFFckIseUJBQXlCO1FBQ3pCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLGFBQWEsQ0FBQyxDQUFDO1FBQy9ELElBQUksTUFBTSxFQUFFLENBQUM7WUFDWCxNQUFNLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUM7WUFDekMsTUFBTSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUM7UUFDMUQsQ0FBQztRQUVELHdCQUF3QjtRQUN4QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxZQUFZLENBQUMsQ0FBQztRQUNoRSxJQUFJLFFBQVEsRUFBRSxDQUFDO1lBQ2IsUUFBUSxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDO1lBQzFDLFFBQVEsQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDO1FBQzdELENBQUM7UUFFRCwwQkFBMEI7UUFDMUIsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssY0FBYyxDQUFDLENBQUM7UUFDekUsSUFBSSxlQUFlLEVBQUUsQ0FBQztZQUNwQixNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7WUFDakUsZUFBZSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7WUFDNUMsZUFBZSxDQUFDLFFBQVEsR0FBRyxZQUFZLEdBQUcsZUFBZSxDQUFDLFNBQVMsQ0FBQztRQUN0RSxDQUFDO0lBQ0gsQ0FBQztJQUVPLFdBQVc7UUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN4QixJQUFJLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDakIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDdkUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO29CQUNuQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQzdDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO3dCQUNmLEVBQUUsRUFBRSxTQUFTLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFOzZCQUNyQyxRQUFRLENBQUMsRUFBRSxDQUFDOzZCQUNaLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUU7d0JBQ2pCLEdBQUcsRUFBRSxFQUFFLEdBQUcsR0FBRyxFQUFFO3dCQUNmLFlBQVksRUFBRSxHQUFHLENBQUMsWUFBWTt3QkFDOUIsU0FBUyxFQUFFLEdBQUcsQ0FBQyxTQUFTO3dCQUN4QixRQUFRO3dCQUNSLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtxQkFDdEIsQ0FBQyxDQUFDO2dCQUNMLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8saUJBQWlCLENBQUMsR0FBUTtRQUNoQyxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUM7UUFFL0MsSUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLGFBQWEsRUFBRSxDQUFDO1lBQy9CLE9BQU8sS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDNUMsQ0FBQztRQUVELElBQUksR0FBRyxDQUFDLElBQUksS0FBSyxZQUFZLEVBQUUsQ0FBQztZQUM5QixPQUFPLEtBQUssR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQzdDLENBQUM7UUFFRCxJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssY0FBYyxFQUFFLENBQUM7WUFDaEMsT0FBTyxHQUFHLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDMUQsQ0FBQztRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQW5ORCxnREFtTkM7QUFFRCxTQUFnQix3QkFBd0I7SUFDdEMsT0FBTyxJQUFJLGtCQUFrQixFQUFFLENBQUM7QUFDbEMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvbWF0YmFraC12aXNpYmlsaXR5LWJvb3N0LjIwMjUwOTIwL3NyYy9saWIvYWktb3JjaGVzdHJhdG9yL3BlcmZvcm1hbmNlLW1vbml0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQZXJmb3JtYW5jZSBNb25pdG9yXG4gKlxuICogVHJhY2tzIHBlcmZvcm1hbmNlIG1ldHJpY3MsIFNMTyBjb21wbGlhbmNlLCBhbmQgYXV0b21hdGVkIHJvbGxiYWNrIHRyaWdnZXJzXG4gKi9cblxuaW1wb3J0IHsgQWlSZXF1ZXN0LCBBaVJlc3BvbnNlIH0gZnJvbSBcIi4vdHlwZXNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBQZXJmb3JtYW5jZU1ldHJpY3Mge1xuICByZXF1ZXN0Q291bnQ6IG51bWJlcjtcbiAgc3VjY2Vzc0NvdW50OiBudW1iZXI7XG4gIGVycm9yQ291bnQ6IG51bWJlcjtcbiAgZXJyb3JSYXRlOiBudW1iZXI7XG4gIGF2ZXJhZ2VMYXRlbmN5OiBudW1iZXI7XG4gIHA5NUxhdGVuY3k6IG51bWJlcjtcbiAgcDk5TGF0ZW5jeTogbnVtYmVyO1xuICB0b3RhbENvc3Q6IG51bWJlcjtcbiAgY29zdFBlclJlcXVlc3Q6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcm92aWRlck1ldHJpY3MgZXh0ZW5kcyBQZXJmb3JtYW5jZU1ldHJpY3Mge1xuICBwcm92aWRlcjogc3RyaW5nO1xuICBhdmFpbGFiaWxpdHk6IG51bWJlcjtcbiAgY2lyY3VpdEJyZWFrZXJPcGVuOiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNMTyB7XG4gIG5hbWU6IHN0cmluZztcbiAgdGhyZXNob2xkOiBudW1iZXI7XG4gIGN1cnJlbnRWYWx1ZTogbnVtYmVyO1xuICB2aW9sYXRlZDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBbGVydCB7XG4gIGlkOiBzdHJpbmc7XG4gIHNsbzogU0xPO1xuICBjdXJyZW50VmFsdWU6IG51bWJlcjtcbiAgdGhyZXNob2xkOiBudW1iZXI7XG4gIHNldmVyaXR5OiBcIndhcm5pbmdcIiB8IFwiY3JpdGljYWxcIjtcbiAgdGltZXN0YW1wOiBEYXRlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBlcmZvcm1hbmNlU3VtbWFyeSB7XG4gIGhlYWx0aHk6IGJvb2xlYW47XG4gIGdsb2JhbE1ldHJpY3M6IFBlcmZvcm1hbmNlTWV0cmljcyB8IG51bGw7XG4gIHByb3ZpZGVyQ291bnQ6IG51bWJlcjtcbiAgYWN0aXZlQWxlcnRzOiBudW1iZXI7XG4gIGNyaXRpY2FsQWxlcnRzOiBudW1iZXI7XG4gIHNsb0NvbXBsaWFuY2U6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIFJlcXVlc3RSZWNvcmQge1xuICByZXF1ZXN0SWQ6IHN0cmluZztcbiAgcmVxdWVzdDogQWlSZXF1ZXN0O1xuICByZXNwb25zZTogQWlSZXNwb25zZTtcbiAgc3RhcnRUaW1lOiBudW1iZXI7XG4gIGVuZFRpbWU6IG51bWJlcjtcbiAgbGF0ZW5jeTogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgUGVyZm9ybWFuY2VNb25pdG9yIHtcbiAgcHJpdmF0ZSByZXF1ZXN0czogTWFwPHN0cmluZywgUmVxdWVzdFJlY29yZD4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgYWxlcnRzOiBBbGVydFtdID0gW107XG4gIHByaXZhdGUgc2xvczogU0xPW10gPSBbXG4gICAgeyBuYW1lOiBcIlA5NSBMYXRlbmN5XCIsIHRocmVzaG9sZDogMTUwMCwgY3VycmVudFZhbHVlOiAwLCB2aW9sYXRlZDogZmFsc2UgfSxcbiAgICB7IG5hbWU6IFwiRXJyb3IgUmF0ZVwiLCB0aHJlc2hvbGQ6IDAuMDEsIGN1cnJlbnRWYWx1ZTogMCwgdmlvbGF0ZWQ6IGZhbHNlIH0sXG4gICAgeyBuYW1lOiBcIkF2YWlsYWJpbGl0eVwiLCB0aHJlc2hvbGQ6IDAuOTksIGN1cnJlbnRWYWx1ZTogMSwgdmlvbGF0ZWQ6IGZhbHNlIH0sXG4gIF07XG5cbiAgcmVjb3JkUmVxdWVzdFN0YXJ0KHJlcXVlc3Q6IEFpUmVxdWVzdCk6IHN0cmluZyB7XG4gICAgY29uc3QgcmVxdWVzdElkID0gYHJlcS0ke0RhdGUubm93KCl9LSR7TWF0aC5yYW5kb20oKVxuICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgLnN1YnN0cigyLCA5KX1gO1xuICAgIHJldHVybiByZXF1ZXN0SWQ7XG4gIH1cblxuICByZWNvcmRSZXF1ZXN0Q29tcGxldGUoXG4gICAgcmVxdWVzdElkOiBzdHJpbmcsXG4gICAgcmVxdWVzdDogQWlSZXF1ZXN0LFxuICAgIHJlc3BvbnNlOiBBaVJlc3BvbnNlLFxuICAgIHN0YXJ0VGltZTogbnVtYmVyXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGxhdGVuY3kgPSBlbmRUaW1lIC0gc3RhcnRUaW1lO1xuXG4gICAgY29uc3QgcmVjb3JkOiBSZXF1ZXN0UmVjb3JkID0ge1xuICAgICAgcmVxdWVzdElkLFxuICAgICAgcmVxdWVzdCxcbiAgICAgIHJlc3BvbnNlLFxuICAgICAgc3RhcnRUaW1lLFxuICAgICAgZW5kVGltZSxcbiAgICAgIGxhdGVuY3ksXG4gICAgfTtcblxuICAgIHRoaXMucmVxdWVzdHMuc2V0KHJlcXVlc3RJZCwgcmVjb3JkKTtcbiAgICB0aGlzLnVwZGF0ZVNMT3MoKTtcbiAgICB0aGlzLmNoZWNrQWxlcnRzKCk7XG4gIH1cblxuICBnZXRHbG9iYWxNZXRyaWNzKCk6IFBlcmZvcm1hbmNlTWV0cmljcyB8IG51bGwge1xuICAgIGlmICh0aGlzLnJlcXVlc3RzLnNpemUgPT09IDApIHJldHVybiBudWxsO1xuXG4gICAgY29uc3QgcmVjb3JkcyA9IEFycmF5LmZyb20odGhpcy5yZXF1ZXN0cy52YWx1ZXMoKSk7XG4gICAgY29uc3Qgc3VjY2Vzc0NvdW50ID0gcmVjb3Jkcy5maWx0ZXIoKHIpID0+IHIucmVzcG9uc2Uuc3VjY2VzcykubGVuZ3RoO1xuICAgIGNvbnN0IGVycm9yQ291bnQgPSByZWNvcmRzLmZpbHRlcigocikgPT4gIXIucmVzcG9uc2Uuc3VjY2VzcykubGVuZ3RoO1xuICAgIGNvbnN0IGxhdGVuY2llcyA9IHJlY29yZHMubWFwKChyKSA9PiByLmxhdGVuY3kpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTtcbiAgICBjb25zdCBjb3N0cyA9IHJlY29yZHMubWFwKChyKSA9PiByLnJlc3BvbnNlLmNvc3RFdXJvIHx8IDApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJlcXVlc3RDb3VudDogcmVjb3Jkcy5sZW5ndGgsXG4gICAgICBzdWNjZXNzQ291bnQsXG4gICAgICBlcnJvckNvdW50LFxuICAgICAgZXJyb3JSYXRlOiBlcnJvckNvdW50IC8gcmVjb3Jkcy5sZW5ndGgsXG4gICAgICBhdmVyYWdlTGF0ZW5jeTogbGF0ZW5jaWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gbGF0ZW5jaWVzLmxlbmd0aCxcbiAgICAgIHA5NUxhdGVuY3k6IHRoaXMuY2FsY3VsYXRlUGVyY2VudGlsZShsYXRlbmNpZXMsIDAuOTUpLFxuICAgICAgcDk5TGF0ZW5jeTogdGhpcy5jYWxjdWxhdGVQZXJjZW50aWxlKGxhdGVuY2llcywgMC45OSksXG4gICAgICB0b3RhbENvc3Q6IGNvc3RzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApLFxuICAgICAgY29zdFBlclJlcXVlc3Q6IGNvc3RzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gcmVjb3Jkcy5sZW5ndGgsXG4gICAgfTtcbiAgfVxuXG4gIGdldFByb3ZpZGVyTWV0cmljcyhwcm92aWRlcjogc3RyaW5nKTogUHJvdmlkZXJNZXRyaWNzW10ge1xuICAgIGNvbnN0IHJlY29yZHMgPSBBcnJheS5mcm9tKHRoaXMucmVxdWVzdHMudmFsdWVzKCkpLmZpbHRlcihcbiAgICAgIChyKSA9PiByLnJlc3BvbnNlLnByb3ZpZGVyID09PSBwcm92aWRlclxuICAgICk7XG5cbiAgICBpZiAocmVjb3Jkcy5sZW5ndGggPT09IDApIHJldHVybiBbXTtcblxuICAgIGNvbnN0IHN1Y2Nlc3NDb3VudCA9IHJlY29yZHMuZmlsdGVyKChyKSA9PiByLnJlc3BvbnNlLnN1Y2Nlc3MpLmxlbmd0aDtcbiAgICBjb25zdCBlcnJvckNvdW50ID0gcmVjb3Jkcy5maWx0ZXIoKHIpID0+ICFyLnJlc3BvbnNlLnN1Y2Nlc3MpLmxlbmd0aDtcbiAgICBjb25zdCBsYXRlbmNpZXMgPSByZWNvcmRzLm1hcCgocikgPT4gci5sYXRlbmN5KS5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gICAgY29uc3QgY29zdHMgPSByZWNvcmRzLm1hcCgocikgPT4gci5yZXNwb25zZS5jb3N0RXVybyB8fCAwKTtcblxuICAgIHJldHVybiBbXG4gICAgICB7XG4gICAgICAgIHByb3ZpZGVyLFxuICAgICAgICByZXF1ZXN0Q291bnQ6IHJlY29yZHMubGVuZ3RoLFxuICAgICAgICBzdWNjZXNzQ291bnQsXG4gICAgICAgIGVycm9yQ291bnQsXG4gICAgICAgIGVycm9yUmF0ZTogZXJyb3JDb3VudCAvIHJlY29yZHMubGVuZ3RoLFxuICAgICAgICBhdmVyYWdlTGF0ZW5jeTogbGF0ZW5jaWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gbGF0ZW5jaWVzLmxlbmd0aCxcbiAgICAgICAgcDk1TGF0ZW5jeTogdGhpcy5jYWxjdWxhdGVQZXJjZW50aWxlKGxhdGVuY2llcywgMC45NSksXG4gICAgICAgIHA5OUxhdGVuY3k6IHRoaXMuY2FsY3VsYXRlUGVyY2VudGlsZShsYXRlbmNpZXMsIDAuOTkpLFxuICAgICAgICB0b3RhbENvc3Q6IGNvc3RzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApLFxuICAgICAgICBjb3N0UGVyUmVxdWVzdDogY29zdHMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyByZWNvcmRzLmxlbmd0aCxcbiAgICAgICAgYXZhaWxhYmlsaXR5OiBzdWNjZXNzQ291bnQgLyByZWNvcmRzLmxlbmd0aCxcbiAgICAgICAgY2lyY3VpdEJyZWFrZXJPcGVuOiBlcnJvckNvdW50IC8gcmVjb3Jkcy5sZW5ndGggPiAwLjUsXG4gICAgICB9LFxuICAgIF07XG4gIH1cblxuICBnZXRBY3RpdmVBbGVydHMoKTogQWxlcnRbXSB7XG4gICAgcmV0dXJuIHRoaXMuYWxlcnRzO1xuICB9XG5cbiAgcmVzb2x2ZUFsZXJ0KGFsZXJ0SWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5hbGVydHMuZmluZEluZGV4KChhKSA9PiBhLmlkID09PSBhbGVydElkKTtcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICB0aGlzLmFsZXJ0cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGlzUGVyZm9ybWFuY2VIZWFsdGh5KCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNyaXRpY2FsQWxlcnRzID0gdGhpcy5hbGVydHMuZmlsdGVyKChhKSA9PiBhLnNldmVyaXR5ID09PSBcImNyaXRpY2FsXCIpO1xuICAgIHJldHVybiBjcml0aWNhbEFsZXJ0cy5sZW5ndGggPT09IDA7XG4gIH1cblxuICBnZXRQZXJmb3JtYW5jZVN1bW1hcnkoKTogUGVyZm9ybWFuY2VTdW1tYXJ5IHtcbiAgICBjb25zdCBnbG9iYWxNZXRyaWNzID0gdGhpcy5nZXRHbG9iYWxNZXRyaWNzKCk7XG4gICAgY29uc3QgcHJvdmlkZXJzID0gbmV3IFNldChcbiAgICAgIEFycmF5LmZyb20odGhpcy5yZXF1ZXN0cy52YWx1ZXMoKSkubWFwKChyKSA9PiByLnJlc3BvbnNlLnByb3ZpZGVyKVxuICAgICk7XG4gICAgY29uc3QgY3JpdGljYWxBbGVydHMgPSB0aGlzLmFsZXJ0cy5maWx0ZXIoKGEpID0+IGEuc2V2ZXJpdHkgPT09IFwiY3JpdGljYWxcIik7XG4gICAgY29uc3QgdmlvbGF0ZWRTTE9zID0gdGhpcy5zbG9zLmZpbHRlcigocykgPT4gcy52aW9sYXRlZCkubGVuZ3RoO1xuICAgIGNvbnN0IHNsb0NvbXBsaWFuY2UgPSAxIC0gdmlvbGF0ZWRTTE9zIC8gdGhpcy5zbG9zLmxlbmd0aDtcblxuICAgIHJldHVybiB7XG4gICAgICBoZWFsdGh5OiB0aGlzLmlzUGVyZm9ybWFuY2VIZWFsdGh5KCksXG4gICAgICBnbG9iYWxNZXRyaWNzLFxuICAgICAgcHJvdmlkZXJDb3VudDogcHJvdmlkZXJzLnNpemUsXG4gICAgICBhY3RpdmVBbGVydHM6IHRoaXMuYWxlcnRzLmxlbmd0aCxcbiAgICAgIGNyaXRpY2FsQWxlcnRzOiBjcml0aWNhbEFsZXJ0cy5sZW5ndGgsXG4gICAgICBzbG9Db21wbGlhbmNlLFxuICAgIH07XG4gIH1cblxuICByZXNldCgpOiB2b2lkIHtcbiAgICB0aGlzLnJlcXVlc3RzLmNsZWFyKCk7XG4gICAgdGhpcy5hbGVydHMgPSBbXTtcbiAgICB0aGlzLnNsb3MuZm9yRWFjaCgoc2xvKSA9PiB7XG4gICAgICBzbG8uY3VycmVudFZhbHVlID0gMDtcbiAgICAgIHNsby52aW9sYXRlZCA9IGZhbHNlO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVQZXJjZW50aWxlKFxuICAgIHNvcnRlZFZhbHVlczogbnVtYmVyW10sXG4gICAgcGVyY2VudGlsZTogbnVtYmVyXG4gICk6IG51bWJlciB7XG4gICAgaWYgKHNvcnRlZFZhbHVlcy5sZW5ndGggPT09IDApIHJldHVybiAwO1xuICAgIGNvbnN0IGluZGV4ID0gTWF0aC5jZWlsKHNvcnRlZFZhbHVlcy5sZW5ndGggKiBwZXJjZW50aWxlKSAtIDE7XG4gICAgcmV0dXJuIHNvcnRlZFZhbHVlc1tNYXRoLm1heCgwLCBpbmRleCldO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTTE9zKCk6IHZvaWQge1xuICAgIGNvbnN0IG1ldHJpY3MgPSB0aGlzLmdldEdsb2JhbE1ldHJpY3MoKTtcbiAgICBpZiAoIW1ldHJpY3MpIHJldHVybjtcblxuICAgIC8vIFVwZGF0ZSBQOTUgTGF0ZW5jeSBTTE9cbiAgICBjb25zdCBwOTVTbG8gPSB0aGlzLnNsb3MuZmluZCgocykgPT4gcy5uYW1lID09PSBcIlA5NSBMYXRlbmN5XCIpO1xuICAgIGlmIChwOTVTbG8pIHtcbiAgICAgIHA5NVNsby5jdXJyZW50VmFsdWUgPSBtZXRyaWNzLnA5NUxhdGVuY3k7XG4gICAgICBwOTVTbG8udmlvbGF0ZWQgPSBtZXRyaWNzLnA5NUxhdGVuY3kgPiBwOTVTbG8udGhyZXNob2xkO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBFcnJvciBSYXRlIFNMT1xuICAgIGNvbnN0IGVycm9yU2xvID0gdGhpcy5zbG9zLmZpbmQoKHMpID0+IHMubmFtZSA9PT0gXCJFcnJvciBSYXRlXCIpO1xuICAgIGlmIChlcnJvclNsbykge1xuICAgICAgZXJyb3JTbG8uY3VycmVudFZhbHVlID0gbWV0cmljcy5lcnJvclJhdGU7XG4gICAgICBlcnJvclNsby52aW9sYXRlZCA9IG1ldHJpY3MuZXJyb3JSYXRlID4gZXJyb3JTbG8udGhyZXNob2xkO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBBdmFpbGFiaWxpdHkgU0xPXG4gICAgY29uc3QgYXZhaWxhYmlsaXR5U2xvID0gdGhpcy5zbG9zLmZpbmQoKHMpID0+IHMubmFtZSA9PT0gXCJBdmFpbGFiaWxpdHlcIik7XG4gICAgaWYgKGF2YWlsYWJpbGl0eVNsbykge1xuICAgICAgY29uc3QgYXZhaWxhYmlsaXR5ID0gbWV0cmljcy5zdWNjZXNzQ291bnQgLyBtZXRyaWNzLnJlcXVlc3RDb3VudDtcbiAgICAgIGF2YWlsYWJpbGl0eVNsby5jdXJyZW50VmFsdWUgPSBhdmFpbGFiaWxpdHk7XG4gICAgICBhdmFpbGFiaWxpdHlTbG8udmlvbGF0ZWQgPSBhdmFpbGFiaWxpdHkgPCBhdmFpbGFiaWxpdHlTbG8udGhyZXNob2xkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tBbGVydHMoKTogdm9pZCB7XG4gICAgdGhpcy5zbG9zLmZvckVhY2goKHNsbykgPT4ge1xuICAgICAgaWYgKHNsby52aW9sYXRlZCkge1xuICAgICAgICBjb25zdCBleGlzdGluZ0FsZXJ0ID0gdGhpcy5hbGVydHMuZmluZCgoYSkgPT4gYS5zbG8ubmFtZSA9PT0gc2xvLm5hbWUpO1xuICAgICAgICBpZiAoIWV4aXN0aW5nQWxlcnQpIHtcbiAgICAgICAgICBjb25zdCBzZXZlcml0eSA9IHRoaXMuZGV0ZXJtaW5lU2V2ZXJpdHkoc2xvKTtcbiAgICAgICAgICB0aGlzLmFsZXJ0cy5wdXNoKHtcbiAgICAgICAgICAgIGlkOiBgYWxlcnQtJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKClcbiAgICAgICAgICAgICAgLnRvU3RyaW5nKDM2KVxuICAgICAgICAgICAgICAuc3Vic3RyKDIsIDkpfWAsXG4gICAgICAgICAgICBzbG86IHsgLi4uc2xvIH0sXG4gICAgICAgICAgICBjdXJyZW50VmFsdWU6IHNsby5jdXJyZW50VmFsdWUsXG4gICAgICAgICAgICB0aHJlc2hvbGQ6IHNsby50aHJlc2hvbGQsXG4gICAgICAgICAgICBzZXZlcml0eSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXRlcm1pbmVTZXZlcml0eShzbG86IFNMTyk6IFwid2FybmluZ1wiIHwgXCJjcml0aWNhbFwiIHtcbiAgICBjb25zdCByYXRpbyA9IHNsby5jdXJyZW50VmFsdWUgLyBzbG8udGhyZXNob2xkO1xuXG4gICAgaWYgKHNsby5uYW1lID09PSBcIlA5NSBMYXRlbmN5XCIpIHtcbiAgICAgIHJldHVybiByYXRpbyA+IDIgPyBcImNyaXRpY2FsXCIgOiBcIndhcm5pbmdcIjtcbiAgICB9XG5cbiAgICBpZiAoc2xvLm5hbWUgPT09IFwiRXJyb3IgUmF0ZVwiKSB7XG4gICAgICByZXR1cm4gcmF0aW8gPiAxMCA/IFwiY3JpdGljYWxcIiA6IFwid2FybmluZ1wiO1xuICAgIH1cblxuICAgIGlmIChzbG8ubmFtZSA9PT0gXCJBdmFpbGFiaWxpdHlcIikge1xuICAgICAgcmV0dXJuIHNsby5jdXJyZW50VmFsdWUgPCAwLjk1ID8gXCJjcml0aWNhbFwiIDogXCJ3YXJuaW5nXCI7XG4gICAgfVxuXG4gICAgcmV0dXJuIFwid2FybmluZ1wiO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVQZXJmb3JtYW5jZU1vbml0b3IoKTogUGVyZm9ybWFuY2VNb25pdG9yIHtcbiAgcmV0dXJuIG5ldyBQZXJmb3JtYW5jZU1vbml0b3IoKTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==