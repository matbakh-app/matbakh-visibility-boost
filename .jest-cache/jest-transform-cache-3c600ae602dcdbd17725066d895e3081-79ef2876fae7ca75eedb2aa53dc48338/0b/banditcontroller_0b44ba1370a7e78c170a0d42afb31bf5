e9335a876ca5a49583cc72ffe6dd16c2
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BanditLogger = exports.ThompsonBandit = void 0;
const client_evidently_1 = require("@aws-sdk/client-evidently");
const crypto_1 = require("crypto");
class ThompsonBandit {
    arms = {
        bedrock: { wins: 0, trials: 0, costEuro: 0, totalLatencyMs: 0 },
        google: { wins: 0, trials: 0, costEuro: 0, totalLatencyMs: 0 },
        meta: { wins: 0, trials: 0, costEuro: 0, totalLatencyMs: 0 },
    };
    // Contextual bandit - different arms for different contexts
    contextualArms = new Map();
    choose(context) {
        const contextKey = this.getContextKey(context);
        const arms = this.getArmsForContext(contextKey);
        const sampleBeta = (alpha, beta) => {
            // Simple Beta(α, β) sampler via mean approximation for brevity
            // In production, use proper Beta distribution sampling
            if (alpha + beta === 0)
                return Math.random();
            return alpha / (alpha + beta) + (Math.random() - 0.5) * 0.1;
        };
        let best = 'bedrock';
        let bestScore = -1;
        Object.keys(arms).forEach(arm => {
            const stats = arms[arm];
            // Thompson Sampling with Beta distribution
            const alpha = 1 + stats.wins;
            const beta = 1 + (stats.trials - stats.wins);
            let score = sampleBeta(alpha, beta);
            // Adjust score based on context preferences
            score = this.adjustScoreForContext(score, arm, context);
            if (score > bestScore) {
                bestScore = score;
                best = arm;
            }
        });
        return best;
    }
    record(arm, win, costEuro, latencyMs, context) {
        const contextKey = this.getContextKey(context);
        const arms = this.getArmsForContext(contextKey);
        const stats = arms[arm];
        stats.trials += 1;
        stats.wins += win ? 1 : 0;
        stats.costEuro += costEuro;
        stats.totalLatencyMs += latencyMs;
        // Also update global stats
        const globalStats = this.arms[arm];
        globalStats.trials += 1;
        globalStats.wins += win ? 1 : 0;
        globalStats.costEuro += costEuro;
        globalStats.totalLatencyMs += latencyMs;
    }
    getStats(context) {
        const contextKey = this.getContextKey(context);
        const arms = this.getArmsForContext(contextKey);
        const result = {};
        Object.keys(arms).forEach(arm => {
            const stats = arms[arm];
            result[arm] = {
                ...stats,
                winRate: stats.trials > 0 ? stats.wins / stats.trials : 0,
                avgLatency: stats.trials > 0 ? stats.totalLatencyMs / stats.trials : 0,
                avgCost: stats.trials > 0 ? stats.costEuro / stats.trials : 0,
            };
        });
        return result;
    }
    getContextKey(context) {
        if (!context)
            return 'global';
        const parts = [
            context.domain || 'general',
            context.budgetTier || 'standard',
            context.requireTools ? 'tools' : 'no-tools'
        ];
        return parts.join('|');
    }
    getArmsForContext(contextKey) {
        if (!this.contextualArms.has(contextKey)) {
            this.contextualArms.set(contextKey, {
                bedrock: { wins: 0, trials: 0, costEuro: 0, totalLatencyMs: 0 },
                google: { wins: 0, trials: 0, costEuro: 0, totalLatencyMs: 0 },
                meta: { wins: 0, trials: 0, costEuro: 0, totalLatencyMs: 0 },
            });
        }
        return this.contextualArms.get(contextKey);
    }
    adjustScoreForContext(score, arm, context) {
        if (!context)
            return score;
        // Domain-specific adjustments
        if (context.domain === 'legal' && arm === 'bedrock') {
            score += 0.1; // Prefer Claude for legal
        }
        if (context.domain === 'culinary' && arm === 'google') {
            score += 0.05; // Slight preference for Gemini in culinary
        }
        if (context.domain === 'medical' && arm !== 'bedrock') {
            score -= 0.2; // Strong preference for Claude in medical
        }
        // Budget tier adjustments
        if (context.budgetTier === 'low' && arm === 'meta') {
            score += 0.1; // Prefer cheaper models for low budget
        }
        if (context.budgetTier === 'premium' && arm === 'bedrock') {
            score += 0.05; // Slight preference for premium models
        }
        // Tool requirements
        if (context.requireTools && arm === 'meta') {
            score -= 0.3; // Meta doesn't support tools well
        }
        return Math.max(0, Math.min(1, score));
    }
    // Reset stats for a specific context (useful for A/B test resets)
    resetContext(context) {
        const contextKey = this.getContextKey(context);
        this.contextualArms.delete(contextKey);
    }
    // Get the best performing arm for a context
    getBestArm(context) {
        const stats = this.getStats(context);
        let bestArm = 'bedrock';
        let bestWinRate = -1;
        Object.keys(stats).forEach(arm => {
            const armStats = stats[arm];
            if (armStats.trials > 10 && armStats.winRate > bestWinRate) { // Minimum trials for confidence
                bestWinRate = armStats.winRate;
                bestArm = arm;
            }
        });
        const confidence = stats[bestArm].trials > 50 ?
            Math.min(0.95, stats[bestArm].winRate + 0.1) :
            Math.max(0.5, stats[bestArm].winRate);
        return { arm: bestArm, confidence };
    }
}
exports.ThompsonBandit = ThompsonBandit;
class BanditLogger {
    opts;
    client;
    constructor(opts) {
        this.opts = opts;
        this.client = opts.client ?? new client_evidently_1.EvidentlyClient({});
    }
    async logOutcome(params) {
        const { userId, arm, success, latencyMs, costEuro, domain, budgetTier, requireTools, requestId } = params;
        const entityId = userId ?? (0, crypto_1.randomUUID)();
        try {
            await this.client.send(new client_evidently_1.PutProjectEventsCommand({
                project: this.opts.project,
                events: [{
                        timestamp: new Date(),
                        type: 'aws.evidently.custom',
                        data: {
                            // Core metrics
                            model_route: arm,
                            success,
                            latency_ms: latencyMs,
                            cost_euro: costEuro,
                            // Context information
                            domain: domain || 'general',
                            budget_tier: budgetTier || 'standard',
                            require_tools: requireTools || false,
                            // Tracking
                            request_id: requestId || (0, crypto_1.randomUUID)(),
                            timestamp: Date.now(),
                        },
                        entityId,
                    }],
            }));
        }
        catch (error) {
            // Log error but don't throw - logging failures shouldn't break the main flow
            console.error('Failed to log bandit outcome to Evidently:', error);
        }
    }
    async logExperimentEvent(params) {
        const { userId, experimentName, variation, metricName, metricValue, context } = params;
        const entityId = userId ?? (0, crypto_1.randomUUID)();
        try {
            await this.client.send(new client_evidently_1.PutProjectEventsCommand({
                project: this.opts.project,
                events: [{
                        timestamp: new Date(),
                        type: 'aws.evidently.custom',
                        data: {
                            experiment_name: experimentName,
                            variation,
                            metric_name: metricName,
                            metric_value: metricValue,
                            ...context,
                        },
                        entityId,
                    }],
            }));
        }
        catch (error) {
            console.error('Failed to log experiment event to Evidently:', error);
        }
    }
    // Batch logging for better performance
    async logBatch(events) {
        if (events.length === 0)
            return;
        try {
            const evidentlyEvents = events.map(event => ({
                timestamp: new Date(),
                type: 'aws.evidently.custom',
                data: {
                    model_route: event.arm,
                    success: event.success,
                    latency_ms: event.latencyMs,
                    cost_euro: event.costEuro,
                    domain: event.domain || 'general',
                    request_id: event.requestId || (0, crypto_1.randomUUID)(),
                },
                entityId: event.userId ?? (0, crypto_1.randomUUID)(),
            }));
            await this.client.send(new client_evidently_1.PutProjectEventsCommand({
                project: this.opts.project,
                events: evidentlyEvents,
            }));
        }
        catch (error) {
            console.error('Failed to log batch events to Evidently:', error);
        }
    }
}
exports.BanditLogger = BanditLogger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hdGJha2gtdmlzaWJpbGl0eS1ib29zdC4yMDI1MDkyMC9zcmMvbGliL2FpLW9yY2hlc3RyYXRvci9iYW5kaXQtY29udHJvbGxlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxnRUFBcUY7QUFDckYsbUNBQW9DO0FBa0JwQyxNQUFhLGNBQWM7SUFDZixJQUFJLEdBQTBCO1FBQ2xDLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLGNBQWMsRUFBRSxDQUFDLEVBQUU7UUFDL0QsTUFBTSxFQUFFLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsY0FBYyxFQUFFLENBQUMsRUFBRTtRQUM5RCxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxjQUFjLEVBQUUsQ0FBQyxFQUFFO0tBQy9ELENBQUM7SUFFRiw0REFBNEQ7SUFDcEQsY0FBYyxHQUF1QyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRXZFLE1BQU0sQ0FBQyxPQUF1QjtRQUMxQixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9DLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVoRCxNQUFNLFVBQVUsR0FBRyxDQUFDLEtBQWEsRUFBRSxJQUFZLEVBQUUsRUFBRTtZQUMvQywrREFBK0Q7WUFDL0QsdURBQXVEO1lBQ3ZELElBQUksS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDO2dCQUFFLE9BQU8sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzdDLE9BQU8sS0FBSyxHQUFHLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdB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YmlsaXR5LWJvb3N0LjIwMjUwOTIwL3NyYy9saWIvYWktb3JjaGVzdHJhdG9yL2JhbmRpdC1jb250cm9sbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEV2aWRlbnRseUNsaWVudCwgUHV0UHJvamVjdEV2ZW50c0NvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZXZpZGVudGx5JztcbmltcG9ydCB7IHJhbmRvbVVVSUQgfSBmcm9tICdjcnlwdG8nO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFybVN0YXRzIHtcbiAgICB3aW5zOiBudW1iZXI7XG4gICAgdHJpYWxzOiBudW1iZXI7XG4gICAgY29zdEV1cm86IG51bWJlcjtcbiAgICB0b3RhbExhdGVuY3lNczogbnVtYmVyO1xufVxuXG5leHBvcnQgdHlwZSBBcm0gPSAnYmVkcm9jaycgfCAnZ29vZ2xlJyB8ICdtZXRhJztcblxuZXhwb3J0IGludGVyZmFjZSBCYW5kaXRDb250ZXh0IHtcbiAgICBkb21haW4/OiBzdHJpbmc7XG4gICAgYnVkZ2V0VGllcj86IHN0cmluZztcbiAgICByZXF1aXJlVG9vbHM/OiBib29sZWFuO1xuICAgIHVzZXJJZD86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFRob21wc29uQmFuZGl0IHtcbiAgICBwcml2YXRlIGFybXM6IFJlY29yZDxBcm0sIEFybVN0YXRzPiA9IHtcbiAgICAgICAgYmVkcm9jazogeyB3aW5zOiAwLCB0cmlhbHM6IDAsIGNvc3RFdXJvOiAwLCB0b3RhbExhdGVuY3lNczogMCB9LFxuICAgICAgICBnb29nbGU6IHsgd2luczogMCwgdHJpYWxzOiAwLCBjb3N0RXVybzogMCwgdG90YWxMYXRlbmN5TXM6IDAgfSxcbiAgICAgICAgbWV0YTogeyB3aW5zOiAwLCB0cmlhbHM6IDAsIGNvc3RFdXJvOiAwLCB0b3RhbExhdGVuY3lNczogMCB9LFxuICAgIH07XG5cbiAgICAvLyBDb250ZXh0dWFsIGJhbmRpdCAtIGRpZmZlcmVudCBhcm1zIGZvciBkaWZmZXJlbnQgY29udGV4dHNcbiAgICBwcml2YXRlIGNvbnRleHR1YWxBcm1zOiBNYXA8c3RyaW5nLCBSZWNvcmQ8QXJtLCBBcm1TdGF0cz4+ID0gbmV3IE1hcCgpO1xuXG4gICAgY2hvb3NlKGNvbnRleHQ/OiBCYW5kaXRDb250ZXh0KTogQXJtIHtcbiAgICAgICAgY29uc3QgY29udGV4dEtleSA9IHRoaXMuZ2V0Q29udGV4dEtleShjb250ZXh0KTtcbiAgICAgICAgY29uc3QgYXJtcyA9IHRoaXMuZ2V0QXJtc0ZvckNvbnRleHQoY29udGV4dEtleSk7XG5cbiAgICAgICAgY29uc3Qgc2FtcGxlQmV0YSA9IChhbHBoYTogbnVtYmVyLCBiZXRhOiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIC8vIFNpbXBsZSBCZXRhKM6xLCDOsikgc2FtcGxlciB2aWEgbWVhbiBhcHByb3hpbWF0aW9uIGZvciBicmV2aXR5XG4gICAgICAgICAgICAvLyBJbiBwcm9kdWN0aW9uLCB1c2UgcHJvcGVyIEJldGEgZGlzdHJpYnV0aW9uIHNhbXBsaW5nXG4gICAgICAgICAgICBpZiAoYWxwaGEgKyBiZXRhID09PSAwKSByZXR1cm4gTWF0aC5yYW5kb20oKTtcbiAgICAgICAgICAgIHJldHVybiBhbHBoYSAvIChhbHBoYSArIGJldGEpICsgKE1hdGgucmFuZG9tKCkgLSAwLjUpICogMC4xO1xuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBiZXN0OiBBcm0gPSAnYmVkcm9jayc7XG4gICAgICAgIGxldCBiZXN0U2NvcmUgPSAtMTtcblxuICAgICAgICAoT2JqZWN0LmtleXMoYXJtcykgYXMgQXJtW10pLmZvckVhY2goYXJtID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXRzID0gYXJtc1thcm1dO1xuXG4gICAgICAgICAgICAvLyBUaG9tcHNvbiBTYW1wbGluZyB3aXRoIEJldGEgZGlzdHJpYnV0aW9uXG4gICAgICAgICAgICBjb25zdCBhbHBoYSA9IDEgKyBzdGF0cy53aW5zO1xuICAgICAgICAgICAgY29uc3QgYmV0YSA9IDEgKyAoc3RhdHMudHJpYWxzIC0gc3RhdHMud2lucyk7XG4gICAgICAgICAgICBsZXQgc2NvcmUgPSBzYW1wbGVCZXRhKGFscGhhLCBiZXRhKTtcblxuICAgICAgICAgICAgLy8gQWRqdXN0IHNjb3JlIGJhc2VkIG9uIGNvbnRleHQgcHJlZmVyZW5jZXNcbiAgICAgICAgICAgIHNjb3JlID0gdGhpcy5hZGp1c3RTY29yZUZvckNvbnRleHQoc2NvcmUsIGFybSwgY29udGV4dCk7XG5cbiAgICAgICAgICAgIGlmIChzY29yZSA+IGJlc3RTY29yZSkge1xuICAgICAgICAgICAgICAgIGJlc3RTY29yZSA9IHNjb3JlO1xuICAgICAgICAgICAgICAgIGJlc3QgPSBhcm07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBiZXN0O1xuICAgIH1cblxuICAgIHJlY29yZChhcm06IEFybSwgd2luOiBib29sZWFuLCBjb3N0RXVybzogbnVtYmVyLCBsYXRlbmN5TXM6IG51bWJlciwgY29udGV4dD86IEJhbmRpdENvbnRleHQpIHtcbiAgICAgICAgY29uc3QgY29udGV4dEtleSA9IHRoaXMuZ2V0Q29udGV4dEtleShjb250ZXh0KTtcbiAgICAgICAgY29uc3QgYXJtcyA9IHRoaXMuZ2V0QXJtc0ZvckNvbnRleHQoY29udGV4dEtleSk7XG5cbiAgICAgICAgY29uc3Qgc3RhdHMgPSBhcm1zW2FybV07XG4gICAgICAgIHN0YXRzLnRyaWFscyArPSAxO1xuICAgICAgICBzdGF0cy53aW5zICs9IHdpbiA/IDEgOiAwO1xuICAgICAgICBzdGF0cy5jb3N0RXVybyArPSBjb3N0RXVybztcbiAgICAgICAgc3RhdHMudG90YWxMYXRlbmN5TXMgKz0gbGF0ZW5jeU1zO1xuXG4gICAgICAgIC8vIEFsc28gdXBkYXRlIGdsb2JhbCBzdGF0c1xuICAgICAgICBjb25zdCBnbG9iYWxTdGF0cyA9IHRoaXMuYXJtc1thcm1dO1xuICAgICAgICBnbG9iYWxTdGF0cy50cmlhbHMgKz0gMTtcbiAgICAgICAgZ2xvYmFsU3RhdHMud2lucyArPSB3aW4gPyAxIDogMDtcbiAgICAgICAgZ2xvYmFsU3RhdHMuY29zdEV1cm8gKz0gY29zdEV1cm87XG4gICAgICAgIGdsb2JhbFN0YXRzLnRvdGFsTGF0ZW5jeU1zICs9IGxhdGVuY3lNcztcbiAgICB9XG5cbiAgICBnZXRTdGF0cyhjb250ZXh0PzogQmFuZGl0Q29udGV4dCk6IFJlY29yZDxBcm0sIEFybVN0YXRzICYgeyB3aW5SYXRlOiBudW1iZXI7IGF2Z0xhdGVuY3k6IG51bWJlcjsgYXZnQ29zdDogbnVtYmVyIH0+IHtcbiAgICAgICAgY29uc3QgY29udGV4dEtleSA9IHRoaXMuZ2V0Q29udGV4dEtleShjb250ZXh0KTtcbiAgICAgICAgY29uc3QgYXJtcyA9IHRoaXMuZ2V0QXJtc0ZvckNvbnRleHQoY29udGV4dEtleSk7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge30gYXMgYW55O1xuICAgICAgICAoT2JqZWN0LmtleXMoYXJtcykgYXMgQXJtW10pLmZvckVhY2goYXJtID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHN0YXRzID0gYXJtc1thcm1dO1xuICAgICAgICAgICAgcmVzdWx0W2FybV0gPSB7XG4gICAgICAgICAgICAgICAgLi4uc3RhdHMsXG4gICAgICAgICAgICAgICAgd2luUmF0ZTogc3RhdHMudHJpYWxzID4gMCA/IHN0YXRzLndpbnMgLyBzdGF0cy50cmlhbHMgOiAwLFxuICAgICAgICAgICAgICAgIGF2Z0xhdGVuY3k6IHN0YXRzLnRyaWFscyA+IDAgPyBzdGF0cy50b3RhbExhdGVuY3lNcyAvIHN0YXRzLnRyaWFscyA6IDAsXG4gICAgICAgICAgICAgICAgYXZnQ29zdDogc3RhdHMudHJpYWxzID4gMCA/IHN0YXRzLmNvc3RFdXJvIC8gc3RhdHMudHJpYWxzIDogMCxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb250ZXh0S2V5KGNvbnRleHQ/OiBCYW5kaXRDb250ZXh0KTogc3RyaW5nIHtcbiAgICAgICAgaWYgKCFjb250ZXh0KSByZXR1cm4gJ2dsb2JhbCc7XG5cbiAgICAgICAgY29uc3QgcGFydHMgPSBbXG4gICAgICAgICAgICBjb250ZXh0LmRvbWFpbiB8fCAnZ2VuZXJhbCcsXG4gICAgICAgICAgICBjb250ZXh0LmJ1ZGdldFRpZXIgfHwgJ3N0YW5kYXJkJyxcbiAgICAgICAgICAgIGNvbnRleHQucmVxdWlyZVRvb2xzID8gJ3Rvb2xzJyA6ICduby10b29scydcbiAgICAgICAgXTtcblxuICAgICAgICByZXR1cm4gcGFydHMuam9pbignfCcpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0QXJtc0ZvckNvbnRleHQoY29udGV4dEtleTogc3RyaW5nKTogUmVjb3JkPEFybSwgQXJtU3RhdHM+IHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbnRleHR1YWxBcm1zLmhhcyhjb250ZXh0S2V5KSkge1xuICAgICAgICAgICAgdGhpcy5jb250ZXh0dWFsQXJtcy5zZXQoY29udGV4dEtleSwge1xuICAgICAgICAgICAgICAgIGJlZHJvY2s6IHsgd2luczogMCwgdHJpYWxzOiAwLCBjb3N0RXVybzogMCwgdG90YWxMYXRlbmN5TXM6IDAgfSxcbiAgICAgICAgICAgICAgICBnb29nbGU6IHsgd2luczogMCwgdHJpYWxzOiAwLCBjb3N0RXVybzogMCwgdG90YWxMYXRlbmN5TXM6IDAgfSxcbiAgICAgICAgICAgICAgICBtZXRhOiB7IHdpbnM6IDAsIHRyaWFsczogMCwgY29zdEV1cm86IDAsIHRvdGFsTGF0ZW5jeU1zOiAwIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jb250ZXh0dWFsQXJtcy5nZXQoY29udGV4dEtleSkhO1xuICAgIH1cblxuICAgIHByaXZhdGUgYWRqdXN0U2NvcmVGb3JDb250ZXh0KHNjb3JlOiBudW1iZXIsIGFybTogQXJtLCBjb250ZXh0PzogQmFuZGl0Q29udGV4dCk6IG51bWJlciB7XG4gICAgICAgIGlmICghY29udGV4dCkgcmV0dXJuIHNjb3JlO1xuXG4gICAgICAgIC8vIERvbWFpbi1zcGVjaWZpYyBhZGp1c3RtZW50c1xuICAgICAgICBpZiAoY29udGV4dC5kb21haW4gPT09ICdsZWdhbCcgJiYgYXJtID09PSAnYmVkcm9jaycpIHtcbiAgICAgICAgICAgIHNjb3JlICs9IDAuMTsgLy8gUHJlZmVyIENsYXVkZSBmb3IgbGVnYWxcbiAgICAgICAgfVxuICAgICAgICBpZiAoY29udGV4dC5kb21haW4gPT09ICdjdWxpbmFyeScgJiYgYXJtID09PSAnZ29vZ2xlJykge1xuICAgICAgICAgICAgc2NvcmUgKz0gMC4wNTsgLy8gU2xpZ2h0IHByZWZlcmVuY2UgZm9yIEdlbWluaSBpbiBjdWxpbmFyeVxuICAgICAgICB9XG4gICAgICAgIGlmIChjb250ZXh0LmRvbWFpbiA9PT0gJ21lZGljYWwnICYmIGFybSAhPT0gJ2JlZHJvY2snKSB7XG4gICAgICAgICAgICBzY29yZSAtPSAwLjI7IC8vIFN0cm9uZyBwcmVmZXJlbmNlIGZvciBDbGF1ZGUgaW4gbWVkaWNhbFxuICAgICAgICB9XG5cbiAgICAgICAgLy8gQnVkZ2V0IHRpZXIgYWRqdXN0bWVudHNcbiAgICAgICAgaWYgKGNvbnRleHQuYnVkZ2V0VGllciA9PT0gJ2xvdycgJiYgYXJtID09PSAnbWV0YScpIHtcbiAgICAgICAgICAgIHNjb3JlICs9IDAuMTsgLy8gUHJlZmVyIGNoZWFwZXIgbW9kZWxzIGZvciBsb3cgYnVkZ2V0XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNvbnRleHQuYnVkZ2V0VGllciA9PT0gJ3ByZW1pdW0nICYmIGFybSA9PT0gJ2JlZHJvY2snKSB7XG4gICAgICAgICAgICBzY29yZSArPSAwLjA1OyAvLyBTbGlnaHQgcHJlZmVyZW5jZSBmb3IgcHJlbWl1bSBtb2RlbHNcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRvb2wgcmVxdWlyZW1lbnRzXG4gICAgICAgIGlmIChjb250ZXh0LnJlcXVpcmVUb29scyAmJiBhcm0gPT09ICdtZXRhJykge1xuICAgICAgICAgICAgc2NvcmUgLT0gMC4zOyAvLyBNZXRhIGRvZXNuJ3Qgc3VwcG9ydCB0b29scyB3ZWxsXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgc2NvcmUpKTtcbiAgICB9XG5cbiAgICAvLyBSZXNldCBzdGF0cyBmb3IgYSBzcGVjaWZpYyBjb250ZXh0ICh1c2VmdWwgZm9yIEEvQiB0ZXN0IHJlc2V0cylcbiAgICByZXNldENvbnRleHQoY29udGV4dD86IEJhbmRpdENvbnRleHQpIHtcbiAgICAgICAgY29uc3QgY29udGV4dEtleSA9IHRoaXMuZ2V0Q29udGV4dEtleShjb250ZXh0KTtcbiAgICAgICAgdGhpcy5jb250ZXh0dWFsQXJtcy5kZWxldGUoY29udGV4dEtleSk7XG4gICAgfVxuXG4gICAgLy8gR2V0IHRoZSBiZXN0IHBlcmZvcm1pbmcgYXJtIGZvciBhIGNvbnRleHRcbiAgICBnZXRCZXN0QXJtKGNvbnRleHQ/OiBCYW5kaXRDb250ZXh0KTogeyBhcm06IEFybTsgY29uZmlkZW5jZTogbnVtYmVyIH0ge1xuICAgICAgICBjb25zdCBzdGF0cyA9IHRoaXMuZ2V0U3RhdHMoY29udGV4dCk7XG4gICAgICAgIGxldCBiZXN0QXJtOiBBcm0gPSAnYmVkcm9jayc7XG4gICAgICAgIGxldCBiZXN0V2luUmF0ZSA9IC0xO1xuXG4gICAgICAgIChPYmplY3Qua2V5cyhzdGF0cykgYXMgQXJtW10pLmZvckVhY2goYXJtID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFybVN0YXRzID0gc3RhdHNbYXJtXTtcbiAgICAgICAgICAgIGlmIChhcm1TdGF0cy50cmlhbHMgPiAxMCAmJiBhcm1TdGF0cy53aW5SYXRlID4gYmVzdFdpblJhdGUpIHsgLy8gTWluaW11bSB0cmlhbHMgZm9yIGNvbmZpZGVuY2VcbiAgICAgICAgICAgICAgICBiZXN0V2luUmF0ZSA9IGFybVN0YXRzLndpblJhdGU7XG4gICAgICAgICAgICAgICAgYmVzdEFybSA9IGFybTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgY29uZmlkZW5jZSA9IHN0YXRzW2Jlc3RBcm1dLnRyaWFscyA+IDUwID9cbiAgICAgICAgICAgIE1hdGgubWluKDAuOTUsIHN0YXRzW2Jlc3RBcm1dLndpblJhdGUgKyAwLjEpIDpcbiAgICAgICAgICAgIE1hdGgubWF4KDAuNSwgc3RhdHNbYmVzdEFybV0ud2luUmF0ZSk7XG5cbiAgICAgICAgcmV0dXJuIHsgYXJtOiBiZXN0QXJtLCBjb25maWRlbmNlIH07XG4gICAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJhbmRpdExvZ2dlck9wdHMge1xuICAgIHByb2plY3Q6IHN0cmluZzsgLy8gRXZpZGVudGx5IHByb2plY3QgbmFtZVxuICAgIGNsaWVudD86IEV2aWRlbnRseUNsaWVudDtcbn1cblxuZXhwb3J0IGNsYXNzIEJhbmRpdExvZ2dlciB7XG4gICAgcHJpdmF0ZSBjbGllbnQ6IEV2aWRlbnRseUNsaWVudDtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgb3B0czogQmFuZGl0TG9nZ2VyT3B0cykge1xuICAgICAgICB0aGlzLmNsaWVudCA9IG9wdHMuY2xpZW50ID8/IG5ldyBFdmlkZW50bHlDbGllbnQoe30pO1xuICAgIH1cblxuICAgIGFzeW5jIGxvZ091dGNvbWUocGFyYW1zOiB7XG4gICAgICAgIHVzZXJJZD86IHN0cmluZztcbiAgICAgICAgYXJtOiBBcm07XG4gICAgICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgICAgIGxhdGVuY3lNczogbnVtYmVyO1xuICAgICAgICBjb3N0RXVybzogbnVtYmVyO1xuICAgICAgICBkb21haW4/OiBzdHJpbmc7XG4gICAgICAgIGJ1ZGdldFRpZXI/OiBzdHJpbmc7XG4gICAgICAgIHJlcXVpcmVUb29scz86IGJvb2xlYW47XG4gICAgICAgIHJlcXVlc3RJZD86IHN0cmluZztcbiAgICB9KSB7XG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGFybSxcbiAgICAgICAgICAgIHN1Y2Nlc3MsXG4gICAgICAgICAgICBsYXRlbmN5TXMsXG4gICAgICAgICAgICBjb3N0RXVybyxcbiAgICAgICAgICAgIGRvbWFpbixcbiAgICAgICAgICAgIGJ1ZGdldFRpZXIsXG4gICAgICAgICAgICByZXF1aXJlVG9vbHMsXG4gICAgICAgICAgICByZXF1ZXN0SWRcbiAgICAgICAgfSA9IHBhcmFtcztcblxuICAgICAgICBjb25zdCBlbnRpdHlJZCA9IHVzZXJJZCA/PyByYW5kb21VVUlEKCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnNlbmQobmV3IFB1dFByb2plY3RFdmVudHNDb21tYW5kKHtcbiAgICAgICAgICAgICAgICBwcm9qZWN0OiB0aGlzLm9wdHMucHJvamVjdCxcbiAgICAgICAgICAgICAgICBldmVudHM6IFt7XG4gICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2F3cy5ldmlkZW50bHkuY3VzdG9tJyxcbiAgICAgICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ29yZSBtZXRyaWNzXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RlbF9yb3V0ZTogYXJtLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhdGVuY3lfbXM6IGxhdGVuY3lNcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvc3RfZXVybzogY29zdEV1cm8sXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbnRleHQgaW5mb3JtYXRpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbWFpbjogZG9tYWluIHx8ICdnZW5lcmFsJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZGdldF90aWVyOiBidWRnZXRUaWVyIHx8ICdzdGFuZGFyZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICByZXF1aXJlX3Rvb2xzOiByZXF1aXJlVG9vbHMgfHwgZmFsc2UsXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyYWNraW5nXG4gICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0X2lkOiByZXF1ZXN0SWQgfHwgcmFuZG9tVVVJRCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHlJZCxcbiAgICAgICAgICAgICAgICB9XSxcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIC8vIExvZyBlcnJvciBidXQgZG9uJ3QgdGhyb3cgLSBsb2dnaW5nIGZhaWx1cmVzIHNob3VsZG4ndCBicmVhayB0aGUgbWFpbiBmbG93XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9nIGJhbmRpdCBvdXRjb21lIHRvIEV2aWRlbnRseTonLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBsb2dFeHBlcmltZW50RXZlbnQocGFyYW1zOiB7XG4gICAgICAgIHVzZXJJZD86IHN0cmluZztcbiAgICAgICAgZXhwZXJpbWVudE5hbWU6IHN0cmluZztcbiAgICAgICAgdmFyaWF0aW9uOiBzdHJpbmc7XG4gICAgICAgIG1ldHJpY05hbWU6IHN0cmluZztcbiAgICAgICAgbWV0cmljVmFsdWU6IG51bWJlcjtcbiAgICAgICAgY29udGV4dD86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gICAgfSkge1xuICAgICAgICBjb25zdCB7IHVzZXJJZCwgZXhwZXJpbWVudE5hbWUsIHZhcmlhdGlvbiwgbWV0cmljTmFtZSwgbWV0cmljVmFsdWUsIGNvbnRleHQgfSA9IHBhcmFtcztcbiAgICAgICAgY29uc3QgZW50aXR5SWQgPSB1c2VySWQgPz8gcmFuZG9tVVVJRCgpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5zZW5kKG5ldyBQdXRQcm9qZWN0RXZlbnRzQ29tbWFuZCh7XG4gICAgICAgICAgICAgICAgcHJvamVjdDogdGhpcy5vcHRzLnByb2plY3QsXG4gICAgICAgICAgICAgICAgZXZlbnRzOiBbe1xuICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdhd3MuZXZpZGVudGx5LmN1c3RvbScsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVyaW1lbnRfbmFtZTogZXhwZXJpbWVudE5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXJpYXRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRyaWNfbmFtZTogbWV0cmljTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldHJpY192YWx1ZTogbWV0cmljVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBlbnRpdHlJZCxcbiAgICAgICAgICAgICAgICB9XSxcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBsb2cgZXhwZXJpbWVudCBldmVudCB0byBFdmlkZW50bHk6JywgZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gQmF0Y2ggbG9nZ2luZyBmb3IgYmV0dGVyIHBlcmZvcm1hbmNlXG4gICAgYXN5bmMgbG9nQmF0Y2goZXZlbnRzOiBBcnJheTx7XG4gICAgICAgIHVzZXJJZD86IHN0cmluZztcbiAgICAgICAgYXJtOiBBcm07XG4gICAgICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgICAgIGxhdGVuY3lNczogbnVtYmVyO1xuICAgICAgICBjb3N0RXVybzogbnVtYmVyO1xuICAgICAgICBkb21haW4/OiBzdHJpbmc7XG4gICAgICAgIHJlcXVlc3RJZD86IHN0cmluZztcbiAgICB9Pikge1xuICAgICAgICBpZiAoZXZlbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBldmlkZW50bHlFdmVudHMgPSBldmVudHMubWFwKGV2ZW50ID0+ICh7XG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgICAgIHR5cGU6ICdhd3MuZXZpZGVudGx5LmN1c3RvbScgYXMgY29uc3QsXG4gICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICBtb2RlbF9yb3V0ZTogZXZlbnQuYXJtLFxuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBldmVudC5zdWNjZXNzLFxuICAgICAgICAgICAgICAgICAgICBsYXRlbmN5X21zOiBldmVudC5sYXRlbmN5TXMsXG4gICAgICAgICAgICAgICAgICAgIGNvc3RfZXVybzogZXZlbnQuY29zdEV1cm8sXG4gICAgICAgICAgICAgICAgICAgIGRvbWFpbjogZXZlbnQuZG9tYWluIHx8ICdnZW5lcmFsJyxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdF9pZDogZXZlbnQucmVxdWVzdElkIHx8IHJhbmRvbVVVSUQoKSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGVudGl0eUlkOiBldmVudC51c2VySWQgPz8gcmFuZG9tVVVJRCgpLFxuICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsaWVudC5zZW5kKG5ldyBQdXRQcm9qZWN0RXZlbnRzQ29tbWFuZCh7XG4gICAgICAgICAgICAgICAgcHJvamVjdDogdGhpcy5vcHRzLnByb2plY3QsXG4gICAgICAgICAgICAgICAgZXZlbnRzOiBldmlkZW50bHlFdmVudHMsXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gbG9nIGJhdGNoIGV2ZW50cyB0byBFdmlkZW50bHk6JywgZXJyb3IpO1xuICAgICAgICB9XG4gICAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==