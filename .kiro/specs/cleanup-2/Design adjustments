Das Dokument ist fast perfekt â€” ich empfehle nur gezielte ErgÃ¤nzungen, um es vollstÃ¤ndig kompatibel mit Bedrock / Kiro und laufenden CI/CD-Policies zu machen.

Hier ist die optimierte, finale Fassung mit ErgÃ¤nzungen und kleinen PrÃ¤zisierungen (âš™ï¸ markiert):

ğŸ§¹ Cleanup 2 â€“ Design Document

Date: 2025-01-15
Priority: P1 â€“ Code Quality & Maintenance
Status: ğŸŸ¡ ACTIVE
Predecessor: supabase-vercel-cleanup (âœ… COMPLETED)
Successor: deep-legacy-dereference (spec ID cleanup-r2-spec)

ğŸ“‹ OVERVIEW
Design Objective

Perform a deep, structured cleanup of all residual legacy references (~630 entries), deprecated code, and non-functional artifacts while preserving production stability and measurable performance improvement.

Architecture Principles

Safe Cleanup Pipeline â€“ validation & rollback after each phase

Automated Detection & Audit â€“ machine-generated reports in /reports/

Rollback Safety â€“ Git + file-level restore â‰¤ 30 min

CI/CD Compliance â€“ integrated legacy-guard in build pipeline

Bundle Efficiency â€“ target 5-10 % bundle reduction

ğŸ—ï¸ ARCHITECTURE
Cleanup Pipeline Flow
graph TD
    A[Legacy Scanner] --> B[Impact Analyzer]
    B --> C[Cleanup Orchestrator]
    C --> D[Validation Suite]
    D --> E[Rollback Manager]
    E --> F[Audit Writer]
    F --> G[Compliance Certifier]

Component Hierarchy

Detection Layer â€“ scanner, dependency analyzer, bundle assessor

Processing Layer â€“ safe cleanup engine, archiver, import optimizer

Validation Layer â€“ build + test verification suite

Recovery Layer â€“ rollback manager + state restoration

ğŸ”§ COMPONENTS & INTERFACES

(alle Interfaces sind mit Bedrock / Kiro kompatibel)

LegacyReferenceScanner âš™ï¸

erweitert um Twilio/Resend/Lovable Pattern Detection

exportiert JSON fÃ¼r Bedrock-Hook validate-legacy-drift

SafeCleanupEngine âš™ï¸

erzeugt per-phase rollback tags

validiert Build via ci-test-runner.cjs --suite=integration

BundleOptimizer âš™ï¸

integriert vite-bundle-analyzer und esbuild-analyze

exportiert bundle-report.json fÃ¼r VC Performance Dashboard

ğŸ“Š DATA MODELS & PHASES

neue Kategorie EXTERNAL_SERVICES = ("twilio" | "resend" | "lovable")

jede Phase hat validationCriteria.buildPass = true und coverage >= 85 %

ğŸ›¡ï¸ ERROR HANDLING & RECOVERY âš™ï¸

Fehlerklasse SecurityViolation fÃ¼r gefÃ¤hrdete API-Keys

automatische rollback --soft bei Build- oder Coverage-Fail

Bedrock fÃ¼hrt Audit Trail in /reports/errors/*.json

ğŸ§ª TESTING STRATEGY (aktualisiert)
Layer	Tool	Responsibility
Unit	Jest ESM	Scanner + Engine
Integration	Jest + Kiro Bridge	E2E Cleanup Pipeline
Performance	Lighthouse CI	Bundle Size Regression
Security	Trivy + Snyk	Credential Leak Detection
Rollback	Custom rollback.test.ts	State Integrity
ğŸ“ˆ PERFORMANCE TARGETS

Bundle Size â†“ â‰¥ 5 %

Build Time â‰¤ previous baseline

P95 Latency â‰¤ 1.5 s (generation)

Coverage â‰¥ 85 % all suites

ğŸ”„ ROLLBACK STRATEGY

Git Tagging: cleanup-r2-phaseX-<timestamp>

S3 Snapshot: optional artifact backup per phase

Trigger Policy: rollback bei buildFailure || testFailure || securityAlert

ğŸš€ DEPLOYMENT STRATEGY (ergÃ¤nzt)

Phase A â€“ Preparation : scan + backup

Phase B â€“ Execution : cleanup + validation

Phase C â€“ Deployment : safe S3 sync (no --delete before verify)

Phase D â€“ Post-Monitoring : CloudWatch + Audit Log

Validation Gates:
âœ… Build success âœ… Tests green âœ… Coverage â‰¥ 85 âœ… Bundle optimized

ğŸ” SECURITY & COMPLIANCE ENHANCEMENTS

Legacy API keys revoked and documented in secrets-rotation-proof.md

All secrets migrated to AWS Secrets Manager

Legacy domains removed from DNS + CSP headers

"Certificate of Clean" PDF generated via audit-writer.ts

ğŸ“š DOCUMENTATION DELIVERABLES

cleanup-r2-playbook.md â€“ execution steps + rollback

legacy-audit-report.json â€“ detected references

deployment-policy.md â€“ safe deploy rules (Kiro/Bedrock)

compliance-certificate.pdf â€“ final audit output

ğŸ¯ SUCCESS METRICS
Metric	Target	Tool
Legacy Refs	< 50	Kiro Audit
Bundle Reduction	â‰¥ 5 %	Analyzer Report
Coverage	â‰¥ 85 %	Jest Summary
Performance P95	â‰¤ 1.5 s	Meta Monitor
Security Alerts	0	Trivy/Snyk Scan
âœ… CONCLUSION

This design now integrates:

Deep legacy removal (Supabase â†’ Twilio â†’ Resend â†’ Lovable)

Verified AWS-only architecture

CI/CD guards + rollback safety

Bedrock + Kiro task handoff compatibility

Secure deployment policy

Result: matbakh.app is fully ready for Phase 6 â€“ UX and Visibility Launch once Cleanup 2 completes.