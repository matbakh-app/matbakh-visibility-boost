<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Unbenannt</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.collection-content td {
	white-space: pre-wrap;
	word-break: break-word;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
	margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

blockquote.quote-large {
	font-size: 1.25em;
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(50, 48, 44, 1);
}
.highlight-gray {
	color: rgba(115, 114, 110, 1);
	fill: rgba(115, 114, 110, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(205, 60, 58, 1);
	fill: rgba(205, 60, 58, 1);
}
.highlight-default_background {
	color: rgba(50, 48, 44, 1);
}
.highlight-gray_background {
	background: rgba(248, 248, 247, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(248, 243, 252, 1);
}
.highlight-pink_background {
	background: rgba(252, 241, 246, 1);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(115, 114, 110, 1);
	fill: rgba(115, 114, 110, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(205, 60, 58, 1);
	fill: rgba(205, 60, 58, 1);
}
.block-color-default_background {
	color: inherit;
	fill: inherit;
}
.block-color-gray_background {
	background: rgba(248, 248, 247, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(248, 243, 252, 1);
}
.block-color-pink_background {
	background: rgba(252, 241, 246, 1);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-default { background-color: rgba(42, 28, 0, 0.07); }
.select-value-color-gray { background-color: rgba(28, 19, 1, 0.11); }
.select-value-color-brown { background-color: rgba(142, 58, 1, 0.141); }
.select-value-color-orange { background-color: rgba(213, 96, 0, 0.188); }
.select-value-color-yellow { background-color: rgba(209, 155, 0, 0.238); }
.select-value-color-green { background-color: rgba(1, 104, 42, 0.145); }
.select-value-color-blue { background-color: rgba(45, 149, 218, 0.236); }
.select-value-color-purple { background-color: rgba(104, 1, 184, 0.125); }
.select-value-color-pink { background-color: rgba(204, 1, 88, 0.137); }
.select-value-color-red { background-color: rgba(228, 26, 0, 0.148); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="25dcc947-bd78-8045-9abb-f710050fc8ca" class="page sans"><header><div class="page-header-icon undefined"><img class="icon" src="https://www.notion.so/icons/meeting_gray.svg"/></div><h1 class="page-title"></h1><p class="page-description"></p><table class="properties"><tbody><tr class="property-row property-row-select"><th><span class="icon property-icon"><img src="https://www.notion.so/icons/categories_gray.svg" style="width:14px;height:14px;display:block"/></span>Übergeordnetes Thema</th><td><span class="selected-value select-value-color-green">Information Architecture &amp; Navigation</span></td></tr><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><img src="https://www.notion.so/icons/people_gray.svg" style="width:14px;height:14px;display:block"/></span>Teilnehmer/Rolle</th><td></td></tr><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><img src="https://www.notion.so/icons/key_gray.svg" style="width:14px;height:14px;display:block"/></span>Key Insights</th><td></td></tr><tr class="property-row property-row-multi_select"><th><span class="icon property-icon"><img src="https://www.notion.so/icons/categories_gray.svg" style="width:14px;height:14px;display:block"/></span>Kategorie/TOP</th><td></td></tr><tr class="property-row property-row-status"><th><span class="icon property-icon"><img src="https://www.notion.so/icons/timeline_gray.svg" style="width:14px;height:14px;display:block"/></span>Status</th><td><span class="status-value select-value-color-gray"><div class="status-dot status-dot-color-gray"></div>Backlog</span></td></tr><tr class="property-row property-row-checkbox"><th><span class="icon property-icon"><img src="https://www.notion.so/icons/infinity_gray.svg" style="width:14px;height:14px;display:block"/></span>Teil des Gesamtkonzepts</th><td><div class="checkbox checkbox-off"></div></td></tr></tbody></table></header><div class="page-body"><p id="260cc947-bd78-8045-a418-fa65a94a4750" class=""><strong>supabase asap raus</strong>, alles über <strong>AWS</strong>. hier ist der schnellste, praxistaugliche cut-over plan inkl. konkreter tasks/commands, so dass „register“-mails und login komplett über eure bestehende AWS-schiene laufen (gleicher secrets-/resend-stack wie VC).</p><h1 id="260cc947-bd78-8049-b9e4-dc3e359a71cf" class="">Phase 0 – Entscheidung</h1><ul id="260cc947-bd78-8023-948b-f213bd15428a" class="bulleted-list"><li style="list-style-type:disc">Wir <strong>bauen eine leichte, passwordless Magic-Link Auth</strong> per Lambda + RDS + Resend (kein Cognito jetzt, um Zeit zu sparen).</li></ul><ul id="260cc947-bd78-804c-a9cf-e92fd657bb95" class="bulleted-list"><li style="list-style-type:disc">Token-Handling &amp; E-Mail analog zu VC – dadurch minimale neue Teile, kein Supabase mehr im Pfad.</li></ul><h1 id="260cc947-bd78-80a3-b582-dcfea7672be5" class="">Phase 1 – DB minimal ergänzen (RDS)</h1><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-80ba-bdb1-cd0dbc0f99e5" class="code code-wrap"><code class="language-SQL" style="white-space:pre-wrap;word-break:break-all">-- Users (leichtgewichtig, passt zu bestehendem &#x27;profiles&#x27;)
create table if not exists app_users (
  id uuid primary key default gen_random_uuid(),
  email text unique not null,
  name text,
  verified_at timestamptz,
  created_at timestamptz not null default now()
);

-- Magic-link Tokens
create table if not exists auth_magic_tokens (
  id uuid primary key default gen_random_uuid(),
  email text not null,
  token_hash text not null unique,
  expires_at timestamptz not null,
  consumed_at timestamptz,
  user_agent text,
  ip text,
  created_at timestamptz not null default now()
);
create index if not exists idx_auth_magic_tokens_email on auth_magic_tokens(email);
create index if not exists idx_auth_magic_tokens_expires on auth_magic_tokens(expires_at);

</code></pre><h1 id="260cc947-bd78-80ab-aede-d5408d0e4e67" class="">Phase 2 – Secrets ergänzen</h1><p id="260cc947-bd78-8096-99ba-ece86af2a02e" class="">Wir nutzen dasselbe Secret <code>matbakh-email-config</code>. Ergänze JWT-Key + Zielrouten.</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-807c-a513-d5299a540255" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">aws secretsmanager update-secret \
  --secret-id &quot;matbakh-email-config&quot; \
  --secret-string &#x27;{
    &quot;RESEND_API_KEY&quot;: &quot;re_***&quot;,
    &quot;MAIL_FROM&quot;: &quot;info@matbakh.app&quot;,
    &quot;FRONTEND_BASE_URL&quot;: &quot;https://matbakh.app&quot;,
    &quot;CONFIRM_API_BASE&quot;: &quot;https://guf7ho7bze.execute-api.eu-central-1.amazonaws.com/prod/vc/confirm&quot;,
    &quot;RESULT_PAGE_URL&quot;: &quot;https://matbakh.app/vc/result&quot;,

    &quot;AUTH_CALLBACK_BASE&quot;: &quot;https://guf7ho7bze.execute-api.eu-central-1.amazonaws.com/prod/auth/callback&quot;,
    &quot;AUTH_APP_REDIRECT&quot;: &quot;https://matbakh.app/app&quot;,             # wohin nach login
    &quot;AUTH_JWT_SECRET&quot;: &quot;replace-with-64-byte-random-hex&quot;        # z.B. `openssl rand -hex 64`
  }&#x27; \
  --region eu-central-1

</code></pre><h1 id="260cc947-bd78-80ae-9419-f48aa0755319" class="">Phase 3 – Zwei neue Lambdas (nur das Nötigste)</h1><h2 id="260cc947-bd78-80aa-aea1-cac77d71fefb" class="">A) <code>AuthStartFn</code> (POST <code>/auth/start</code>)</h2><ul id="260cc947-bd78-80fc-87cd-e987ccb1e63c" class="bulleted-list"><li style="list-style-type:disc">Eingabe: <code>{ email, name? }</code></li></ul><ul id="260cc947-bd78-80e4-a1ed-fd51e7e3ad5e" class="bulleted-list"><li style="list-style-type:disc">Prüft/normalisiert E-Mail</li></ul><ul id="260cc947-bd78-8022-97c8-eca6f52a1949" class="bulleted-list"><li style="list-style-type:disc">Generiert 32-Byte Token, speichert SHA256 in <code>auth_magic_tokens</code> (TTL z.B. 30 Min)</li></ul><ul id="260cc947-bd78-8086-b879-cef2512d8a23" class="bulleted-list"><li style="list-style-type:disc">Sendet E-Mail via Resend:<ul id="260cc947-bd78-80fd-afbe-c53d5e0d9f21" class="bulleted-list"><li style="list-style-type:circle">Subject: „Anmelden bei matbakh“</li></ul><ul id="260cc947-bd78-80dc-97f0-d5b48ab10acb" class="bulleted-list"><li style="list-style-type:circle">Button/Link: <code>${AUTH_CALLBACK_BASE}?t=&lt;token&gt;</code></li></ul></li></ul><ul id="260cc947-bd78-8033-9c4c-fc963945dd05" class="bulleted-list"><li style="list-style-type:disc">Antwort: <code>{ ok: true }</code></li></ul><h2 id="260cc947-bd78-8003-b0bc-fdb045798cf8" class="">B) <code>AuthCallbackFn</code> (GET <code>/auth/callback?t=...</code>)</h2><ul id="260cc947-bd78-80f9-a270-efb16e31fb13" class="bulleted-list"><li style="list-style-type:disc">Hash verifizieren, <code>expires_at</code> prüfen, <code>consumed_at</code> setzen</li></ul><ul id="260cc947-bd78-80f7-8765-ee0557358146" class="bulleted-list"><li style="list-style-type:disc"><code>app_users</code> upsert (email, name), <code>verified_at</code> setzen</li></ul><ul id="260cc947-bd78-8068-8139-d5f9bf54988b" class="bulleted-list"><li style="list-style-type:disc">JWT (HS256) signieren mit <code>AUTH_JWT_SECRET</code>, z.B. payload <code>{ sub: userId, email }</code>, exp 7d</li></ul><ul id="260cc947-bd78-8037-ab74-c2ae016a0891" class="bulleted-list"><li style="list-style-type:disc"><strong>302 Redirect</strong> zu <code>${AUTH_APP_REDIRECT}</code> <strong>mit</strong> <code>Set-Cookie: sid=&lt;jwt&gt;; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=604800</code></li></ul><blockquote id="260cc947-bd78-8027-9753-e344130cfc92" class="">Nutze euren bestehenden pg-client Layer &amp; matbakh-email-config Secret – also 0 neue Libs.</blockquote><h3 id="260cc947-bd78-802e-bbc0-d35afd834fa1" class="">IAM</h3><p id="260cc947-bd78-8097-b8f7-d412245c7493" class="">Beide Rollen: gleiche Inline-Policy wie VcStartFn (Secrets + Logs + VPC/ENI). Wenn Secret per benutzerdef. KMS verschlüsselt ist → <code>kms:Decrypt</code>.</p><h1 id="260cc947-bd78-80f1-8779-f9f9547010f5" class="">Phase 4 – API Gateway anlernen</h1><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-8041-bf82-d0b0a33e1e95" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">REST_ID=guf7ho7bze
REG_ID=$(aws apigateway get-resources --rest-api-id $REST_ID --region eu-central-1 \
  --query &#x27;items[?path==`/`].id&#x27; --output text)

# /auth
aws apigateway create-resource --rest-api-id $REST_ID --parent-id $REG_ID --path-part auth --region eu-central-1 \
  --query id --output text

AUTH_ID=$(aws apigateway get-resources --rest-api-id $REST_ID --region eu-central-1 \
  --query &#x27;items[?path==`/auth`].id&#x27; --output text)

# /auth/start (POST)
aws apigateway create-resource --rest-api-id $REST_ID --parent-id $AUTH_ID --path-part start --region eu-central-1
START_ID=$(aws apigateway get-resources --rest-api-id $REST_ID --region eu-central-1 \
  --query &#x27;items[?path==`/auth/start`].id&#x27; --output text)

aws apigateway put-method --rest-api-id $REST_ID --resource-id $START_ID --http-method POST --authorization-type NONE --region eu-central-1
aws apigateway put-integration --rest-api-id $REST_ID --resource-id $START_ID --http-method POST \
  --type AWS_PROXY \
  --integration-http-method POST \
  --uri arn:aws:apigateway:eu-central-1:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-central-1:055062860590:function:AuthStartFn/invocations \
  --region eu-central-1

# /auth/callback (GET + HEAD für Link-Checker)
aws apigateway create-resource --rest-api-id $REST_ID --parent-id $AUTH_ID --path-part callback --region eu-central-1
CB_ID=$(aws apigateway get-resources --rest-api-id $REST_ID --region eu-central-1 \
  --query &#x27;items[?path==`/auth/callback`].id&#x27; --output text)

aws apigateway put-method --rest-api-id $REST_ID --resource-id $CB_ID --http-method GET --authorization-type NONE --region eu-central-1
aws apigateway put-integration --rest-api-id $REST_ID --resource-id $CB_ID --http-method GET \
  --type AWS_PROXY \
  --integration-http-method POST \
  --uri arn:aws:apigateway:eu-central-1:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-central-1:055062860590:function:AuthCallbackFn/invocations \
  --region eu-central-1

aws apigateway put-method --rest-api-id $REST_ID --resource-id $CB_ID --http-method HEAD --authorization-type NONE --region eu-central-1
aws apigateway put-integration --rest-api-id $REST_ID --resource-id $CB_ID --http-method HEAD \
  --type MOCK --request-templates &#x27;{&quot;application/json&quot;:&quot;{\&quot;statusCode\&quot;:200}&quot;}&#x27; --region eu-central-1

# Lambda invoke permissions
aws lambda add-permission --function-name AuthStartFn \
  --statement-id allow-apigw-authstart --action lambda:InvokeFunction \
  --principal apigateway.amazonaws.com \
  --source-arn arn:aws:execute-api:eu-central-1:055062860590:$REST_ID/prod/POST/auth/start

aws lambda add-permission --function-name AuthCallbackFn \
  --statement-id allow-apigw-authcb --action lambda:InvokeFunction \
  --principal apigateway.amazonaws.com \
  --source-arn arn:aws:execute-api:eu-central-1:055062860590:$REST_ID/prod/GET/auth/callback

# Deploy
aws apigateway create-deployment --rest-api-id $REST_ID --stage-name prod --region eu-central-1 \
  --description &quot;auth endpoints&quot;

</code></pre><h1 id="260cc947-bd78-8018-9c58-c943018e7263" class="">Phase 5 – Frontend „Register“ auf AWS umbiegen (quick)</h1><ul id="260cc947-bd78-805e-a4b8-f9f0f5c91b99" class="bulleted-list"><li style="list-style-type:disc"><strong>Register Button</strong>: statt Supabase <code>signUp()</code> → <code>fetch(POST /auth/start, {email,name})</code>, UI zeigt „Check your inbox“.</li></ul><ul id="260cc947-bd78-800b-8e17-fbdc3f1ea29c" class="bulleted-list"><li style="list-style-type:disc"><strong>Callback</strong>: E-Mail öffnet <code>/auth/callback?t=...</code> (Lambda setzt Cookie + 302 auf <code>${AUTH_APP_REDIRECT}</code>).</li></ul><ul id="260cc947-bd78-80a7-88a3-fc8889456bc5" class="bulleted-list"><li style="list-style-type:disc"><strong>Session</strong>: Frontend benutzt HttpOnly Cookie. Für „/me“ eine schlanke Lambda (<code>AuthMeFn</code>) bereitstellen, die JWT aus Cookie prüft und <code>{email,name}</code> gibt. (Optional, aber nice.)</li></ul><h1 id="260cc947-bd78-80b4-8778-f45eb531ee2a" class="">Phase 6 – Zustellbarkeit (Spam) gleich mitziehen</h1><ul id="260cc947-bd78-801a-a481-d691a7a70ed6" class="bulleted-list"><li style="list-style-type:disc">SPF: <code>v=spf1 include:resend.com include:amazonses.com ~all</code></li></ul><ul id="260cc947-bd78-8072-b9a1-f73533e4061a" class="bulleted-list"><li style="list-style-type:disc">DKIM: Resend DKIM-CNAMEs gesetzt</li></ul><ul id="260cc947-bd78-800a-9030-c486ae05b4e1" class="bulleted-list"><li style="list-style-type:disc">DMARC: <code>v=DMARC1; p=none; rua=mailto:dmarc@matbakh.app</code></li></ul><ul id="260cc947-bd78-80f6-b95c-d24977abe2f0" class="bulleted-list"><li style="list-style-type:disc">Einheitlicher From: <code>matbakh &lt;info@matbakh.app&gt;</code></li></ul><ul id="260cc947-bd78-806a-8d1d-c059454cada6" class="bulleted-list"><li style="list-style-type:disc">Text+HTML (hast du), dezente Copy, kein URL-Shortener</li></ul><ul id="260cc947-bd78-8037-992c-f4607fff9e2d" class="bulleted-list"><li style="list-style-type:disc">Optional: Subdomain <code>mail.matbakh.app</code> als Absenderdomain in Resend</li></ul><h1 id="260cc947-bd78-8004-8249-d5b1eb2dcf25" class="">Phase 7 – Supabase deaktivieren</h1><ul id="260cc947-bd78-8001-8491-f553610fb6c2" class="bulleted-list"><li style="list-style-type:disc">SDK &amp; Keys aus dem Frontend entfernen</li></ul><ul id="260cc947-bd78-80a4-a884-f008975cc3a6" class="bulleted-list"><li style="list-style-type:disc">Supabase Auth abschalten (oder Projekte readonly), ggf. Redirect URLs dort löschen</li></ul><ul id="260cc947-bd78-8005-8455-f333ccd76fae" class="bulleted-list"><li style="list-style-type:disc">Falls „profiles“ früher via Supabase gepflegt wurden: auf <code>app_users</code>/eigene Admin-Tools migrieren</li></ul><hr id="260cc947-bd78-80cb-b5ea-cea8bdf03271"/><h2 id="260cc947-bd78-80fa-98d5-f60d11961eed" class="">Kiro-Auftrag (kurz &amp; eindeutig; <strong>nur umsetzen, nichts Neues erfinden</strong>)</h2><ol type="1" id="260cc947-bd78-8042-a547-cdf4fec49ac7" class="numbered-list" start="1"><li><strong>Zwei Lambdas bauen</strong>: <code>AuthStartFn</code> und <code>AuthCallbackFn</code> (nodejs20.x), pg-Layer anhängen, Rollen mit <code>SecretsManagerAccess</code>.</li></ol><ol type="1" id="260cc947-bd78-80ee-87c8-fdf342f29528" class="numbered-list" start="2"><li><strong>SQL oben ausführen</strong>.</li></ol><ol type="1" id="260cc947-bd78-807a-b91e-f7cdfc6195f8" class="numbered-list" start="3"><li><strong>E-Mail</strong> via <code>matbakh-email-config</code> (Resend) senden; Callback-URL und Redirect aus Secret nutzen.</li></ol><ol type="1" id="260cc947-bd78-8044-acfe-e2b3182299ff" class="numbered-list" start="4"><li><strong>JWT</strong> (HS256) mit <code>AUTH_JWT_SECRET</code> erzeugen; Cookie setzen (<code>HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=604800</code>).</li></ol><ol type="1" id="260cc947-bd78-805f-bc66-e1097a381f45" class="numbered-list" start="5"><li><strong>API Gateway</strong> wie oben verdrahten &amp; deployen.</li></ol><ol type="1" id="260cc947-bd78-801b-a819-c6b13d9a97ec" class="numbered-list" start="6"><li><strong>Frontend</strong>: Register-Button auf <code>/auth/start</code> umbiegen; Login nach Callback via Cookie.</li></ol><p id="260cc947-bd78-80d5-8594-e86928c11dfd" class="">Wenn du willst, gebe ich dir <strong>fertige Handler-Dateien</strong> (kompakt) für <code>AuthStartFn</code> &amp; <code>AuthCallbackFn</code>, die exakt auf euren Layer/Secret abgestimmt sind – sag Bescheid, ich droppe die beiden Files sofort.</p><h2 id="260cc947-bd78-80aa-ab08-d643d4df2747" class=""></h2><h1 id="260cc947-bd78-8083-b980-ffdf0887b9b4" class="">Passwordless Auth (AWS) — nur Umsetzung</h1><ul id="260cc947-bd78-8082-94f7-ed036d14f691" class="bulleted-list"><li style="list-style-type:disc">2 Lambdas: <code>AuthStartFn</code> (POST <code>/auth/start</code>) &amp; <code>AuthCallbackFn</code> (GET <code>/auth/callback</code>)</li></ul><ul id="260cc947-bd78-8033-82df-e9355288d51e" class="bulleted-list"><li style="list-style-type:disc">Node.js 20.x, <strong>pg-client layer</strong> anhängen, <strong>VPC</strong> wie VC, <strong>Secrets</strong>: <code>matbakh-email-config</code></li></ul><ul id="260cc947-bd78-80a6-9bab-efe2672806b8" class="bulleted-list"><li style="list-style-type:disc">DB wie besprochen: <code>app_users</code>, <code>auth_magic_tokens</code> (bereits angelegt)</li></ul><ul id="260cc947-bd78-8055-876e-f9bb47497b2e" class="bulleted-list"><li style="list-style-type:disc">API GW Ressourcen &amp; Invoke-Permissions wie zuvor skizziert</li></ul><ul id="260cc947-bd78-805d-ac19-e2a391f688ae" class="bulleted-list"><li style="list-style-type:disc">Kein Supabase verwenden</li></ul><hr id="260cc947-bd78-80bf-ae99-fc248d434346"/><h2 id="260cc947-bd78-80e0-a1fa-e8334de83580" class="">📄 <code>auth-start.js</code> (AuthStartFn – POST /auth/start)</h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-80c1-9cfc-e83daea4e114" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">// AuthStartFn - send magic-link via Resend
const crypto = require(&#x27;crypto&#x27;);
const { getPgClient, executeQuery } = require(&#x27;/opt/nodejs/pgClient&#x27;);
const { SecretsManagerClient, GetSecretValueCommand } = require(&#x27;@aws-sdk/client-secrets-manager&#x27;);

const secrets = new SecretsManagerClient({ region: process.env.AWS_REGION || &#x27;eu-central-1&#x27; });

async function getEmailConfig() {
  const res = await secrets.send(new GetSecretValueCommand({ SecretId: &#x27;matbakh-email-config&#x27; }));
  const cfg = JSON.parse(res.SecretString || &#x27;{}&#x27;);
  if (!cfg.RESEND_API_KEY || !cfg.MAIL_FROM || !cfg.AUTH_CALLBACK_BASE) {
    throw new Error(&#x27;Email config incomplete (need RESEND_API_KEY, MAIL_FROM, AUTH_CALLBACK_BASE)&#x27;);
  }
  return cfg;
}

function corsHeaders() {
  return {
    &#x27;Access-Control-Allow-Origin&#x27;: &#x27;*&#x27;,
    &#x27;Access-Control-Allow-Methods&#x27;: &#x27;POST,OPTIONS&#x27;,
    &#x27;Access-Control-Allow-Headers&#x27;: &#x27;Content-Type&#x27;
  };
}

function isValidEmail(email) {
  return typeof email === &#x27;string&#x27; &amp;&amp; /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

exports.handler = async (event) =&gt; {
  if (event.httpMethod === &#x27;OPTIONS&#x27;) {
    return { statusCode: 200, headers: corsHeaders(), body: &#x27;&#x27; };
  }

  try {
    const body = event.body ? JSON.parse(event.body) : event;
    const email = (body.email || &#x27;&#x27;).trim().toLowerCase();
    const name = (body.name || body.fullname || body.firstName || &#x27;&#x27;).toString().trim() || null;

    console.log(&#x27;AuthStartFn: incoming&#x27;, { email, name });

    if (!isValidEmail(email)) {
      return { statusCode: 400, headers: { ...corsHeaders(), &#x27;Content-Type&#x27;: &#x27;application/json&#x27; }, body: JSON.stringify({ ok: false, error: &#x27;invalid_email&#x27; }) };
    }

    // token &amp; hash
    const token = crypto.randomBytes(32).toString(&#x27;hex&#x27;);
    const tokenHash = crypto.createHash(&#x27;sha256&#x27;).update(token).digest(&#x27;hex&#x27;);
    const expiresInMin = 30;

    // store token
    await getPgClient(); // ensure pool
    const ip = (event.requestContext &amp;&amp; (event.requestContext.identity?.sourceIp || event.requestContext.http?.sourceIp)) || null;
    const ua = (event.headers &amp;&amp; (event.headers[&#x27;user-agent&#x27;] || event.headers[&#x27;User-Agent&#x27;])) || null;

    await executeQuery(
      `INSERT INTO auth_magic_tokens (email, token_hash, expires_at, user_agent, ip)
       VALUES ($1, $2, NOW() + INTERVAL &#x27;30 minutes&#x27;, $3, $4)`,
      [email, tokenHash, ua, ip]
    );

    // send email
    const cfg = await getEmailConfig();
    const link = `${cfg.AUTH_CALLBACK_BASE}?t=${token}`;

    const subject = &#x27;Anmelden bei matbakh&#x27;;
    const html = `
      &lt;p&gt;Hallo${name ? &#x27; &#x27; + name : &#x27;&#x27;},&lt;/p&gt;
      &lt;p&gt;klicke auf den Button, um dich bei &lt;b&gt;matbakh&lt;/b&gt; anzumelden.&lt;/p&gt;
      &lt;p&gt;&lt;a href=&quot;${link}&quot; style=&quot;display:inline-block;padding:12px 18px;border-radius:8px;background:#0ea5e9;color:#fff;text-decoration:none;&quot;&gt;Jetzt anmelden&lt;/a&gt;&lt;/p&gt;
      &lt;p&gt;Falls der Button nicht funktioniert, kopiere den Link:&lt;br&gt;&lt;a href=&quot;${link}&quot;&gt;${link}&lt;/a&gt;&lt;/p&gt;
      &lt;p&gt;Liebe Grüße&lt;br&gt;Dein matbakh Team&lt;/p&gt;`;
    const text = `Hallo${name ? &#x27; &#x27; + name : &#x27;&#x27;},

klicke auf den Link, um dich anzumelden:
${link}

Liebe Grüße
Dein matbakh Team`;

    const resp = await fetch(&#x27;https://api.resend.com/emails&#x27;, {
      method: &#x27;POST&#x27;,
      headers: {
        &#x27;Authorization&#x27;: `Bearer ${cfg.RESEND_API_KEY}`,
        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
      },
      body: JSON.stringify({
        from: `matbakh &lt;${cfg.MAIL_FROM}&gt;`,
        to: [email],
        subject,
        html,
        text
      })
    });

    if (!resp.ok) {
      const err = await resp.text();
      console.error(&#x27;Resend error:&#x27;, resp.status, err);
      // we still return ok to avoid leaking whether an email exists
    } else {
      const json = await resp.json();
      console.log(&#x27;Resend ok:&#x27;, json?.id || json);
    }

    return {
      statusCode: 200,
      headers: { ...corsHeaders(), &#x27;Content-Type&#x27;: &#x27;application/json&#x27; },
      body: JSON.stringify({ ok: true })
    };
  } catch (e) {
    console.error(&#x27;AuthStartFn error:&#x27;, e);
    return {
      statusCode: 500,
      headers: { ...corsHeaders(), &#x27;Content-Type&#x27;: &#x27;application/json&#x27; },
      body: JSON.stringify({ ok: false, error: &#x27;server_error&#x27; })
    };
  }
};

</code></pre><hr id="260cc947-bd78-802f-8c9f-d69414f8c54f"/><h2 id="260cc947-bd78-805f-8d15-df391d66b13c" class="">📄 <code>auth-callback.js</code> (AuthCallbackFn – GET /auth/callback)</h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-80ea-a692-d4a7e2dd1ed6" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">// AuthCallbackFn - verify token, set cookie, 302 to app
const crypto = require(&#x27;crypto&#x27;);
const { getPgClient, executeQuery } = require(&#x27;/opt/nodejs/pgClient&#x27;);
const { SecretsManagerClient, GetSecretValueCommand } = require(&#x27;@aws-sdk/client-secrets-manager&#x27;);

const secrets = new SecretsManagerClient({ region: process.env.AWS_REGION || &#x27;eu-central-1&#x27; });

async function getAuthConfig() {
  const res = await secrets.send(new GetSecretValueCommand({ SecretId: &#x27;matbakh-email-config&#x27; }));
  const cfg = JSON.parse(res.SecretString || &#x27;{}&#x27;);
  if (!cfg.AUTH_APP_REDIRECT || !cfg.AUTH_JWT_SECRET) {
    throw new Error(&#x27;Auth config incomplete (need AUTH_APP_REDIRECT, AUTH_JWT_SECRET)&#x27;);
  }
  return cfg;
}

function base64url(buf) {
  return Buffer.from(buf).toString(&#x27;base64&#x27;).replace(/\+/g, &#x27;-&#x27;).replace(/\//g, &#x27;_&#x27;).replace(/=+$/,&#x27;&#x27;);
}

function signJWT(payload, secret, expiresSec = 7*24*60*60) {
  const header = { alg: &#x27;HS256&#x27;, typ: &#x27;JWT&#x27; };
  const iat = Math.floor(Date.now()/1000);
  const exp = iat + expiresSec;
  const data = { ...payload, iat, exp };

  const encodedHeader = base64url(JSON.stringify(header));
  const encodedPayload = base64url(JSON.stringify(data));
  const toSign = `${encodedHeader}.${encodedPayload}`;

  const signature = crypto.createHmac(&#x27;sha256&#x27;, Buffer.from(secret, &#x27;utf8&#x27;)).update(toSign).digest(&#x27;base64&#x27;)
    .replace(/\+/g,&#x27;-&#x27;).replace(/\//g,&#x27;_&#x27;).replace(/=+$/,&#x27;&#x27;);
  return `${toSign}.${signature}`;
}

exports.handler = async (event) =&gt; {
  // HEAD/OPTIONS short-circuit (for link checkers / CORS)
  if (event.httpMethod === &#x27;OPTIONS&#x27;) return { statusCode: 200, headers: {&#x27;Access-Control-Allow-Origin&#x27;:&#x27;*&#x27;,&#x27;Access-Control-Allow-Methods&#x27;:&#x27;GET,OPTIONS&#x27;,&#x27;Access-Control-Allow-Headers&#x27;:&#x27;Content-Type&#x27;}, body: &#x27;&#x27; };
  if (event.httpMethod === &#x27;HEAD&#x27;) return { statusCode: 200, headers: {}, body: &#x27;&#x27; };

  try {
    const cfg = await getAuthConfig();
    const redirectBase = cfg.AUTH_APP_REDIRECT;

    const t = event.queryStringParameters &amp;&amp; event.queryStringParameters.t;
    if (!t) {
      return { statusCode: 302, headers: { &#x27;Location&#x27;: `${redirectBase}?e=invalid` } };
    }

    const tokenHash = crypto.createHash(&#x27;sha256&#x27;).update(t).digest(&#x27;hex&#x27;);
    await getPgClient();

    const rowRes = await executeQuery(
      `SELECT id, email, expires_at, consumed_at
         FROM auth_magic_tokens
        WHERE token_hash = $1
        ORDER BY created_at DESC
        LIMIT 1`,
      [tokenHash]
    );

    if (rowRes.rows.length === 0) {
      return { statusCode: 302, headers: { &#x27;Location&#x27;: `${redirectBase}?e=invalid` } };
    }

    const tok = rowRes.rows[0];
    const now = new Date();
    if (tok.consumed_at) {
      // already used -&gt; just go to app (idempotent)
      return { statusCode: 302, headers: { &#x27;Location&#x27;: `${redirectBase}` } };
    }
    if (now &gt; new Date(tok.expires_at)) {
      return { statusCode: 302, headers: { &#x27;Location&#x27;: `${redirectBase}?e=expired` } };
    }

    // upsert user
    const userRes = await executeQuery(
      `INSERT INTO app_users (email, verified_at)
       VALUES ($1, NOW())
       ON CONFLICT (email) DO UPDATE SET verified_at = COALESCE(app_users.verified_at, NOW())
       RETURNING id, email, name`,
      [tok.email]
    );
    const user = userRes.rows[0];

    // consume token
    await executeQuery(`UPDATE auth_magic_tokens SET consumed_at = NOW() WHERE token_hash = $1 AND consumed_at IS NULL`, [tokenHash]);

    // sign JWT
    const jwt = signJWT({ sub: user.id, email: user.email }, cfg.AUTH_JWT_SECRET);

    const cookie = `sid=${jwt}; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=${7*24*60*60}`;
    return {
      statusCode: 302,
      headers: { &#x27;Location&#x27;: redirectBase },
      multiValueHeaders: { &#x27;Set-Cookie&#x27;: [cookie] }
    };
  } catch (e) {
    console.error(&#x27;AuthCallbackFn error:&#x27;, e);
    // safe fallback
    try {
      const cfg = await getAuthConfig();
      return { statusCode: 302, headers: { &#x27;Location&#x27;: `${cfg.AUTH_APP_REDIRECT}?e=server` } };
    } catch {
      return { statusCode: 500, body: &#x27;server_error&#x27; };
    }
  }
};

</code></pre><hr id="260cc947-bd78-80ae-8118-c98e5c560a0f"/><h2 id="260cc947-bd78-8040-9c7b-f9bfb0836fd8" class="">⚙️ Deploy-Hinweise (kurz)</h2><ul id="260cc947-bd78-809d-abbb-e4c869f42396" class="bulleted-list"><li style="list-style-type:disc">Beide Funktionen: Runtime <strong>nodejs20.x</strong>, Handler <code>auth-start.handler</code> / <code>auth-callback.handler</code></li></ul><ul id="260cc947-bd78-807e-94fe-e13625339ecc" class="bulleted-list"><li style="list-style-type:disc"><strong>Layer anhängen</strong>: <code>arn:aws:lambda:eu-central-1:055062860590:layer:pg-client-layer:1</code></li></ul><ul id="260cc947-bd78-80ac-8beb-f47223df5389" class="bulleted-list"><li style="list-style-type:disc"><strong>IAM</strong> Inline-Policy wie VcStartFn (<code>SecretsManagerAccess</code> + Logs + VPC/ENI)</li></ul><ul id="260cc947-bd78-80bb-9af2-e28b5b0aeb59" class="bulleted-list"><li style="list-style-type:disc"><strong>API Gateway</strong> Routen:<ul id="260cc947-bd78-808c-8882-e28df202d6c4" class="bulleted-list"><li style="list-style-type:circle"><code>POST /auth/start</code> → AuthStartFn (AWS_PROXY)</li></ul><ul id="260cc947-bd78-8023-880c-e294e1823d82" class="bulleted-list"><li style="list-style-type:circle"><code>GET /auth/callback</code> → AuthCallbackFn (AWS_PROXY)</li></ul><ul id="260cc947-bd78-80b9-a24f-ca0724cfff90" class="bulleted-list"><li style="list-style-type:circle">Optional <code>HEAD /auth/callback</code> → MOCK 200</li></ul></li></ul><ul id="260cc947-bd78-8036-802e-ed64d99316dc" class="bulleted-list"><li style="list-style-type:disc"><strong>Secret</strong> <code>matbakh-email-config</code> muss Felder enthalten:<p id="260cc947-bd78-8094-a04b-ec721260bf2c" class=""><code>RESEND_API_KEY, MAIL_FROM, AUTH_CALLBACK_BASE, AUTH_APP_REDIRECT, AUTH_JWT_SECRET</code></p></li></ul><h2 id="260cc947-bd78-8055-9bfa-f1277afbbe60" class="">🧪 Quick Tests</h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-8080-90a5-e7ccfc268957" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all"># Start (Magic-Link senden)
aws apigateway test-invoke-method \
  --rest-api-id guf7ho7bze --resource-id &lt;START_ID&gt; --http-method POST \
  --body &#x27;{&quot;email&quot;:&quot;you@example.com&quot;,&quot;name&quot;:&quot;You&quot;}&#x27; --region eu-central-1

# Callback (per Token)
curl -i &quot;https://guf7ho7bze.execute-api.eu-central-1.amazonaws.com/prod/auth/callback?t=&lt;TOKEN&gt;&quot;
# Erwartet: 302 + Set-Cookie: sid=...  → Location: AUTH_APP_REDIRECT
</code></pre><hr id="260cc947-bd78-80f1-97ee-cc474348e555"/><h1 id="260cc947-bd78-80f5-9ff6-d3390aa5d1e5" class="">Magic-Link Login</h1><h2 id="260cc947-bd78-8066-b055-ca0ffede0d32" class="">Kurzfassung</h2><ul id="260cc947-bd78-804a-b581-f3129279e33f" class="bulleted-list"><li style="list-style-type:disc">Neue Endpunkte:<ul id="260cc947-bd78-80da-a4be-ed5126735048" class="bulleted-list"><li style="list-style-type:circle"><code>POST /auth/start</code> → Magic-Link senden</li></ul><ul id="260cc947-bd78-808d-acd9-cb9a2d877687" class="bulleted-list"><li style="list-style-type:circle"><code>GET /auth/callback</code> (+ <code>HEAD</code>) → Token prüfen, Session-Cookie setzen, 302 zur App</li></ul></li></ul><ul id="260cc947-bd78-801a-8e00-d34d90bdc34a" class="bulleted-list"><li style="list-style-type:disc">Läuft auf Lambda <strong>nodejs20.x</strong>, nutzt euren <strong>pg-client layer</strong> &amp; <strong>VPC</strong>.</li></ul><ul id="260cc947-bd78-8073-ba7c-f2380cdedffa" class="bulleted-list"><li style="list-style-type:disc">Konfiguration aus <strong>Secrets Manager</strong> (<code>matbakh-email-config</code>).</li></ul><ul id="260cc947-bd78-80fa-a175-c4dc26bc35c4" class="bulleted-list"><li style="list-style-type:disc">Keine neuen Konzepte – nur die besprochene Logik.</li></ul><hr id="260cc947-bd78-805f-a812-e81e0acbd691"/><h2 id="260cc947-bd78-8045-8277-e4989e0018e9" class="">Änderungsübersicht (Tree)</h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-80f5-9504-e564aac2845c" class="code code-wrap"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">.
├─ functions/
│  ├─ auth-start.js
│  └─ auth-callback.js
├─ infra/cdk/lib/
│  └─ auth.ts                # CDK-Helfer: Lambdas + API-Routen anhängen
├─ sql/
│  └─ ensure_auth_tables.sql # nur falls Tabellen fehlen
├─ scripts/
│  ├─ update-email-secret.sh # Beispiel zum Pflegen von Secrets
│  └─ deploy-auth-cli.sh     # (optional) reines CLI-Deploy ohne CDK
└─ README_AUTH.md

</code></pre><hr id="260cc947-bd78-8064-9172-cecdf02c6666"/><h2 id="260cc947-bd78-80dd-845a-e06103e11444" class="">Code</h2><h3 id="260cc947-bd78-8090-a8ac-cf437cbf79ec" class=""><code>functions/auth-start.js</code></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-807c-b9fd-c2492a958cb6" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">// AuthStartFn - send magic-link via Resend
const crypto = require(&#x27;crypto&#x27;);
const { getPgClient, executeQuery } = require(&#x27;/opt/nodejs/pgClient&#x27;);
const { SecretsManagerClient, GetSecretValueCommand } = require(&#x27;@aws-sdk/client-secrets-manager&#x27;);

const secrets = new SecretsManagerClient({ region: process.env.AWS_REGION || &#x27;eu-central-1&#x27; });

async function getEmailConfig() {
  const res = await secrets.send(new GetSecretValueCommand({ SecretId: &#x27;matbakh-email-config&#x27; }));
  const cfg = JSON.parse(res.SecretString || &#x27;{}&#x27;);
  if (!cfg.RESEND_API_KEY || !cfg.MAIL_FROM || !cfg.AUTH_CALLBACK_BASE) {
    throw new Error(&#x27;Email config incomplete (need RESEND_API_KEY, MAIL_FROM, AUTH_CALLBACK_BASE)&#x27;);
  }
  return cfg;
}

function cors() {
  return {
    &#x27;Access-Control-Allow-Origin&#x27;: &#x27;*&#x27;,
    &#x27;Access-Control-Allow-Methods&#x27;: &#x27;POST,OPTIONS&#x27;,
    &#x27;Access-Control-Allow-Headers&#x27;: &#x27;Content-Type&#x27;
  };
}

function isValidEmail(email) {
  return typeof email === &#x27;string&#x27; &amp;&amp; /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

exports.handler = async (event) =&gt; {
  if (event.httpMethod === &#x27;OPTIONS&#x27;) return { statusCode: 200, headers: cors(), body: &#x27;&#x27; };

  try {
    const body = event.body ? JSON.parse(event.body) : event;
    const email = (body.email || &#x27;&#x27;).trim().toLowerCase();
    const name = (body.name || body.fullname || body.firstName || &#x27;&#x27;).toString().trim() || null;

    if (!isValidEmail(email)) {
      return { statusCode: 400, headers: { ...cors(), &#x27;Content-Type&#x27;: &#x27;application/json&#x27; }, body: JSON.stringify({ ok: false, error: &#x27;invalid_email&#x27; }) };
    }

    // token &amp; hash
    const token = crypto.randomBytes(32).toString(&#x27;hex&#x27;);
    const tokenHash = crypto.createHash(&#x27;sha256&#x27;).update(token).digest(&#x27;hex&#x27;);

    // store token (+ context)
    await getPgClient(); // ensure pool
    const ip = (event.requestContext &amp;&amp; (event.requestContext.identity?.sourceIp || event.requestContext.http?.sourceIp)) || null;
    const ua = (event.headers &amp;&amp; (event.headers[&#x27;user-agent&#x27;] || event.headers[&#x27;User-Agent&#x27;])) || null;

    await executeQuery(
      `INSERT INTO auth_magic_tokens (email, token_hash, expires_at, user_agent, ip)
       VALUES ($1, $2, NOW() + INTERVAL &#x27;30 minutes&#x27;, $3, $4)`,
      [email, tokenHash, ua, ip]
    );

    // send email
    const cfg = await getEmailConfig();
    const link = `${cfg.AUTH_CALLBACK_BASE}?t=${token}`;

    const subject = &#x27;Anmelden bei matbakh&#x27;;
    const html = `
      &lt;p&gt;Hallo${name ? &#x27; &#x27; + name : &#x27;&#x27;},&lt;/p&gt;
      &lt;p&gt;klicke auf den Button, um dich bei &lt;b&gt;matbakh&lt;/b&gt; anzumelden.&lt;/p&gt;
      &lt;p&gt;&lt;a href=&quot;${link}&quot; style=&quot;display:inline-block;padding:12px 18px;border-radius:8px;background:#0ea5e9;color:#fff;text-decoration:none;&quot;&gt;Jetzt anmelden&lt;/a&gt;&lt;/p&gt;
      &lt;p&gt;Falls der Button nicht funktioniert, kopiere den Link:&lt;br&gt;&lt;a href=&quot;${link}&quot;&gt;${link}&lt;/a&gt;&lt;/p&gt;
      &lt;p&gt;Liebe Grüße&lt;br&gt;Dein matbakh Team&lt;/p&gt;`;
    const text = `Hallo${name ? &#x27; &#x27; + name : &#x27;&#x27;},

klicke auf den Link, um dich anzumelden:
${link}

Liebe Grüße
Dein matbakh Team`;

    const resp = await fetch(&#x27;https://api.resend.com/emails&#x27;, {
      method: &#x27;POST&#x27;,
      headers: {
        &#x27;Authorization&#x27;: `Bearer ${cfg.RESEND_API_KEY}`,
        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
      },
      body: JSON.stringify({
        from: `matbakh &lt;${cfg.MAIL_FROM}&gt;`,
        to: [email],
        subject,
        html,
        text
      })
    });

    if (!resp.ok) {
      const err = await resp.text();
      console.error(&#x27;Resend error:&#x27;, resp.status, err);
      // Absichtlich trotzdem ok → kein User-Enumerations-Leak
    } else {
      const json = await resp.json();
      console.log(&#x27;Resend ok:&#x27;, json?.id || json);
    }

    return { statusCode: 200, headers: { ...cors(), &#x27;Content-Type&#x27;: &#x27;application/json&#x27; }, body: JSON.stringify({ ok: true }) };
  } catch (e) {
    console.error(&#x27;AuthStartFn error:&#x27;, e);
    return { statusCode: 500, headers: { ...cors(), &#x27;Content-Type&#x27;: &#x27;application/json&#x27; }, body: JSON.stringify({ ok: false, error: &#x27;server_error&#x27; }) };
  }
};

</code></pre><h3 id="260cc947-bd78-80a4-90d5-c546f8283fa8" class=""><code>functions/auth-callback.js</code></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-8049-bb53-fcc1054c7e50" class="code code-wrap"><code class="language-JavaScript" style="white-space:pre-wrap;word-break:break-all">// AuthCallbackFn - verify token, set cookie, 302 to app
const crypto = require(&#x27;crypto&#x27;);
const { getPgClient, executeQuery } = require(&#x27;/opt/nodejs/pgClient&#x27;);
const { SecretsManagerClient, GetSecretValueCommand } = require(&#x27;@aws-sdk/client-secrets-manager&#x27;);

const secrets = new SecretsManagerClient({ region: process.env.AWS_REGION || &#x27;eu-central-1&#x27; });

async function getAuthConfig() {
  const res = await secrets.send(new GetSecretValueCommand({ SecretId: &#x27;matbakh-email-config&#x27; }));
  const cfg = JSON.parse(res.SecretString || &#x27;{}&#x27;);
  if (!cfg.AUTH_APP_REDIRECT || !cfg.AUTH_JWT_SECRET) {
    throw new Error(&#x27;Auth config incomplete (need AUTH_APP_REDIRECT, AUTH_JWT_SECRET)&#x27;);
  }
  return cfg;
}

function b64url(buf) { return Buffer.from(buf).toString(&#x27;base64&#x27;).replace(/\+/g,&#x27;-&#x27;).replace(/\//g,&#x27;_&#x27;).replace(/=+$/,&#x27;&#x27;); }

function signJWT(payload, secret, ttlSec = 7*24*60*60) {
  const header = { alg: &#x27;HS256&#x27;, typ: &#x27;JWT&#x27; };
  const iat = Math.floor(Date.now()/1000);
  const exp = iat + ttlSec;
  const encodedHeader = b64url(JSON.stringify(header));
  const encodedPayload = b64url(JSON.stringify({ ...payload, iat, exp }));
  const toSign = `${encodedHeader}.${encodedPayload}`;
  const signature = crypto.createHmac(&#x27;sha256&#x27;, Buffer.from(secret, &#x27;utf8&#x27;))
    .update(toSign).digest(&#x27;base64&#x27;).replace(/\+/g,&#x27;-&#x27;).replace(/\//g,&#x27;_&#x27;).replace(/=+$/,&#x27;&#x27;);
  return `${toSign}.${signature}`;
}

exports.handler = async (event) =&gt; {
  if (event.httpMethod === &#x27;OPTIONS&#x27;) return { statusCode: 200, headers: {&#x27;Access-Control-Allow-Origin&#x27;:&#x27;*&#x27;,&#x27;Access-Control-Allow-Methods&#x27;:&#x27;GET,HEAD,OPTIONS&#x27;,&#x27;Access-Control-Allow-Headers&#x27;:&#x27;Content-Type&#x27;}, body: &#x27;&#x27; };
  if (event.httpMethod === &#x27;HEAD&#x27;) return { statusCode: 200, headers: {}, body: &#x27;&#x27; };

  try {
    const cfg = await getAuthConfig();
    const redirectBase = cfg.AUTH_APP_REDIRECT;

    const t = event.queryStringParameters &amp;&amp; event.queryStringParameters.t;
    if (!t) return { statusCode: 302, headers: { &#x27;Location&#x27;: `${redirectBase}?e=invalid` } };

    const tokenHash = crypto.createHash(&#x27;sha256&#x27;).update(t).digest(&#x27;hex&#x27;);
    await getPgClient();

    const tokRes = await executeQuery(
      `SELECT id, email, expires_at, consumed_at
         FROM auth_magic_tokens
        WHERE token_hash = $1
        ORDER BY created_at DESC
        LIMIT 1`,
      [tokenHash]
    );
    if (tokRes.rows.length === 0) return { statusCode: 302, headers: { &#x27;Location&#x27;: `${redirectBase}?e=invalid` } };

    const tok = tokRes.rows[0];
    const now = new Date();
    if (tok.consumed_at) return { statusCode: 302, headers: { &#x27;Location&#x27;: redirectBase } };
    if (now &gt; new Date(tok.expires_at)) return { statusCode: 302, headers: { &#x27;Location&#x27;: `${redirectBase}?e=expired` } };

    // upsert user
    const userRes = await executeQuery(
      `INSERT INTO app_users (email, verified_at)
       VALUES ($1, NOW())
       ON CONFLICT (email) DO UPDATE SET verified_at = COALESCE(app_users.verified_at, NOW())
       RETURNING id, email, name`,
      [tok.email]
    );
    const user = userRes.rows[0];

    // consume token
    await executeQuery(`UPDATE auth_magic_tokens SET consumed_at = NOW() WHERE token_hash = $1 AND consumed_at IS NULL`, [tokenHash]);

    // sign JWT + cookie
    const jwt = signJWT({ sub: user.id, email: user.email }, cfg.AUTH_JWT_SECRET);
    const maxAge = 7*24*60*60;
    const cookie = `sid=${jwt}; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=${maxAge}`;

    return { statusCode: 302, headers: { &#x27;Location&#x27;: redirectBase }, multiValueHeaders: { &#x27;Set-Cookie&#x27;: [cookie] } };
  } catch (e) {
    console.error(&#x27;AuthCallbackFn error:&#x27;, e);
    try {
      const cfg = await getAuthConfig();
      return { statusCode: 302, headers: { &#x27;Location&#x27;: `${cfg.AUTH_APP_REDIRECT}?e=server` } };
    } catch {
      return { statusCode: 500, body: &#x27;server_error&#x27; };
    }
  }
};

</code></pre><hr id="260cc947-bd78-8003-bf98-e4225446199c"/><h2 id="260cc947-bd78-808d-a7c2-d467926333f5" class="">CDK – Ressourcen anhängen</h2><h3 id="260cc947-bd78-8002-84ad-d12eb28d0f3c" class=""><code>infra/cdk/lib/auth.ts</code></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-806e-ad42-ff275017607a" class="code code-wrap"><code class="language-TypeScript" style="white-space:pre-wrap;word-break:break-all">import * as cdk from &#x27;aws-cdk-lib&#x27;;
import { Construct } from &#x27;constructs&#x27;;
import * as apigw from &#x27;aws-cdk-lib/aws-apigateway&#x27;;
import * as lambda from &#x27;aws-cdk-lib/aws-lambda&#x27;;
import * as ec2 from &#x27;aws-cdk-lib/aws-ec2&#x27;;
import * as iam from &#x27;aws-cdk-lib/aws-iam&#x27;;

type Params = {
  scope: Construct;
  api: apigw.RestApi;
  vpc: ec2.IVpc;
  lambdaSg: ec2.ISecurityGroup; // e.g. fromSecurityGroupId
  pgLayerArn: string;           // arn:aws:lambda:eu-central-1:...:layer:pg-client-layer:1
  codePath: string;             // path to functions dir
};

export function addAuthRoutes(p: Params) {
  const layer = lambda.LayerVersion.fromLayerVersionArn(p.scope, &#x27;PgClientLayer&#x27;, p.pgLayerArn);

  const common: Partial&lt;lambda.FunctionProps&gt; = {
    runtime: lambda.Runtime.NODEJS_20_X,
    memorySize: 128,
    architecture: lambda.Architecture.X86_64,
    timeout: cdk.Duration.seconds(15),
    vpc: p.vpc,
    securityGroups: [p.lambdaSg],
    layers: [layer]
  };

  const startFn = new lambda.Function(p.scope, &#x27;AuthStartFn&#x27;, {
    ...common,
    handler: &#x27;auth-start.handler&#x27;,
    code: lambda.Code.fromAsset(`${p.codePath}`),
    description: &#x27;Passwordless login start (send magic link)&#x27;
  });

  const callbackFn = new lambda.Function(p.scope, &#x27;AuthCallbackFn&#x27;, {
    ...common,
    handler: &#x27;auth-callback.handler&#x27;,
    code: lambda.Code.fromAsset(`${p.codePath}`),
    description: &#x27;Passwordless login callback (verify token, set cookie, 302)&#x27;
  });

  // IAM: logs + VPC + secrets
  const secretsStmt = new iam.PolicyStatement({
    effect: iam.Effect.ALLOW,
    actions: [&#x27;secretsmanager:GetSecretValue&#x27;],
    resources: [
      &#x27;arn:aws:secretsmanager:eu-central-1:055062860590:secret:matbakh-email-config*&#x27;,
      &#x27;arn:aws:secretsmanager:eu-central-1:055062860590:secret:matbakh-db-postgres*&#x27;
    ]
  });
  [startFn, callbackFn].forEach(fn =&gt; {
    fn.role?.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName(&#x27;service-role/AWSLambdaBasicExecutionRole&#x27;));
    fn.role?.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName(&#x27;service-role/AWSLambdaVPCAccessExecutionRole&#x27;));
    fn.addToRolePolicy(secretsStmt);
  });

  // API resources
  const auth = p.api.root.getResource(&#x27;auth&#x27;) ?? p.api.root.addResource(&#x27;auth&#x27;);
  const start = auth.addResource(&#x27;start&#x27;);
  const callback = auth.addResource(&#x27;callback&#x27;);

  // CORS (preflight handled at resource)
  [start, callback].forEach(r =&gt; r.addCorsPreflight({
    allowOrigins: apigw.Cors.ALL_ORIGINS,
    allowMethods: [&#x27;GET&#x27;,&#x27;POST&#x27;,&#x27;HEAD&#x27;,&#x27;OPTIONS&#x27;],
    allowHeaders: [&#x27;Content-Type&#x27;],
  }));

  start.addMethod(&#x27;POST&#x27;, new apigw.LambdaIntegration(startFn, { proxy: true }));
  callback.addMethod(&#x27;GET&#x27;, new apigw.LambdaIntegration(callbackFn, { proxy: true }));
  // HEAD für Link-Checker (gleiche Lambda, sofort 200)
  callback.addMethod(&#x27;HEAD&#x27;, new apigw.LambdaIntegration(callbackFn, { proxy: true }));

  // Invoke permission (CDK setzt i.d.R. automatisch, hier explizit für Klarheit)
  [startFn, callbackFn].forEach(fn =&gt; {
    fn.addPermission(`${fn.node.id}InvokeByApi`, {
      principal: new iam.ServicePrincipal(&#x27;apigateway.amazonaws.com&#x27;),
      sourceArn: p.api.arnForExecuteApi(&#x27;*&#x27;)
    });
  });

  new cdk.CfnOutput(p.scope as cdk.Stack, &#x27;AuthEndpoints&#x27;, {
    value: `POST ${p.api.url}auth/start , GET ${p.api.url}auth/callback`
  });
}

</code></pre><p id="260cc947-bd78-8061-b1dc-fe3517457ce1" class=""><strong>Einbindung</strong> in eure bestehende CDK-Stack Datei (wo <code>PublicApi</code>, <code>vpc</code>, <code>lambdaSg</code> vorhanden sind):</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-80af-8180-e1d3ab0e2d36" class="code code-wrap"><code class="language-TypeScript" style="white-space:pre-wrap;word-break:break-all">import { addAuthRoutes } from &#x27;./auth&#x27;;

// …
addAuthRoutes({
  scope: this,
  api: publicApi,              // bestehendes apigw.RestApi
  vpc: vpc,                    // bestehende VPC
  lambdaSg: lambdaSg,          // euer Lambda-SG (RDS/HTTPS)
  pgLayerArn: &#x27;arn:aws:lambda:eu-central-1:055062860590:layer:pg-client-layer:1&#x27;,
  codePath: &#x27;functions&#x27;        // Pfad zu auth-start.js &amp; auth-callback.js
});

</code></pre><hr id="260cc947-bd78-8069-8257-c279f5765922"/><h2 id="260cc947-bd78-8088-8c9f-e411301c52d2" class="">Secrets &amp; SQL</h2><h3 id="260cc947-bd78-8075-b149-c5c6f6840ce7" class="">Secret: <code>matbakh-email-config</code></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-80a6-8bc3-e36d9255b92c" class="code code-wrap"><code class="language-JSON" style="white-space:pre-wrap;word-break:break-all">{
  &quot;RESEND_API_KEY&quot;: &quot;re_XXXX&quot;,
  &quot;MAIL_FROM&quot;: &quot;info@matbakh.app&quot;,
  &quot;AUTH_CALLBACK_BASE&quot;: &quot;https://guf7ho7bze.execute-api.eu-central-1.amazonaws.com/prod/auth/callback&quot;,
  &quot;AUTH_APP_REDIRECT&quot;: &quot;https://matbakh.app/app&quot;,
  &quot;AUTH_JWT_SECRET&quot;: &quot;change-me-super-secret-64-bytes&quot;
}

</code></pre><h3 id="260cc947-bd78-80d9-b704-ec7b6aac8a26" class="">(Nur falls fehlend) <code>sql/ensure_auth_tables.sql</code></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-80fd-aaab-c34a5b1f2637" class="code code-wrap"><code class="language-SQL" style="white-space:pre-wrap;word-break:break-all">CREATE TABLE IF NOT EXISTS app_users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text UNIQUE NOT NULL,
  name text,
  verified_at timestamptz,
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS auth_magic_tokens (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text NOT NULL,
  token_hash text NOT NULL,
  expires_at timestamptz NOT NULL,
  consumed_at timestamptz,
  user_agent text,
  ip text,
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_auth_magic_tokens_hash ON auth_magic_tokens(token_hash);
CREATE INDEX IF NOT EXISTS idx_auth_magic_tokens_email ON auth_magic_tokens(email);

</code></pre><hr id="260cc947-bd78-80bd-955e-deb1b0989004"/><h2 id="260cc947-bd78-80ce-8313-fafb39b7303d" class="">Skripte</h2><h3 id="260cc947-bd78-8055-8e0e-daf22a420e6e" class=""><code>scripts/update-email-secret.sh</code></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-805c-8630-fb0a7e143a45" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">#!/usr/bin/env bash
set -euo pipefail
REGION=eu-central-1
aws secretsmanager update-secret \
  --region &quot;$REGION&quot; \
  --secret-id &quot;matbakh-email-config&quot; \
  --secret-string &quot;$(cat &lt;&lt;&#x27;JSON&#x27;
{
  &quot;RESEND_API_KEY&quot;: &quot;re_XXXX&quot;,
  &quot;MAIL_FROM&quot;: &quot;info@matbakh.app&quot;,
  &quot;AUTH_CALLBACK_BASE&quot;: &quot;https://guf7ho7bze.execute-api.eu-central-1.amazonaws.com/prod/auth/callback&quot;,
  &quot;AUTH_APP_REDIRECT&quot;: &quot;https://matbakh.app/app&quot;,
  &quot;AUTH_JWT_SECRET&quot;: &quot;change-me-super-secret-64-bytes&quot;
}
JSON
)&quot;
echo &quot;Secret updated.&quot;

</code></pre><h3 id="260cc947-bd78-80a2-8ebc-cd4ffc351cd5" class="">(Optional) reines CLI-Deploy ohne CDK – <code>scripts/deploy-auth-cli.sh</code></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-80a8-a793-c33b8042082b" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all">#!/usr/bin/env bash
set -euo pipefail
REGION=eu-central-1
LAYER_ARN=&quot;arn:aws:lambda:eu-central-1:055062860590:layer:pg-client-layer:1&quot;
VPC_SUBNETS=&quot;subnet-086715492e55e5380 subnet-0d0cfb07da9341ce3 subnet-027c02162f7e5b530&quot;
SG_ID=&quot;sg-0ce17ccbf943dd57b&quot;

zip -j /tmp/auth-start.zip functions/auth-start.js
zip -j /tmp/auth-callback.zip functions/auth-callback.js

create_fn () {
  local NAME=$1 HANDLER=$2 ZIP=$3 TIMEOUT=$4
  if aws lambda get-function --function-name &quot;$NAME&quot; --region $REGION &gt;/dev/null 2&gt;&amp;1; then
    aws lambda update-function-code --function-name &quot;$NAME&quot; --zip-file &quot;fileb://$ZIP&quot; --region $REGION &gt;/dev/null
    aws lambda update-function-configuration --function-name &quot;$NAME&quot; --handler &quot;$HANDLER&quot; --runtime nodejs20.x \
      --timeout $TIMEOUT --layers &quot;$LAYER_ARN&quot; \
      --vpc-config SubnetIds=&quot;[$(echo $VPC_SUBNETS | sed &#x27;s/ /,/g&#x27;)]&quot;,SecurityGroupIds=&quot;[$SG_ID]&quot; \
      --region $REGION &gt;/dev/null
  else
    aws lambda create-function --function-name &quot;$NAME&quot; --handler &quot;$HANDLER&quot; --runtime nodejs20.x \
      --zip-file &quot;fileb://$ZIP&quot; --timeout $TIMEOUT --role &quot;arn:aws:iam::055062860590:role/MatbakhVcStack-VcStartFnServiceRoleD81E4A8A-vJkePnobNf07&quot; \
      --layers &quot;$LAYER_ARN&quot; --region $REGION \
      --vpc-config SubnetIds=&quot;[$(echo $VPC_SUBNETS | sed &#x27;s/ /,/g&#x27;)]&quot;,SecurityGroupIds=&quot;[$SG_ID]&quot;
  fi

  # Secrets + Logs + VPC perms
  aws iam put-role-policy --role-name &quot;MatbakhVcStack-VcStartFnServiceRoleD81E4A8A-vJkePnobNf07&quot; \
    --policy-name &quot;${NAME}-SecretsManagerAccess&quot; \
    --policy-document &quot;$(cat &lt;&lt;&#x27;JSON&#x27;
{
  &quot;Version&quot;:&quot;2012-10-17&quot;,
  &quot;Statement&quot;:[
    {&quot;Effect&quot;:&quot;Allow&quot;,&quot;Action&quot;:[&quot;secretsmanager:GetSecretValue&quot;],&quot;Resource&quot;:[
      &quot;arn:aws:secretsmanager:eu-central-1:055062860590:secret:matbakh-email-config*&quot;,
      &quot;arn:aws:secretsmanager:eu-central-1:055062860590:secret:matbakh-db-postgres*&quot;
    ]},
    {&quot;Effect&quot;:&quot;Allow&quot;,&quot;Action&quot;:[&quot;logs:CreateLogGroup&quot;,&quot;logs:CreateLogStream&quot;,&quot;logs:PutLogEvents&quot;],&quot;Resource&quot;:&quot;*&quot;},
    {&quot;Effect&quot;:&quot;Allow&quot;,&quot;Action&quot;:[&quot;ec2:CreateNetworkInterface&quot;,&quot;ec2:DescribeNetworkInterfaces&quot;,&quot;ec2:DeleteNetworkInterface&quot;,&quot;ec2:AttachNetworkInterface&quot;,&quot;ec2:DetachNetworkInterface&quot;],&quot;Resource&quot;:&quot;*&quot;}
  ]
}
JSON
)&quot;
}

create_fn &quot;AuthStartFn&quot; &quot;auth-start.handler&quot; &quot;/tmp/auth-start.zip&quot; 15
create_fn &quot;AuthCallbackFn&quot; &quot;auth-callback.handler&quot; &quot;/tmp/auth-callback.zip&quot; 10

# API routes (assumes API id known)
API_ID=&quot;guf7ho7bze&quot;
AUTH_ID=$(aws apigateway get-resources --rest-api-id $API_ID --region $REGION --query &quot;items[?path==&#x27;/auth&#x27;].id&quot; --output text)
[ -z &quot;$AUTH_ID&quot; ] &amp;&amp; AUTH_ID=$(aws apigateway create-resource --rest-api-id $API_ID --parent-id $(aws apigateway get-resources --rest-api-id $API_ID --query &quot;items[?path==&#x27;/&#x27;].id&quot; --output text) --path-part auth --region $REGION --query id --output text)
START_ID=$(aws apigateway create-resource --rest-api-id $API_ID --parent-id $AUTH_ID --path-part start --region $REGION --query id --output text)
CALLBACK_ID=$(aws apigateway create-resource --rest-api-id $API_ID --parent-id $AUTH_ID --path-part callback --region $REGION --query id --output text 2&gt;/dev/null || true)

aws apigateway put-method --rest-api-id $API_ID --resource-id $START_ID --http-method POST --authorization-type NONE --region $REGION &gt;/dev/null
aws apigateway put-integration --rest-api-id $API_ID --resource-id $START_ID --http-method POST --type AWS_PROXY \
  --integration-http-method POST --uri &quot;arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/arn:aws:lambda:$REGION:055062860590:function:AuthStartFn/invocations&quot; --region $REGION &gt;/dev/null

aws apigateway put-method --rest-api-id $API_ID --resource-id $CALLBACK_ID --http-method GET --authorization-type NONE --region $REGION &gt;/dev/null
aws apigateway put-integration --rest-api-id $API_ID --resource-id $CALLBACK_ID --http-method GET --type AWS_PROXY \
  --integration-http-method POST --uri &quot;arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/arn:aws:lambda:$REGION:055062860590:function:AuthCallbackFn/invocations&quot; --region $REGION &gt;/dev/null

aws apigateway put-method --rest-api-id $API_ID --resource-id $CALLBACK_ID --http-method HEAD --authorization-type NONE --region $REGION &gt;/dev/null
aws apigateway put-integration --rest-api-id $API_ID --resource-id $CALLBACK_ID --http-method HEAD --type AWS_PROXY \
  --integration-http-method POST --uri &quot;arn:aws:apigateway:$REGION:lambda:path/2015-03-31/functions/arn:aws:lambda:$REGION:055062860590:function:AuthCallbackFn/invocations&quot; --region $REGION &gt;/dev/null

aws lambda add-permission --function-name AuthStartFn --statement-id AuthStartInvoke --action lambda:InvokeFunction --principal apigateway.amazonaws.com --source-arn &quot;arn:aws:execute-api:$REGION:055062860590:${API_ID}/*/POST/auth/start&quot; --region $REGION 2&gt;/dev/null || true
aws lambda add-permission --function-name AuthCallbackFn --statement-id AuthCallbackInvoke --action lambda:InvokeFunction --principal apigateway.amazonaws.com --source-arn &quot;arn:aws:execute-api:$REGION:055062860590:${API_ID}/*/*/auth/callback&quot; --region $REGION 2&gt;/dev/null || true

aws apigateway create-deployment --rest-api-id $API_ID --stage-name prod --description &quot;Auth routes&quot; --region $REGION &gt;/dev/null
echo &quot;Deployed. POST /auth/start , GET/HEAD /auth/callback&quot;

</code></pre><hr id="260cc947-bd78-8010-beca-d2e2b62b3dbf"/><h2 id="260cc947-bd78-8084-8218-f5c3b1b65c8d" class="">Tests</h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-809b-b106-f647a6a062af" class="code code-wrap"><code class="language-Bash" style="white-space:pre-wrap;word-break:break-all"># 1) Start: Magic-Link senden
curl -s -X POST &quot;https://guf7ho7bze.execute-api.eu-central-1.amazonaws.com/prod/auth/start&quot; \
  -H &quot;Origin: https://matbakh.app&quot; -H &quot;Content-Type: application/json&quot; \
  --data &#x27;{&quot;email&quot;:&quot;you@example.com&quot;,&quot;name&quot;:&quot;You&quot;}&#x27; | jq

# 2) Callback (Token aus E-Mail einsetzen)
curl -i &quot;https://guf7ho7bze.execute-api.eu-central-1.amazonaws.com/prod/auth/callback?t=TOKEN&quot;
# Erwartet: HTTP/2 302 + Set-Cookie: sid=...  → Location: AUTH_APP_REDIRECT

</code></pre><hr id="260cc947-bd78-80fc-91da-f6010cd3cad7"/><h2 id="260cc947-bd78-80dc-b98d-d39c6739abf5" class="">README (Ausschnitt) – <code>README_AUTH.md</code></h2><ul id="260cc947-bd78-801f-a47a-e38de805f83c" class="bulleted-list"><li style="list-style-type:disc">Ziele, Endpunkte, benötigte Secrets, Sicherheitsnotizen (JWT Secret, Cookie SameSite=Lax, HttpOnly).</li></ul><ul id="260cc947-bd78-80ad-8634-fd7e907c07a2" class="bulleted-list"><li style="list-style-type:disc">Monitoring: CloudWatch Logs (Functions), Resend Events (deliver/bounce/spam).</li></ul><hr id="260cc947-bd78-803b-9c97-df2fcb91e6ad"/><h2 id="260cc947-bd78-809d-bbaf-f2f367d8e96b" class="">Commit Message (Vorschlag)</h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="260cc947-bd78-8053-a567-fff27ddb61ed" class="code code-wrap"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">feat(auth): add passwordless auth via AWS (magic link)

- add Lambdas: AuthStartFn (POST /auth/start), AuthCallbackFn (GET/HEAD /auth/callback)
- use pg-client layer + VPC; Secrets from matbakh-email-config
- CDK helper to attach routes to existing PublicApi
- CLI script for non-CDK deploy
- optional SQL to ensure tables exist
</code></pre></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>