# Pre-Commit Hooks Documentation - Cleanup 2\n\n**Version:** 2.0.0 \n**Last Updated:** 2025-01-15 \n**Requirements:** 3.2\n\n## üìã Overview\n\nThe Cleanup 2 pre-commit hooks provide automated legacy reference detection at commit time, preventing new legacy service dependencies from being introduced into the codebase.\n\n## üîß Installation\n\n### Quick Setup\n\n`bash\n# Install Husky integration\nnpx tsx scripts/cleanup-2/husky-integration.ts install\n\n# Verify installation\nnpx tsx scripts/cleanup-2/husky-integration.ts status\n\n# Test hooks\nnpx tsx scripts/cleanup-2/husky-integration.ts test\n`\n\n### Manual Installation\n\n`bash\n# Install Husky (if not already installed)\nnpm install --save-dev husky\n\n# Initialize Husky\nnpx husky init\n\n# Install pre-commit hook\nnpx tsx scripts/cleanup-2/pre-commit-guard.ts install\n`\n\n## üöÄ Usage\n\n### Normal Commits\n\nThe pre-commit hook runs automatically on every commit:\n\n`bash\ngit add .\ngit commit -m \"feat: add new feature\"\n# üîç Running legacy reference check...\n# ‚úÖ COMMIT ALLOWED - No blocking legacy references\n`\n\n### Blocked Commits\n\nWhen legacy references are detected:\n\n`bash\ngit commit -m \"fix: update supabase config\"\n# üîç Running legacy reference check...\n# üö´ COMMIT BLOCKED - Legacy References Detected\n# \n# ‚ùå 2 BLOCKING references found:\n# \n# üìÑ src/config/database.ts:\n#   Line 5: supabase (critical) - import { createClient } from '@supabase/supabase-js'\n#   Line 12: supabase (high) - const supabaseUrl = process.env.SUPABASE_URL\n`\n\n## üö® Emergency Bypass\n\n### Environment Variable\n\n`bash\n# Enable bypass for current session\nexport CLEANUP_BYPASS=true\ngit commit -m \"EMERGENCY: fix critical production issue\"\n\n# Disable bypass\nunset CLEANUP_BYPASS\n`\n\n### Emergency Branches\n\n`bash\n# Create emergency branch (automatically bypasses hooks)\ngit checkout -b emergency/fix-critical-bug\ngit commit -m \"fix: critical production issue\"\n\n# Or hotfix branch\ngit checkout -b hotfix/security-patch\n`\n\n### Emergency Keywords\n\nInclude emergency keywords in commit message:\n\n`bash\ngit commit -m \"EMERGENCY: fix database connection issue\"\ngit commit -m \"CRITICAL: patch security vulnerability\"\ngit commit -m \"HOTFIX: resolve payment processing\"\n`\n\n## ‚öôÔ∏è Configuration\n\n### Husky Configuration\n\nEdit `scripts/cleanup-2/husky-config.json`:\n\n`json\n{\n  \"enabled\": true,\n  \"hooks\": {\n    \"preCommit\": {\n      \"enabled\": true,\n      \"fastScan\": true,\n      \"emergencyBypass\": true,\n      \"timeoutMs\": 30000\n    },\n    \"commitMsg\": {\n      \"enabled\": true,\n      \"validateFormat\": false\n    }\n  },\n  \"exemptions\": {\n    \"branches\": [\"emergency/*\", \"hotfix/*\"],\n    \"users\": [\"ci-bot\", \"github-actions[bot]\"],\n    \"emergencyKeywords\": [\"EMERGENCY\", \"HOTFIX\", \"CRITICAL\"]\n  }\n}\n`\n\n### Pre-Commit Guard Configuration\n\nEdit `scripts/cleanup-2/ci-cd-config.yaml`:\n\n`yaml\npreCommitGuard:\n  enabled: true\n  blocking:\n    critical: true\n    high: true\n    medium: false\n  warnings:\n    medium: true\n    low: false\n  exemptions:\n    files:\n      - \"scripts/cleanup-2/\"\n      - \"docs/\"\n    patterns:\n      - \".*\\.md$\"\n      - \".*test.*\\.ts$\"\n`\n\n## üîç Hook Behavior\n\n### Pre-Commit Hook\n\n1. **Branch Check**: Skips on emergency/hotfix branches\n2. **Environment Check**: Respects `CLEANUP_BYPASS` variable\n3. **Commit Message Check**: Looks for emergency keywords\n4. **Legacy Scan**: Runs fast scan on staged files\n5. **Timeout Protection**: Allows commit if scan takes >30s\n\n### Commit Message Hook\n\n1. **Legacy Warning**: Warns about legacy service mentions\n2. **Format Validation**: Optional conventional commit format\n3. **Merge/Revert Skip**: Bypasses validation for merge commits\n\n## üìä Performance\n\n### Fast Scan Mode\n\n- **Enabled by default** for pre-commit hooks\n- **Scans only staged files** (not entire repository)\n- **Typical scan time**: 1-3 seconds\n- **Timeout protection**: 30 seconds maximum\n\n### Full Scan Mode\n\n`bash\n# Run full repository scan manually\nnpx tsx scripts/cleanup-2/legacy-scanner.ts\n\n# Or via CI/CD Guard Manager\nnpx tsx scripts/cleanup-2/ci-cd-guard-manager.ts check\n`\n\n## üõ†Ô∏è Troubleshooting\n\n### Hook Not Running\n\n`bash\n# Check Husky installation\nnpx husky --version\n\n# Check hook files exist\nls -la .husky/\n\n# Verify hook permissions\nchmod +x .husky/pre-commit\n`\n\n### Hook Failing\n\n`bash\n# Test hook manually\n./.husky/pre-commit\n\n# Check hook logs\nCLEANUP_DEBUG=true ./.husky/pre-commit\n\n# Bypass for debugging\nCLEANUP_BYPASS=true git commit -m \"debug: test commit\"\n`\n\n### Performance Issues\n\n`bash\n# Disable fast scan if causing issues\n# Edit husky-config.json: \"fastScan\": false\n\n# Increase timeout\n# Edit husky-config.json: \"timeoutMs\": 60000\n\n# Check scan performance\ntime npx tsx scripts/cleanup-2/pre-commit-guard.ts check\n`\n\n## üîß Maintenance\n\n### Update Hooks\n\n`bash\n# Reinstall with latest configuration\nnpx tsx scripts/cleanup-2/husky-integration.ts install\n\n# Update configuration only\nnpx tsx scripts/cleanup-2/husky-integration.ts update\n`\n\n### Remove Hooks\n\n`bash\n# Uninstall Cleanup 2 hooks\nnpx tsx scripts/cleanup-2/husky-integration.ts uninstall\n\n# Remove Husky entirely (optional)\nnpm uninstall husky\nrm -rf .husky\n`\n\n## üìù Best Practices\n\n### For Developers\n\n1. **Run scans regularly**: `npm run cleanup:scan`\n2. **Use descriptive commits**: Include context for legacy changes\n3. **Plan cleanup work**: Use `cleanup:` prefix for legacy removal\n4. **Emergency use only**: Don't abuse bypass mechanisms\n\n### For Teams\n\n1. **Document exemptions**: Add reasons for any configuration changes\n2. **Regular reviews**: Check bypass usage and hook effectiveness\n3. **Training**: Ensure team understands emergency procedures\n4. **Monitoring**: Track hook performance and failure rates\n\n## üîó Integration\n\n### CI/CD Pipeline\n\nThe pre-commit hooks integrate with:\n\n- **GitHub Actions**: `cleanup-2-guards.yml` workflow\n- **ESLint Rules**: `no-legacy-services` custom rule\n- **CI/CD Guard Manager**: Comprehensive validation system\n\n### Monitoring\n\n- **Metrics**: Hook execution times and success rates\n- **Alerts**: Bypass usage and hook failures\n- **Reports**: Weekly summary of blocked commits\n\n## üìö Related Documentation\n\n- [CI/CD Guard Manager](./ci-cd-guard-manager.ts)\n- [ESLint Legacy Rules](./eslint-legacy-rules-documentation.md)\n- [GitHub Actions Workflow](../../.github/workflows/cleanup-2-guards.yml)\n- [Legacy Scanner](./legacy-scanner.ts)\n\n---\n\n**Need Help?**\n\n- Run `npx tsx scripts/cleanup-2/husky-integration.ts` for command help\n- Check `scripts/cleanup-2/README.md` for general documentation\n- Review `reports/detection.json` for current legacy references"
